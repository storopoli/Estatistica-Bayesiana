<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Estatística Bayesiana com R e Stan: Markov Chain Monte Carlo -- MCMC</title>

  <meta property="description" itemprop="description" content="O motor por trás da Estatística Bayesiana"/>

  <link rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/"/>

  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2021-08-01"/>
  <meta property="article:created" itemprop="dateCreated" content="2021-08-01"/>
  <meta name="article:author" content="Jose Storopoli"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Estatística Bayesiana com R e Stan: Markov Chain Monte Carlo -- MCMC"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="O motor por trás da Estatística Bayesiana"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:site_name" content="Estatística Bayesiana com R e Stan"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Estatística Bayesiana com R e Stan: Markov Chain Monte Carlo -- MCMC"/>
  <meta property="twitter:description" content="O motor por trás da Estatística Bayesiana"/>

  <!--  https://scholar.google.com/intl/en/scholar/inclusion.html#indexing -->
  <meta name="citation_title" content="Estatística Bayesiana com R e Stan: Markov Chain Monte Carlo -- MCMC"/>
  <meta name="citation_fulltext_html_url" content="https://storopoli.io/Estatistica-Bayesiana/5-MCMC.html"/>
  <meta name="citation_fulltext_world_readable" content=""/>
  <meta name="citation_online_date" content="2021/08/01"/>
  <meta name="citation_publication_date" content="2021/08/01"/>
  <meta name="citation_author" content="Jose Storopoli"/>
  <meta name="citation_author_institution" content="UNINOVE"/>
  <!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=Bayesian Data Analysis;citation_publication_date=2013;citation_publisher=Chapman and Hall/CRC;citation_author=Andrew Gelman;citation_author=John B Carlin;citation_author=Hal S Stern;citation_author=David B Dunson;citation_author=Aki Vehtari;citation_author=Donald B Rubin"/>
  <meta name="citation_reference" content="citation_title=Handbook of Markov Chain Monte Carlo;citation_publication_date=2011;citation_publisher=CRC Press;citation_author=Steve Brooks;citation_author=Andrew Gelman;citation_author=Galin Jones;citation_author=Xiao-Li Meng"/>
  <meta name="citation_reference" content="citation_title=Visualization in Bayesian workflow;citation_publication_date=2019;citation_publisher=Blackwell Publishing Ltd;citation_volume=182;citation_doi=10.1111/rssa.12378;citation_issn=09641998;citation_author=Jonah Gabry;citation_author=Daniel Simpson;citation_author=Aki Vehtari;citation_author=Michael Betancourt;citation_author=Andrew Gelman"/>
  <meta name="citation_reference" content="citation_title=Equation of State Calculations by Fast Computing Machines;citation_publication_date=1953;citation_publisher=American Institute of Physics;citation_volume=21;citation_doi=10.1063/1.1699114;citation_issn=0021-9606;citation_author=Nicholas Metropolis;citation_author=Arianna W. Rosenbluth;citation_author=Marshall N. Rosenbluth;citation_author=Augusta H. Teller;citation_author=Edward Teller"/>
  <meta name="citation_reference" content="citation_title=Monte Carlo sampling methods using Markov chains and their applications;citation_publication_date=1970;citation_volume=57;citation_doi=10.1093/biomet/57.1.97;citation_issn=0006-3444;citation_author=W. K. Hastings"/>
  <meta name="citation_reference" content="citation_title=Weak convergence and optimal scaling of random walk Metropolis algorithms;citation_publication_date=1997;citation_publisher=Institute of Mathematical Statistics;citation_volume=7;citation_doi=10.1214/aoap/1034625254;citation_issn=1050-5164, 2168-8737;citation_author=G. O. Roberts;citation_author=A. Gelman;citation_author=W. R. Gilks"/>
  <meta name="citation_reference" content="citation_title=Basics of Markov Chain Simulation;citation_publication_date=2013;citation_publisher=Chapman and Hall/CRC;citation_author=Andrew Gelman;citation_author=John B Carlin;citation_author=Hal S Stern;citation_author=David B Dunson;citation_author=Aki Vehtari;citation_author=Donald B Rubin"/>
  <meta name="citation_reference" content="citation_title=Stochastic Relaxation, Gibbs Distributions, and the Bayesian Restoration of Images;citation_publication_date=1984;citation_volume=PAMI-6;citation_doi=10.1109/TPAMI.1984.4767596;citation_issn=1939-3539;citation_author=S. Geman;citation_author=D. Geman"/>
  <meta name="citation_reference" content="citation_title=An Improved Acceptance Procedure for the Hybrid Monte Carlo Algorithm;citation_publication_date=1994;citation_volume=111;citation_doi=10.1006/jcph.1994.1054;citation_issn=0021-9991;citation_author=Radford M. Neal"/>
  <meta name="citation_reference" content="citation_title=Hybrid Monte Carlo;citation_publication_date=1987;citation_volume=195;citation_doi=10.1016/0370-2693(87)91197-X;citation_issn=0370-2693;citation_author=Simon Duane;citation_author=A. D. Kennedy;citation_author=Brian J. Pendleton;citation_author=Duncan Roweth"/>
  <meta name="citation_reference" content="citation_title=MCMC using Hamiltonian dynamics;citation_publication_date=2011;citation_author=Radford M Neal"/>
  <meta name="citation_reference" content="citation_title=A Conceptual Introduction to Hamiltonian Monte Carlo;citation_publication_date=2017;citation_author=Michael Betancourt"/>
  <meta name="citation_reference" content="citation_title=The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo;citation_publication_date=2011;citation_volume=15;citation_author=Matthew D Hoffman;citation_author=Andrew Gelman"/>
  <meta name="citation_reference" content="citation_title=The folk theorem of statistical computing;citation_publication_date=2008;citation_author=Andrew Gelman"/>
  <meta name="citation_reference" content="citation_title=Stan Ulam, John von Neumann, and the Monte Carlo Method;citation_publication_date=1987;citation_volume=15;citation_author=Roger Eckhardt"/>
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","citation_url","slug","bibliography","csl"]}},"value":[{"type":"character","attributes":{},"value":["Markov Chain Monte Carlo -- MCMC"]},{"type":"character","attributes":{},"value":["O motor por trás da Estatística Bayesiana"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url","affiliation","affiliation_url","orcid_id"]}},"value":[{"type":"character","attributes":{},"value":["Jose Storopoli"]},{"type":"character","attributes":{},"value":["https://scholar.google.com/citations?user=xGU7H1QAAAAJ&hl=en"]},{"type":"character","attributes":{},"value":["UNINOVE"]},{"type":"character","attributes":{},"value":["https://www.uninove.br"]},{"type":"character","attributes":{},"value":["0000-0002-0559-5176"]}]}]},{"type":"character","attributes":{},"value":["August 1, 2021"]},{"type":"character","attributes":{},"value":["https://storopoli.io/Estatistica-Bayesiana/5-MCMC.html"]},{"type":"character","attributes":{},"value":["storopoli2021mcmcR"]},{"type":"character","attributes":{},"value":["bib/bibliografia.bib"]},{"type":"character","attributes":{},"value":["bib/apa.csl"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  <!--radix_placeholder_navigation_in_header-->
  <meta name="distill:offset" content=""/>

  <script type="application/javascript">

    window.headroom_prevent_pin = false;

    window.document.addEventListener("DOMContentLoaded", function (event) {

      // initialize headroom for banner
      var header = $('header').get(0);
      var headerHeight = header.offsetHeight;
      var headroom = new Headroom(header, {
        tolerance: 5,
        onPin : function() {
          if (window.headroom_prevent_pin) {
            window.headroom_prevent_pin = false;
            headroom.unpin();
          }
        }
      });
      headroom.init();
      if(window.location.hash)
        headroom.unpin();
      $(header).addClass('headroom--transition');

      // offset scroll location for banner on hash change
      // (see: https://github.com/WickyNilliams/headroom.js/issues/38)
      window.addEventListener("hashchange", function(event) {
        window.scrollTo(0, window.pageYOffset - (headerHeight + 25));
      });

      // responsive menu
      $('.distill-site-header').each(function(i, val) {
        var topnav = $(this);
        var toggle = topnav.find('.nav-toggle');
        toggle.on('click', function() {
          topnav.toggleClass('responsive');
        });
      });

      // nav dropdowns
      $('.nav-dropbtn').click(function(e) {
        $(this).next('.nav-dropdown-content').toggleClass('nav-dropdown-active');
        $(this).parent().siblings('.nav-dropdown')
           .children('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $("body").click(function(e){
        $('.nav-dropdown-content').removeClass('nav-dropdown-active');
      });
      $(".nav-dropdown").click(function(e){
        e.stopPropagation();
      });
    });
  </script>

  <style type="text/css">

  /* Theme (user-documented overrideables for nav appearance) */

  .distill-site-nav {
    color: rgba(255, 255, 255, 0.8);
    background-color: #0F2E3D;
    font-size: 15px;
    font-weight: 300;
  }

  .distill-site-nav a {
    color: inherit;
    text-decoration: none;
  }

  .distill-site-nav a:hover {
    color: white;
  }

  @media print {
    .distill-site-nav {
      display: none;
    }
  }

  .distill-site-header {

  }

  .distill-site-footer {

  }


  /* Site Header */

  .distill-site-header {
    width: 100%;
    box-sizing: border-box;
    z-index: 3;
  }

  .distill-site-header .nav-left {
    display: inline-block;
    margin-left: 8px;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header .nav-left {
      margin-left: 0;
    }
  }


  .distill-site-header .nav-right {
    float: right;
    margin-right: 8px;
  }

  .distill-site-header a,
  .distill-site-header .title {
    display: inline-block;
    text-align: center;
    padding: 14px 10px 14px 10px;
  }

  .distill-site-header .title {
    font-size: 18px;
    min-width: 150px;
  }

  .distill-site-header .logo {
    padding: 0;
  }

  .distill-site-header .logo img {
    display: none;
    max-height: 20px;
    width: auto;
    margin-bottom: -4px;
  }

  .distill-site-header .nav-image img {
    max-height: 18px;
    width: auto;
    display: inline-block;
    margin-bottom: -3px;
  }



  @media screen and (min-width: 1000px) {
    .distill-site-header .logo img {
      display: inline-block;
    }
    .distill-site-header .nav-left {
      margin-left: 20px;
    }
    .distill-site-header .nav-right {
      margin-right: 20px;
    }
    .distill-site-header .title {
      padding-left: 12px;
    }
  }


  .distill-site-header .nav-toggle {
    display: none;
  }

  .nav-dropdown {
    display: inline-block;
    position: relative;
  }

  .nav-dropdown .nav-dropbtn {
    border: none;
    outline: none;
    color: rgba(255, 255, 255, 0.8);
    padding: 16px 10px;
    background-color: transparent;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    margin: 0;
    margin-top: 1px;
    z-index: 2;
  }

  .nav-dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    min-width: 200px;
    border: 1px solid rgba(0,0,0,0.15);
    border-radius: 4px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
    z-index: 1;
    margin-top: 2px;
    white-space: nowrap;
    padding-top: 4px;
    padding-bottom: 4px;
  }

  .nav-dropdown-content hr {
    margin-top: 4px;
    margin-bottom: 4px;
    border: none;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown-active {
    display: block;
  }

  .nav-dropdown-content a, .nav-dropdown-content .nav-dropdown-header {
    color: black;
    padding: 6px 24px;
    text-decoration: none;
    display: block;
    text-align: left;
  }

  .nav-dropdown-content .nav-dropdown-header {
    display: block;
    padding: 5px 24px;
    padding-bottom: 0;
    text-transform: uppercase;
    font-size: 14px;
    color: #999999;
    white-space: nowrap;
  }

  .nav-dropdown:hover .nav-dropbtn {
    color: white;
  }

  .nav-dropdown-content a:hover {
    background-color: #ddd;
    color: black;
  }

  .nav-right .nav-dropdown-content {
    margin-left: -45%;
    right: 0;
  }

  @media screen and (max-width: 768px) {
    .distill-site-header a, .distill-site-header .nav-dropdown  {display: none;}
    .distill-site-header a.nav-toggle {
      float: right;
      display: block;
    }
    .distill-site-header .title {
      margin-left: 0;
    }
    .distill-site-header .nav-right {
      margin-right: 0;
    }
    .distill-site-header {
      overflow: hidden;
    }
    .nav-right .nav-dropdown-content {
      margin-left: 0;
    }
  }


  @media screen and (max-width: 768px) {
    .distill-site-header.responsive {position: relative; min-height: 500px; }
    .distill-site-header.responsive a.nav-toggle {
      position: absolute;
      right: 0;
      top: 0;
    }
    .distill-site-header.responsive a,
    .distill-site-header.responsive .nav-dropdown {
      display: block;
      text-align: left;
    }
    .distill-site-header.responsive .nav-left,
    .distill-site-header.responsive .nav-right {
      width: 100%;
    }
    .distill-site-header.responsive .nav-dropdown {float: none;}
    .distill-site-header.responsive .nav-dropdown-content {position: relative;}
    .distill-site-header.responsive .nav-dropdown .nav-dropbtn {
      display: block;
      width: 100%;
      text-align: left;
    }
  }

  /* Site Footer */

  .distill-site-footer {
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
    z-index: 3;
    margin-top: 30px;
    padding-top: 30px;
    padding-bottom: 30px;
    text-align: center;
  }

  /* Headroom */

  d-title {
    padding-top: 6rem;
  }

  @media print {
    d-title {
      padding-top: 4rem;
    }
  }

  .headroom {
    z-index: 1000;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .headroom--transition {
    transition: all .4s ease-in-out;
  }

  .headroom--unpinned {
    top: -100px;
  }

  .headroom--pinned {
    top: 0;
  }

  /* adjust viewport for navbar height */
  /* helps vertically center bootstrap (non-distill) content */
  .min-vh-100 {
    min-height: calc(100vh - 100px) !important;
  }

  </style>

  <script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
  <link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet"/>
  <link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet"/>
  <script src="site_libs/headroom-0.9.4/headroom.min.js"></script>
  <script src="site_libs/autocomplete-0.37.1/autocomplete.min.js"></script>
  <script src="site_libs/fuse-6.4.1/fuse.min.js"></script>

  <script type="application/javascript">

  function getMeta(metaName) {
    var metas = document.getElementsByTagName('meta');
    for (let i = 0; i < metas.length; i++) {
      if (metas[i].getAttribute('name') === metaName) {
        return metas[i].getAttribute('content');
      }
    }
    return '';
  }

  function offsetURL(url) {
    var offset = getMeta('distill:offset');
    return offset ? offset + '/' + url : url;
  }

  function createFuseIndex() {

    // create fuse index
    var options = {
      keys: [
        { name: 'title', weight: 20 },
        { name: 'categories', weight: 15 },
        { name: 'description', weight: 10 },
        { name: 'contents', weight: 5 },
      ],
      ignoreLocation: true,
      threshold: 0
    };
    var fuse = new window.Fuse([], options);

    // fetch the main search.json
    return fetch(offsetURL('search.json'))
      .then(function(response) {
        if (response.status == 200) {
          return response.json().then(function(json) {
            // index main articles
            json.articles.forEach(function(article) {
              fuse.add(article);
            });
            // download collections and index their articles
            return Promise.all(json.collections.map(function(collection) {
              return fetch(offsetURL(collection)).then(function(response) {
                if (response.status === 200) {
                  return response.json().then(function(articles) {
                    articles.forEach(function(article) {
                      fuse.add(article);
                    });
                  })
                } else {
                  return Promise.reject(
                    new Error('Unexpected status from search index request: ' +
                              response.status)
                  );
                }
              });
            })).then(function() {
              return fuse;
            });
          });

        } else {
          return Promise.reject(
            new Error('Unexpected status from search index request: ' +
                        response.status)
          );
        }
      });
  }

  window.document.addEventListener("DOMContentLoaded", function (event) {

    // get search element (bail if we don't have one)
    var searchEl = window.document.getElementById('distill-search');
    if (!searchEl)
      return;

    createFuseIndex()
      .then(function(fuse) {

        // make search box visible
        searchEl.classList.remove('hidden');

        // initialize autocomplete
        var options = {
          autoselect: true,
          hint: false,
          minLength: 2,
        };
        window.autocomplete(searchEl, options, [{
          source: function(query, callback) {
            const searchOptions = {
              isCaseSensitive: false,
              shouldSort: true,
              minMatchCharLength: 2,
              limit: 10,
            };
            var results = fuse.search(query, searchOptions);
            callback(results
              .map(function(result) { return result.item; })
            );
          },
          templates: {
            suggestion: function(suggestion) {
              var img = suggestion.preview && Object.keys(suggestion.preview).length > 0
                ? `<img src="${offsetURL(suggestion.preview)}"</img>`
                : '';
              var html = `
                <div class="search-item">
                  <h3>${suggestion.title}</h3>
                  <div class="search-item-description">
                    ${suggestion.description || ''}
                  </div>
                  <div class="search-item-preview">
                    ${img}
                  </div>
                </div>
              `;
              return html;
            }
          }
        }]).on('autocomplete:selected', function(event, suggestion) {
          window.location.href = offsetURL(suggestion.path);
        });
        // remove inline display style on autocompleter (we want to
        // manage responsive display via css)
        $('.algolia-autocomplete').css("display", "");
      })
      .catch(function(error) {
        console.log(error);
      });

  });

  </script>

  <style type="text/css">

  .nav-search {
    font-size: x-small;
  }

  /* Algolioa Autocomplete */

  .algolia-autocomplete {
    display: inline-block;
    margin-left: 10px;
    vertical-align: sub;
    background-color: white;
    color: black;
    padding: 6px;
    padding-top: 8px;
    padding-bottom: 0;
    border-radius: 6px;
    border: 1px #0F2E3D solid;
    width: 180px;
  }


  @media screen and (max-width: 768px) {
    .distill-site-nav .algolia-autocomplete {
      display: none;
      visibility: hidden;
    }
    .distill-site-nav.responsive .algolia-autocomplete {
      display: inline-block;
      visibility: visible;
    }
    .distill-site-nav.responsive .algolia-autocomplete .aa-dropdown-menu {
      margin-left: 0;
      width: 400px;
      max-height: 400px;
    }
  }

  .algolia-autocomplete .aa-input, .algolia-autocomplete .aa-hint {
    width: 90%;
    outline: none;
    border: none;
  }

  .algolia-autocomplete .aa-hint {
    color: #999;
  }
  .algolia-autocomplete .aa-dropdown-menu {
    width: 550px;
    max-height: 70vh;
    overflow-x: visible;
    overflow-y: scroll;
    padding: 5px;
    margin-top: 3px;
    margin-left: -150px;
    background-color: #fff;
    border-radius: 5px;
    border: 1px solid #999;
    border-top: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion {
    cursor: pointer;
    padding: 5px 4px;
    border-bottom: 1px solid #eee;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion:last-of-type {
    border-bottom: none;
    margin-bottom: 2px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item {
    overflow: hidden;
    font-size: 0.8em;
    line-height: 1.4em;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item h3 {
    font-size: 1rem;
    margin-block-start: 0;
    margin-block-end: 5px;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-description {
    display: inline-block;
    overflow: hidden;
    height: 2.8em;
    width: 80%;
    margin-right: 4%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview {
    display: inline-block;
    width: 15%;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img {
    height: 3em;
    width: auto;
    display: none;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion .search-item-preview img[src] {
    display: initial;
  }

  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion.aa-cursor {
    background-color: #eee;
  }
  .algolia-autocomplete .aa-dropdown-menu .aa-suggestion em {
    font-weight: bold;
    font-style: normal;
  }

  </style>


  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure img {
    width: 100%;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        var refHtml = $('#ref-' + $(this).attr('data-cites')).html();
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace("index.html", "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <style type="text/css">
  /* base variables */

  /* Edit the CSS properties in this file to create a custom
     Distill theme. Only edit values in the right column
     for each row; values shown are the CSS defaults.
     To return any property to the default,
     you may set its value to: unset
     All rows must end with a semi-colon.                      */

  /* Optional: embed custom fonts here with `@import`          */
  /* This must remain at the top of this file.                 */



  html {
    /*-- Main font sizes --*/
    --title-size:      50px;
    --body-size:       1.06rem;
    --code-size:       14px;
    --aside-size:      12px;
    --fig-cap-size:    13px;
    /*-- Main font colors --*/
    --title-color:     #000000;
    --header-color:    rgba(0, 0, 0, 0.8);
    --body-color:      rgba(0, 0, 0, 0.8);
    --aside-color:     rgba(0, 0, 0, 0.6);
    --fig-cap-color:   rgba(0, 0, 0, 0.6);
    /*-- Specify custom fonts ~~~ must be imported above   --*/
    --heading-font:    sans-serif;
    --mono-font:       monospace;
    --body-font:       sans-serif;
    --navbar-font:     sans-serif;  /* websites + blogs only */
  }

  /*-- ARTICLE METADATA --*/
  d-byline {
    --heading-size:    0.6rem;
    --heading-color:   rgba(0, 0, 0, 0.5);
    --body-size:       0.8rem;
    --body-color:      rgba(0, 0, 0, 0.8);
  }

  /*-- ARTICLE TABLE OF CONTENTS --*/
  .d-contents {
    --heading-size:    18px;
    --contents-size:   13px;
  }

  /*-- ARTICLE APPENDIX --*/
  d-appendix {
    --heading-size:    15px;
    --heading-color:   rgba(0, 0, 0, 0.65);
    --text-size:       0.8em;
    --text-color:      rgba(0, 0, 0, 0.5);
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  /* These properties only apply to Distill sites and blogs  */

  .distill-site-header {
    --title-size:       18px;
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  .distill-site-footer {
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  /*-- Additional custom styles --*/
  /* Add any additional CSS rules below                      */
  </style>
  <style type="text/css">
  /* base variables */

  /* Edit the CSS properties in this file to create a custom
     Distill theme. Only edit values in the right column
     for each row; values shown are the CSS defaults.
     To return any property to the default,
     you may set its value to: unset
     All rows must end with a semi-colon.                      */

  /* Optional: embed custom fonts here with `@import`          */
  /* This must remain at the top of this file.                 */



  html {
    /*-- Main font sizes --*/
    --title-size:      50px;
    --body-size:       1.06rem;
    --code-size:       14px;
    --aside-size:      12px;
    --fig-cap-size:    13px;
    /*-- Main font colors --*/
    --title-color:     #000000;
    --header-color:    rgba(0, 0, 0, 0.8);
    --body-color:      rgba(0, 0, 0, 0.8);
    --aside-color:     rgba(0, 0, 0, 0.6);
    --fig-cap-color:   rgba(0, 0, 0, 0.6);
    /*-- Specify custom fonts ~~~ must be imported above   --*/
    --heading-font:    sans-serif;
    --mono-font:       monospace;
    --body-font:       sans-serif;
    --navbar-font:     sans-serif;  /* websites + blogs only */
  }

  /*-- ARTICLE METADATA --*/
  d-byline {
    --heading-size:    0.6rem;
    --heading-color:   rgba(0, 0, 0, 0.5);
    --body-size:       0.8rem;
    --body-color:      rgba(0, 0, 0, 0.8);
  }

  /*-- ARTICLE TABLE OF CONTENTS --*/
  .d-contents {
    --heading-size:    18px;
    --contents-size:   13px;
  }

  /*-- ARTICLE APPENDIX --*/
  d-appendix {
    --heading-size:    15px;
    --heading-color:   rgba(0, 0, 0, 0.65);
    --text-size:       0.8em;
    --text-color:      rgba(0, 0, 0, 0.5);
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  /* These properties only apply to Distill sites and blogs  */

  .distill-site-header {
    --title-size:       18px;
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  .distill-site-footer {
    --text-color:       rgba(255, 255, 255, 0.8);
    --text-size:        15px;
    --hover-color:      white;
    --bkgd-color:       #0F2E3D;
  }

  /*-- Additional custom styles --*/
  /* Add any additional CSS rules below                      */
  @import url('https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css')</style>
  <style type="text/css">
  /* base style */

  /* FONT FAMILIES */

  :root {
    --heading-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    --mono-default: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    --body-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  body,
  .posts-list .post-preview p,
  .posts-list .description p {
    font-family: var(--body-font), var(--body-default);
  }

  h1, h2, h3, h4, h5, h6,
  .posts-list .post-preview h2,
  .posts-list .description h2 {
    font-family: var(--heading-font), var(--heading-default);
  }

  d-article div.sourceCode code,
  d-article pre code {
    font-family: var(--mono-font), var(--mono-default);
  }


  /*-- TITLE --*/
  d-title h1,
  .posts-list > h1 {
    color: var(--title-color, black);
  }

  d-title h1 {
    font-size: var(--title-size, 50px);
  }

  /*-- HEADERS --*/
  d-article h1,
  d-article h2,
  d-article h3,
  d-article h4,
  d-article h5,
  d-article h6 {
    color: var(--header-color, rgba(0, 0, 0, 0.8));
  }

  /*-- BODY --*/
  d-article > p,  /* only text inside of <p> tags */
  d-article > ul, /* lists */
  d-article > ol {
    color: var(--body-color, rgba(0, 0, 0, 0.8));
    font-size: var(--body-size, 1.06rem);
  }


  /*-- CODE --*/
  d-article div.sourceCode code,
  d-article pre code {
    font-size: var(--code-size, 14px);
  }

  /*-- ASIDE --*/
  d-article aside {
    font-size: var(--aside-size, 12px);
    color: var(--aside-color, rgba(0, 0, 0, 0.6));
  }

  /*-- FIGURE CAPTIONS --*/
  figure .caption,
  figure figcaption,
  .figure .caption {
    font-size: var(--fig-cap-size, 13px);
    color: var(--fig-cap-color, rgba(0, 0, 0, 0.6));
  }

  /*-- METADATA --*/
  d-byline h3 {
    font-size: var(--heading-size, 0.6rem);
    color: var(--heading-color, rgba(0, 0, 0, 0.5));
  }

  d-byline {
    font-size: var(--body-size, 0.8rem);
    color: var(--body-color, rgba(0, 0, 0, 0.8));
  }

  d-byline a,
  d-article d-byline a {
    color: var(--body-color, rgba(0, 0, 0, 0.8));
  }

  /*-- TABLE OF CONTENTS --*/
  .d-contents nav h3 {
    font-size: var(--heading-size, 18px);
  }

  .d-contents nav a {
    font-size: var(--contents-size, 13px);
  }

  /*-- APPENDIX --*/
  d-appendix h3 {
    font-size: var(--heading-size, 15px);
    color: var(--heading-color, rgba(0, 0, 0, 0.65));
  }

  d-appendix {
    font-size: var(--text-size, 0.8em);
    color: var(--text-color, rgba(0, 0, 0, 0.5));
  }

  d-appendix d-footnote-list a.footnote-backlink {
    color: var(--text-color, rgba(0, 0, 0, 0.5));
  }

  /*-- WEBSITE HEADER + FOOTER --*/
  .distill-site-header .title {
    font-size: var(--title-size, 18px);
    font-family: var(--navbar-font), var(--heading-default);
  }

  .distill-site-header a,
  .nav-dropdown .nav-dropbtn {
    font-family: var(--navbar-font), var(--heading-default);
  }

  .nav-dropdown .nav-dropbtn {
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    font-size: var(--text-size, 15px);
  }

  .distill-site-header a:hover,
  .nav-dropdown:hover .nav-dropbtn {
    color: var(--hover-color, white);
  }

  .distill-site-header {
    font-size: var(--text-size, 15px);
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    background-color: var(--bkgd-color, #0F2E3D);
  }

  .distill-site-footer {
    font-size: var(--text-size, 15px);
    color: var(--text-color, rgba(255, 255, 255, 0.8));
    background-color: var(--bkgd-color, #0F2E3D);
  }

  .distill-site-footer a:hover {
    color: var(--hover-color, white);
  }</style>
  <!--/radix_placeholder_distill-->
  <script src="site_libs/header-attrs-2.7/header-attrs.js"></script>
  <script src="site_libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
  <script src="site_libs/plotly-binding-4.9.3/plotly.js"></script>
  <script src="site_libs/typedarray-0.1/typedarray.min.js"></script>
  <script src="site_libs/jquery-3.5.1/jquery.min.js"></script>
  <link href="site_libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
  <script src="site_libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>
  <link href="site_libs/plotly-htmlwidgets-css-1.57.1/plotly-htmlwidgets.css" rel="stylesheet" />
  <script src="site_libs/plotly-main-1.57.1/plotly-latest.min.js"></script>
  <script src="site_libs/popper-2.6.0/popper.min.js"></script>
  <link href="site_libs/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="site_libs/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="site_libs/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="site_libs/anchor-4.2.2/anchor.min.js"></script>
  <script src="site_libs/bowser-1.9.3/bowser.min.js"></script>
  <script src="site_libs/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="site_libs/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <script type="text/javascript" cookie-consent="tracking" async src="https://www.googletagmanager.com/gtag/js?id=G-K886N00L87"></script>
  <script type="text/javascript" cookie-consent="tracking">
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-K886N00L87');
  </script>
  <!--/radix_placeholder_site_in_header-->


</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Markov Chain Monte Carlo -- MCMC","description":"O motor por trás da Estatística Bayesiana","authors":[{"author":"Jose Storopoli","authorURL":"https://scholar.google.com/citations?user=xGU7H1QAAAAJ&hl=en","affiliation":"UNINOVE","affiliationURL":"https://www.uninove.br","orcidID":"0000-0002-0559-5176"}],"publishedDate":"2021-08-01T00:00:00.000+00:00","citationText":"Storopoli, 2021"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<header class="header header--fixed" role="banner">
<nav class="distill-site-nav distill-site-header">
<div class="nav-left">
<a class="logo" href="https://www.uninove.br">
<img src="images/uninove.png" alt="Logo"/>
</a>
<a href="index.html" class="title">Estatística Bayesiana com R e Stan</a>
<a href="0-Estatistica-Bayesiana.html">O que é Estatística Bayesiana?</a>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Tutoriais
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="1-Comandos_Basicos.html">1. Comandos Básicos de R</a>
<a href="2-Distribuicoes_Estatisticas.html">2. Distribuições Estatísticas</a>
<a href="3-rstanarm.html">3. rstanarm e brms</a>
<a href="4-Priors.html">4. Priors</a>
<a href="5-MCMC.html">5. Markov Chain Montecarlo (MCMC)</a>
<a href="6-Regressao_Linear.html">6. Regressão Linear</a>
<a href="7-Regressao_Logistica.html">7. Regressão Logistica</a>
<a href="8-Regressao_Poisson.html">8. Regressão de Poisson</a>
<a href="9-Regressao_Robusta.html">9. Regressão Robusta</a>
<a href="10-Regressao_Multinivel.html">10. Modelos Multiníveis</a>
</div>
</div>
<div class="nav-dropdown">
<button class="nav-dropbtn">
Conteúdos Auxiliares
 
<span class="down-arrow">&#x25BE;</span>
</button>
<div class="nav-dropdown-content">
<a href="aux-Model_Comparison.html">Comparação de Modelos</a>
<a href="aux-Dados_Faltantes.html">Dados Faltantes</a>
<a href="aux-Regressao_Coeficientes.html">Coeficientes de uma Regressão</a>
<a href="aux-Tabelas_para_Publicacao.html">Tabelas para Publicação</a>
</div>
</div>
<input id="distill-search" class="nav-search hidden" type="text" placeholder="Search..."/>
</div>
<div class="nav-right">
<a href="https://scholar.google.com/citations?user=xGU7H1QAAAAJ&amp;hl=en">
<i class="fa ai ai-google-scholar ai-lg" aria-hidden="true"></i>
</a>
<a href="https://orcid.org/0000-0002-0559-5176">
<i class="fa ai ai-orcid ai-lg" aria-hidden="true"></i>
</a>
<a href="http://lattes.cnpq.br/2281909649311607">
<i class="fa ai ai-lattes ai-lg" aria-hidden="true"></i>
</a>
<a href="https://github.com/storopoli/Estatistica-Bayesiana" aria-label="Link to source">
<i class="fab fa-github" aria-hidden="true"></i>
</a>
<a href="javascript:void(0);" class="nav-toggle">&#9776;</a>
</div>
</nav>
</header>
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Markov Chain Monte Carlo – MCMC</h1>
<!--radix_placeholder_categories-->
<!--/radix_placeholder_categories-->
<p>O motor por trás da Estatística Bayesiana</p>
</div>

<div class="d-byline">
  Jose Storopoli <a href="https://scholar.google.com/citations?user=xGU7H1QAAAAJ&amp;hl=en" class="uri">https://scholar.google.com/citations?user=xGU7H1QAAAAJ&amp;hl=en</a> (UNINOVE)<a href="https://www.uninove.br" class="uri">https://www.uninove.br</a>
  
<br/>August 1, 2021
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#para-quê-serve-o-denominador-ptextdata">Para quê serve o denominador <span class="math inline">\(P(\text{data})\)</span>?</a></li>
<li><a href="#se-removermos-o-denominador-de-bayes-o-que-temos">Se removermos o denominador de Bayes o que temos?</a></li>
<li><a href="#simulação-montecarlo-com-correntes-markov-mcmc">Simulação Montecarlo com correntes Markov – (MCMC)</a>
<ul>
<li><a href="#método-monte-carlo">Método Monte Carlo</a></li>
<li><a href="#simulações-setup">Simulações – Setup</a></li>
<li><a href="#metropolis-e-metropolis-hastings">Metropolis e Metropolis-Hastings</a></li>
<li><a href="#gibbs">Gibbs</a></li>
<li><a href="#o-que-acontece-quando-rodamos-correntes-markov-em-paralelo">O que acontece quando rodamos correntes Markov em paralelo?</a></li>
</ul></li>
<li><a href="#hamiltonian-monte-carlo-hmc">Hamiltonian Monte Carlo – HMC</a>
<ul>
<li><a href="#distribuição-dos-momentos-pphi">Distribuição dos Momentos – <span class="math inline">\(P(\phi)\)</span></a></li>
<li><a href="#algoritmo-de-hmc">Algoritmo de HMC</a></li>
<li><a href="#hmc-implementação">HMC – Implementação</a></li>
<li><a href="#hmc-geometrias-complexas">HMC – Geometrias Complexas</a></li>
</ul></li>
<li><a href="#não-entendi-nada">“Não entendi nada…”</a></li>
<li><a href="#implementação-com-o-rstanarm">Implementação com o <code>rstanarm</code></a>
<ul>
<li><a href="#métricas-da-simulação-mcmc">Métricas da simulação MCMC</a></li>
<li><a href="#o-que-fazer-se-não-obtermos-convergência">O que fazer se não obtermos convergência?</a></li>
</ul></li>
<li><a href="#gráficos-de-diagnósticos-do-mcmc">Gráficos de Diagnósticos do MCMC</a>
<ul>
<li><a href="#traceplot"><em>Traceplot</em></a></li>
<li><a href="#posterior-predictive-check"><em>Posterior Predictive Check</em></a></li>
</ul></li>
<li><a href="#o-quê-fazer-para-convergir-suas-correntes-markov">O quê fazer para convergir suas correntes Markov</a></li>
<li><a href="#ambiente">Ambiente</a></li>
</ul>
</nav>
</div>
<p><link rel="stylesheet" href="https://cdn.rawgit.com/jpswalsh/academicons/master/css/academicons.min.css"/></p>
<p>A principal barreira computacional para estatística Bayesiana é o denominador <span class="math inline">\(P(\text{data})\)</span> da fórmula de Bayes:</p>
<p><span class="math display">\[P(\theta | \text{data})=\frac{P(\theta) \cdot P(\text{data} | \theta)}{P(\text{data})}\]</span></p>
<p>Em casos discretos podemos fazer o denominador virar a soma de todos os parâmetros usando a regra da cadeia de probabilidade:</p>
<p><span class="math display">\[P(A,B|C)=P(A|B,C) \times P(B|C)\]</span></p>
<p>Isto também é chamado de marginalização:</p>
<p><span class="math display">\[P(\text{data})=\sum_{\theta} P(\text{data} | \theta) \times P(\theta)\]</span></p>
<p>Porém no caso de valores contínuos o denominador <span class="math inline">\(P(\text{data})\)</span> vira uma integral bem grande e complicada de calcular:</p>
<p><span class="math display">\[P(\text{data})=\int_{\theta} P(\text{data} | \theta) \times P(\theta)d \theta\]</span></p>
<p>Em muitos casos essa integral vira <em>intratável</em> (incalculável) e portanto devemos achar outras maneiras de calcular a probabilidade posterior <span class="math inline">\(P(\theta | \text{data})\)</span> de Bayes sem usar o denominador <span class="math inline">\(P(\text{data})\)</span>.</p>
<h2 id="para-quê-serve-o-denominador-ptextdata">Para quê serve o denominador <span class="math inline">\(P(\text{data})\)</span>?</h2>
<p>Para normalizar a posterior com o intuito de torná-la uma distribuição probabilística válida. Isto quer dizer que a soma de todas as probabilidades dos eventos possíveis da distribuição probabilística devem ser iguais a 1:</p>
<ul>
<li>no caso de distribuição probabilística discreta: <span class="math inline">\(\sum_{\theta} P(\theta | \text{data}) = 1\)</span></li>
<li>no caso de distribuição probabilística contínua: <span class="math inline">\(\int_{\theta} P(\theta | \text{data})d \theta = 1\)</span></li>
</ul>
<h2 id="se-removermos-o-denominador-de-bayes-o-que-temos">Se removermos o denominador de Bayes o que temos?</h2>
<p>Ao removermos o denominador <span class="math inline">\((\text{data})\)</span> temos que a posterior <span class="math inline">\(P(\theta | \text{data})\)</span> é <strong>proporcional</strong> à prior multiplicada pela verossimilhança <span class="math inline">\(P(\theta) \cdot P(\text{data} | \theta)\)</span><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>.</p>
<p><span class="math display">\[P(\theta | \text{data}) \propto P(\theta) \cdot P(\text{data} | \theta)\]</span></p>
<p>Este <a href="https://youtu.be/8FbqSVFzmoY">vídeo do YouTube</a> explica muito bem o problema do denominador.</p>
<div class="resp-container">
<iframe class="testiframe" width="560" height="315" src="https://www.youtube.com/embed/8FbqSVFzmoY" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
Please use a browser that supports iframe embedding. If you are seeing this message Google “browser iframe embedding not rendering.”
</iframe>
</div>
<h2 id="simulação-montecarlo-com-correntes-markov-mcmc">Simulação Montecarlo com correntes Markov – (MCMC)</h2>
<p>Aí que entra simulação Montecarlo com correntes Markov (do inglês <em>Markov Chain Monte Carlo</em> – MCMC). MCMC é uma classe ampla de ferramentas computacionais para aproximação de integrais e geração de amostras de uma probabilidade posterior <span class="citation" data-cites="brooksHandbookMarkovChain2011">(<a href="#ref-brooksHandbookMarkovChain2011" role="doc-biblioref">S. Brooks, Gelman, Jones, &amp; Meng, 2011</a>)</span>. MCMC é usada quando não é possível coletar amostras de <span class="math inline">\(\theta\)</span> direto da distribuição probabilística posterior <span class="math inline">\(P(\theta | \text{data})\)</span>. Ao invés disso, nos coletamos amostras de maneira iterativa que a cada passo do processo nós esperamos que a distribuição da qual amostramos <span class="math inline">\(P^*(\theta^* | \text{data})\)</span> (aqui <span class="math inline">\(*\)</span> quer dizer simulado) se torna cada vez mais similar à posterior <span class="math inline">\(P(\theta | \text{data})\)</span>. Tudo isso é para eliminar o cálculo (muitas vezes impossível) do denominador <span class="math inline">\(P(\text{data})\)</span>.</p>
<p>A ideia é definir uma corrente Markov ergódica (quer dizer que há uma distribuição estacionária única) dos quais o conjunto de estados possíveis é o espaço amostral e a distribuição estacionária é a distribuição a ser aproximada (ou amostrada). Seja <span class="math inline">\(X_0, X_1, \dots, X_n\)</span> uma simulação da corrente. A corrente Markov converge à distribuição estacionária de qualquer estado inicial <span class="math inline">\(X_0\)</span> após um número suficiente grande de iterações <span class="math inline">\(r\)</span>, a distribuição do estado <span class="math inline">\(X_r\)</span> estará similar à distribuição estacionária, então podemos usá-la com amostra. As correntes Markov possuem uma propriedade que a distribuição de probabilidade do próximo estado depende apenas do estado atual e não na sequência de eventos que precederam: <span class="math inline">\(P(X_{n+1}=x|X_{0},X_{1},X_{2},\ldots ,X_{n}) = P(X_{n+1}=x|X_{n})\)</span>. Essa propriedade é chamada de Markoviana, em homenagem ao matemático <a href="https://pt.wikipedia.org/wiki/Andrei_Andreyevich_Markov" title="Andrei Andreyevich Markov">Andrei Andreyevich Markov</a> (figura <a href="#fig:markov">1</a>). Similarmente, repetindo esse argumento com <span class="math inline">\(X_r\)</span> como o ponto inicial, podemos usar <span class="math inline">\(X_{2r}\)</span> como amostra, e assim por diante. Podemos então usar a sequência de estados <span class="math inline">\(X_r, X_{2r}, X_{3r}, \dots\)</span> como quase amostras independentes da distribuição estacionária da corrente Markov.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span id="fig:markov"></span>
<img src="images/andrei_markov.jpg" alt="Andrei Andreyevich Markov. Figura de https://www.wikipedia.org" width="185" class=external />
<p class="caption">
Figure 1: Andrei Andreyevich Markov. Figura de <a href="https://www.wikipedia.org" class="uri">https://www.wikipedia.org</a>
</p>
</div>
</div>
<p>A eficácia dessa abordagem depende em:</p>
<ol type="1">
<li><p>o quão grande <span class="math inline">\(r\)</span> deve ser para garantir uma amostra adequadamente boa; e</p></li>
<li><p>poder computacional requerido para cada iteração da corrente Markov.</p></li>
</ol>
<p>Além disso, é costumeiro descartarmos as primeiras iterações do algoritmo pois elas costumam não ser representativas da distribuição a ser aproximada. Nas iterações iniciais de algoritmos MCMC geralmente a corrente Markov está em um processo de aquecimento<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> (<em>warm-up</em>) e seu estado está bem distante do ideal para começarmos uma amostragem fidedigna. Geralmente, recomenda-se que se descarte metade das iterações <span class="citation" data-cites="gelmanBasicsMarkovChain2013">(<a href="#ref-gelmanBasicsMarkovChain2013" role="doc-biblioref">Gelman et al., 2013a</a>)</span>. Por exemplo: se a corrente Markov possui 4.000 iterações, descartamos as 2.000 primeiras como <em>warm-up</em>.</p>
<h3 id="método-monte-carlo">Método Monte Carlo</h3>
<p>Stanislaw Ulam (figura <a href="#fig:stanislaw">2</a>), que participou do projeto Manhattan e ao tentar calcular o processo de difusão de neutrons para a bomba de hidrogênio acabou criando uma classe de métodos chamada <strong><em>Monte Carlo</em></strong>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span id="fig:stanislaw"></span>
<img src="images/stanislaw.jpg" alt="Stanislaw Ulam. Figura de https://www.wikipedia.org" width="732" class=external />
<p class="caption">
Figure 2: Stanislaw Ulam. Figura de <a href="https://www.wikipedia.org" class="uri">https://www.wikipedia.org</a>
</p>
</div>
</div>
<p>Métodos de Monte Carlo possuem como conceito subjacente o uso a aleatoriedade para resolver problemas que podem ser determinísticos em princípio. Eles são freqüentemente usados em problemas físicos e matemáticos e são mais úteis quando é difícil ou impossível usar outras abordagens. Os métodos de Monte Carlo são usados principalmente em três classes de problemas: otimização, integração numérica e geração de sorteios a partir de uma distribuição de probabilidade.</p>
<p>A ideia do método veio enquanto jogava paciência durante sua recuperação de uma cirurgia, Ulam pensou em jogar centenas de jogos para estimar estatisticamente a probabilidade de um resultado bem-sucedido. Conforme ele mesmo menciona em <span class="citation" data-cites="eckhardtStanUlamJohn1987"><a href="#ref-eckhardtStanUlamJohn1987" role="doc-biblioref">Eckhardt</a> (<a href="#ref-eckhardtStanUlamJohn1987" role="doc-biblioref">1987</a>)</span>:</p>
<blockquote>
<p>Os primeiros pensamentos e tentativas que fiz para praticar [o Método de Monte Carlo] foram sugeridos por uma pergunta que me ocorreu em 1946 quando eu estava convalescendo de uma doença e jogando paciência. A questão era quais são as chances de que um jogo de paciência com 52 cartas obtivesse sucesso? Depois de passar muito tempo tentando estimá-los por meio de cálculos combinatórios puros, me perguntei se um método mais prático do que o “pensamento abstrato” não seria expô-lo, digamos, cem vezes e simplesmente observar e contar o número de jogadas bem-sucedidas. Isso já era possível imaginar com o início da nova era de computadores rápidos, e eu imediatamente pensei em problemas de difusão de nêutrons e outras questões de física matemática e, de forma mais geral, como mudar os processos descritos por certas equações diferenciais em uma forma equivalente interpretável como uma sucessão de operações aleatórias. Mais tarde [em 1946], descrevi a ideia para John von Neumann e começamos a planejar cálculos reais.</p>
</blockquote>
<p>Por ser secreto, o trabalho de von Neumann e Ulam exigia um codinome. Um colega de von Neumann e Ulam, Nicholas Metropolis (figura <a href="#fig:metropolis-hastings">5</a>), sugeriu usar o nome Monte Carlo, que se refere ao Casino Monte Carlo em Mônaco, onde o tio de Ulam (Michał Ulam) pedia dinheiro emprestado a parentes para jogar.</p>
<p>As <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method#Applications">aplicações do método de Monte Carlo</a> são inúmeras: ciências físicas, engenharia, mudança climática, biologia computacional, computação gráfica, estatística aplicada, inteligência artificial, design e recursos visuais, busca e resgate, finanças e negócios e direito. No escopo desta aula focaremos em estatística aplicada e especificamente no contexto de inferência Bayesiana: fornecer uma amostra aleatória da distribuição posterior.</p>
<h3 id="simulações-setup">Simulações – Setup</h3>
<p>Estou usando diversos pacotes:</p>
<ul>
<li><p><code>ggplot2</code>, <code>plotly</code> e <code>ggforce</code> para gráficos.</p></li>
<li><p><code>gganimate</code> para animações (GIFs).</p></li>
<li><p><code>MASS</code> para simulações aleatórias de distribuições multivariadas.</p></li>
<li><p><code>rstan</code> para funções de sumário e métricas de convergência e desempenho de simulações MCMC.</p></li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ggplot2.tidyverse.org'>ggplot2</a></span><span class='op'>)</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme_get.html'>theme_set</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggtheme.html'>theme_minimal</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://plotly-r.com'>plotly</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://gganimate.com'>gganimate</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ggforce.data-imaginist.com'>ggforce</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='http://www.stats.ox.ac.uk/pub/MASS4/'>MASS</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://mc-stan.org/rstan'>rstan</a></span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Vamos começar com um problema didático de uma distribuição normal multivariada de <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>, onde</p>
<p><span class="math display">\[
\begin{bmatrix}
X \\
Y
\end{bmatrix} \sim \text{Normal Multivariada} \left(
\begin{bmatrix}
\mu_X \\
\mu_Y
\end{bmatrix}, \mathbf{\Sigma}
\right) \\
\mathbf{\Sigma} \sim
\begin{pmatrix}
\sigma^2_{X} &amp; \sigma_{X}\sigma_{Y} \rho \\
\sigma_{X}\sigma_{Y} \rho &amp; \sigma^2_{Y}
\end{pmatrix}
\]</span></p>
<p>Se designarmos <span class="math inline">\(\mu_X = \mu_Y = 0\)</span> e <span class="math inline">\(\sigma_X = \sigma_Y = 1\)</span> (média 0 e desvio padrão 1 para ambos <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>), temos a seguinte formulação:</p>
<p><span class="math display">\[
\begin{bmatrix}
X \\
Y
\end{bmatrix} \sim \text{Normal Multivariada} \left(
\begin{bmatrix}
0 \\
0
\end{bmatrix}, \mathbf{\Sigma}
\right), \\
\mathbf{\Sigma} \sim
\begin{pmatrix}
1 &amp; \rho \\
\rho &amp; 1
\end{pmatrix}.
\]</span></p>
<p>Só faltando designar um valor de <span class="math inline">\(\rho\)</span> para a correlação entre <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>. Para o nosso exemplo vamos usar correlação de 0.8 (<span class="math inline">\(\rho = 0.8\)</span>):</p>
<p><span class="math display">\[
\mathbf{\Sigma} \sim
\begin{pmatrix}
1 &amp; 0.8 \\
0.8 &amp; 1
\end{pmatrix}.
\]</span></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>N</span> <span class='op'>&lt;-</span> <span class='fl'>1e5</span>
<span class='va'>mus</span>  <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0</span><span class='op'>)</span>
<span class='va'>sigmas</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span>
<span class='va'>r</span> <span class='op'>&lt;-</span> <span class='fl'>0.8</span>
<span class='va'>Sigma</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='va'>sigmas</span><span class='op'>)</span>
<span class='va'>Sigma</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>r</span>
<span class='va'>Sigma</span><span class='op'>[</span><span class='fl'>2</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>r</span>
<span class='va'>dft</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/mvrnorm.html'>mvrnorm</a></span><span class='op'>(</span><span class='va'>N</span>, <span class='va'>mus</span>, <span class='va'>Sigma</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Na figura <a href="#fig:plot-mnorm">3</a> é possível ver um gráfico de densidade de uma distribuição multivariada normal de duas variáveis normais <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>, ambas com média 0 e desvio padrão 1. Sendo que a correlação entre elas é 0.8. E na figura <a href="#fig:plot3d-mnorm">4</a> é possível ver uma imagem 3-D interativa da mesma distribuição, fique a vontade em usar seu mouse (dedo ou caneta, dependendo do dispositivo) para movimentar a imagem.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>X1</span>, <span class='va'>X2</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_density_2d.html'>geom_density2d_filled</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>"Multivariada Normal"</span>,
       subtitle <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='va'>mu</span> <span class='op'>==</span> <span class='fl'>0</span>, <span class='va'>sigma</span> <span class='op'>==</span> <span class='fl'>1</span>, <span class='va'>rho</span> <span class='op'>==</span> <span class='fl'>0.8</span><span class='op'>)</span><span class='op'>)</span>,
       caption <span class='op'>=</span> <span class='st'>"10.000 simulações"</span>,
       x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>Y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"NULL"</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:plot-mnorm"></span>
<img src="5-MCMC_files/figure-html5/plot-mnorm-1.png" alt="Gráfico de Densidade de uma distribuição Multivariada Normal" width="624" />
<p class="caption">
Figure 3: Gráfico de Densidade de uma distribuição Multivariada Normal
</p>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>dens</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/pkg/MASS/man/kde2d.html'>kde2d</a></span><span class='op'>(</span><span class='va'>dft</span><span class='op'>$</span><span class='va'>X1</span>, <span class='va'>dft</span><span class='op'>$</span><span class='va'>X2</span><span class='op'>)</span>
<span class='fu'><a href='https://docs.ropensci.org/plotly/reference/plot_ly.html'>plot_ly</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>dens</span><span class='op'>$</span><span class='va'>x</span>,
        y <span class='op'>=</span> <span class='va'>dens</span><span class='op'>$</span><span class='va'>y</span>,
        z <span class='op'>=</span> <span class='va'>dens</span><span class='op'>$</span><span class='va'>z</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://docs.ropensci.org/plotly/reference/add_trace.html'>add_surface</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:plot3d-mnorm"></span>
<div id="htmlwidget-1e1fe609583c81f0fc20" style="width:624px;height:384px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-1e1fe609583c81f0fc20">{"x":{"visdat":{"10ed3949a7b":["function () ","plotlyVisDat"]},"cur_data":"10ed3949a7b","attrs":{"10ed3949a7b":{"x":[-4.11222323909044,-3.76275945114626,-3.41329566320208,-3.0638318752579,-2.71436808731372,-2.36490429936954,-2.01544051142536,-1.66597672348118,-1.316512935537,-0.967049147592815,-0.617585359648634,-0.268121571704453,0.0813422162397277,0.430806004183909,0.780269792128089,1.12973358007227,1.47919736801645,1.82866115596063,2.17812494390481,2.52758873184899,2.87705251979317,3.22651630773736,3.57598009568154,3.92544388362572,4.2749076715699],"y":[-4.32381413035071,-3.95784855910568,-3.59188298786066,-3.22591741661563,-2.85995184537061,-2.49398627412558,-2.12802070288055,-1.76205513163553,-1.3960895603905,-1.03012398914547,-0.664158417900448,-0.298192846655422,0.0677727245896049,0.433738295834631,0.799703867079657,1.16566943832468,1.53163500956971,1.89760058081474,2.26356615205976,2.62953172330479,2.99549729454982,3.36146286579484,3.72742843703987,4.09339400828489,4.45935957952992],"z":[[3.40651108352134e-09,1.41934533126133e-08,8.54786240302624e-08,0.000130831863209747,1.94776526567504e-06,1.49783603255103e-06,1.1170089576991e-08,6.01986954373106e-12,1.16817732135535e-10,1.50245544102462e-14,4.62944974810078e-23,4.83295093316628e-35,2.28048400569722e-45,8.78734985512727e-51,2.21962779786052e-61,3.67504668072926e-77,3.98846726370328e-98,2.83738455537123e-124,1.16702068177763e-153,1.56588648116791e-183,5.9460095882168e-217,3.04648237511363e-242,1.0476778777822e-272,2.36166828733039e-308,0],[4.39462560522794e-05,6.94943900679841e-05,1.04291502349634e-05,5.75970473307081e-05,0.000176906604268204,0.000370540209494104,1.55421446807263e-05,8.30475843056959e-07,1.53069632670964e-05,7.14342142452053e-09,1.13543480848847e-15,2.9038893623358e-25,2.64561847471716e-28,1.01950388004498e-33,2.57520093025581e-44,4.26377054766638e-60,4.6281649856682e-81,2.42118913413043e-104,5.00622985414094e-129,7.25515626339583e-159,3.68875889960785e-180,1.93530271945878e-205,6.65546074071442e-236,5.25171440440826e-271,5.21884573812369e-305],[9.55774448047614e-05,0.000177213516750328,0.000316039775630404,0.000475626271585416,0.000761122825446468,0.000814816903847166,0.000578652080468251,0.000157642005236617,0.000152603615623742,3.79131793396399e-06,7.51171055499296e-11,3.17899382836251e-15,5.96544729558909e-16,2.29881835031841e-21,5.80666661659396e-32,9.62751627134557e-48,6.45601148716749e-65,2.03894997743999e-84,4.22210611955478e-109,5.68993288800346e-128,4.55423370733433e-148,2.3893730364403e-173,9.74271181456202e-204,3.23808866743861e-233,4.50467722508192e-267],[1.98596665642571e-07,4.68000995544877e-05,0.000509090380019503,0.000931319298108951,0.0012891264719117,0.00255519224543074,0.00194691180666576,0.00139812985945186,0.000387322200480871,0.000138389622336007,1.12962183753118e-05,4.51541808458966e-08,2.61431851364547e-08,1.00740783248176e-13,2.57450769746435e-24,2.19535111827777e-35,1.05790746618256e-49,3.3419444921475e-69,1.11809791229766e-85,1.36529655130866e-100,1.09278610207721e-120,5.81233702380819e-146,2.55947654424468e-171,5.43203463930242e-200,7.55679638075802e-234],[2.0971717790889e-11,2.45146152673218e-05,0.00101641626246237,0.0012023963529308,0.00431348854715178,0.00596725675304324,0.00681722538407796,0.00633846543983796,0.00269032102983323,0.00186745629509051,0.000257016293377211,6.68099172102812e-05,2.23554936688109e-05,9.43773499495428e-11,9.51160167439667e-16,6.99272785694416e-25,3.37970089697892e-39,2.8443677530022e-53,5.21415549375954e-63,6.36695308508056e-78,5.10133947007011e-98,2.57749276005559e-119,8.34462177624758e-143,1.77101149161936e-171,2.46374961111803e-205],[2.18739954530607e-13,8.27469962250889e-07,0.00068247158549802,0.00129956984621859,0.00404868380339934,0.0102606158585002,0.0148087501034371,0.0152333593380476,0.0125919827053159,0.00699472312030991,0.00241781085109058,0.000326864762138592,1.64609783322298e-05,5.34463376690191e-06,5.93226571697135e-10,5.36558733277978e-19,1.90647639364607e-28,2.53683060667389e-35,4.72578158624974e-45,5.77104072981931e-60,3.31061440322712e-77,1.63303711875425e-95,5.28749916069209e-119,1.12218648450566e-147,1.56113414734455e-181],[2.95266849169562e-16,2.85416661335113e-08,8.90740945415943e-05,0.00122580118110615,0.0046414034091961,0.0107569609558745,0.0239117407486324,0.0345320261172182,0.034266290423328,0.025908337162062,0.0111683859733492,0.00396670124627087,0.00103938025934649,0.000215424763750705,2.74471340647353e-07,1.04918685044655e-11,1.59258336217706e-17,4.46886513511614e-22,8.32438239306983e-32,5.50420318373213e-45,4.07127773250312e-58,2.01105763346145e-76,6.51146592352183e-100,1.38195370474173e-128,2.93245589422197e-157],[5.39964840899981e-19,5.73783566121195e-10,4.95237822889483e-06,0.000356036530448518,0.00364161528795007,0.0112329442468965,0.0252826501600385,0.0504539247890418,0.0644047045560643,0.0565147591080807,0.0365725560107204,0.0168018818177516,0.00511766159567819,0.00114102783214639,0.000134221597433633,3.14802960871893e-07,5.45629826051782e-09,1.53072361775968e-13,1.41245242401531e-22,1.29303645153607e-30,9.74415078109988e-44,4.81324295289534e-62,1.55844700619099e-85,4.43400824553211e-109,2.84966144455127e-127],[8.08171755432348e-23,9.9520282620662e-12,8.72151014566793e-06,0.000237656044981198,0.00242087074777216,0.0074732039291603,0.022384642393563,0.0557037311872487,0.0912557128673284,0.111817977555221,0.0876421013472796,0.0510910440320731,0.0211567749509494,0.00631968870616185,0.00125306808856439,0.000249914243381994,3.94877458670163e-05,1.74347212052722e-09,5.23218109941235e-13,6.0146277187387e-21,4.53254441838339e-34,2.23890921563308e-52,8.54657858913127e-71,8.37418644669075e-84,5.38198765821467e-102],[1.77556608338451e-26,4.68244714950935e-15,5.72836682532587e-08,5.26618049520792e-05,0.000520971666093416,0.00358304354991811,0.0146024372316178,0.0418007880446392,0.0937576081086299,0.158070989476187,0.157995985258691,0.117472705761148,0.068309234060372,0.0258290121813925,0.00614303473251792,0.00140371367897623,0.000338744362715045,2.87186516456263e-05,4.72966243885067e-08,5.43755630957161e-16,4.12176724282202e-29,8.46961929462488e-42,3.13499804301411e-50,3.07380889542921e-63,1.97549954784854e-81],[3.73881979289422e-28,4.1820126805177e-15,3.42658639075899e-07,0.000213096739325229,4.3973222484619e-05,0.00128105280915237,0.00620857351658763,0.0236609682820968,0.0673959425125629,0.142023226278179,0.202085537513268,0.206177388365867,0.142910430049431,0.0718865969637724,0.0247087506133945,0.0047660988724505,0.0012606718949474,0.000106045234620241,1.61011212783354e-07,3.22788996902712e-14,9.2123618335293e-20,1.49536811118862e-26,2.23643511113796e-34,2.19278426565827e-47,1.4092757463806e-65],[3.96017717925257e-29,3.86645225973798e-16,2.47948115467607e-08,1.04690276048912e-05,9.33739859692154e-08,0.000133111110976272,0.001505336639134,0.0100449990636382,0.0356202331310127,0.105081641208442,0.19439947445164,0.245025075795557,0.223771691425712,0.143465906225543,0.0646419650813796,0.0193175819154857,0.00436838485724641,0.000892066964783552,3.18041827586292e-05,1.69881000386951e-07,1.59463339843398e-12,2.07291272771527e-15,3.10070286927428e-23,3.04018320512746e-36,1.95388872614587e-54],[9.27339116358244e-35,9.03850964769535e-22,5.77463739774986e-14,2.41842863581794e-11,3.88926919292566e-09,0.000100098427596149,0.00050944399843051,0.00360939499961912,0.0136893590316382,0.0543814561636372,0.125589050531115,0.214168898320003,0.252702330848491,0.212680258807483,0.12368371559332,0.0571604244308721,0.0148492657453032,0.00428301746930206,0.000533538675367115,2.75095327364781e-05,2.44919907449026e-06,5.58559793676326e-09,8.35504525271334e-17,8.19197108729206e-30,5.26488017941314e-48],[4.22630081869033e-45,4.11918272416941e-32,2.63161451387286e-24,3.34109926960455e-18,4.16151119979132e-09,3.41162097549106e-05,8.99545384914694e-05,0.000537014515485226,0.00565794795375072,0.0201673293936082,0.0650968150283119,0.13459457027411,0.216709166154952,0.233737316709245,0.179942550046156,0.0954030715862073,0.0358967231160644,0.00978785209447172,0.00200550639931911,0.000394946604594165,0.000128582191560498,2.92511773464097e-07,4.37544553451306e-15,4.29280429019131e-28,6.30606127729647e-38],[3.74346108554796e-60,3.64858019840399e-47,6.70536258912719e-37,1.26938304068891e-22,1.58065154101849e-13,1.29158993030982e-09,1.61465392359957e-06,9.08018401722032e-05,0.000992221126994708,0.00512632101729583,0.0213674249325609,0.0609771333181536,0.127073954333846,0.182795988224094,0.182286136161845,0.128019925458391,0.0639035259991266,0.0214065384771248,0.00490871234422249,0.000973054976315337,4.01022180114187e-05,5.72791275188721e-09,9.59043068097496e-17,2.97039793505775e-18,6.78914545169897e-25],[6.44423115594109e-80,1.76612292089083e-65,4.93647515191911e-46,9.37777211109363e-32,1.1698365693386e-22,1.41425275871238e-13,6.22698386517161e-07,2.62951805516803e-05,0.000279527597873221,0.00157860429446793,0.00602574560623074,0.018752616701671,0.0543021443993639,0.103895733283513,0.132977779790837,0.128374603771506,0.0753939336135714,0.0355212183761688,0.0120559569069517,0.00206194514165532,0.000441096970059341,2.73484240954569e-07,1.78469373193845e-08,6.21521805008958e-10,1.42055105743125e-16],[7.68729358424888e-104,2.44560642444526e-79,7.08775698856484e-60,1.3645720073284e-45,1.85668279000812e-30,1.24717099176323e-18,5.51514928616487e-12,3.59878422919363e-08,7.11836377827706e-06,0.000206159016212575,0.000677559737625132,0.00454096610629842,0.0184411701444843,0.0423810497069583,0.0716411419156444,0.0888352172498334,0.0766481090433616,0.0426458883542985,0.0175314894554273,0.00410447707852974,0.00104229547613349,0.000236141437094331,7.29387726175071e-05,2.52746047466519e-06,5.77674769488895e-13],[1.54348158058503e-122,6.82438055278491e-98,2.1764367130903e-78,3.10524776593914e-57,3.18217737427384e-40,2.1376226328524e-28,2.96521296109842e-21,3.35038012197265e-15,1.97523298476773e-08,0.000133046448270912,0.000137471144441657,0.000903339786529172,0.00339562223667828,0.0128631814378422,0.0284907613212608,0.0459004645516009,0.0504343969800885,0.0368454386741711,0.020295131275482,0.00834622530427719,0.0025276260264015,0.000264485978452582,7.42808296982338e-05,2.97754176124738e-07,5.54723640489585e-14],[8.37072222983159e-146,6.47496277221125e-121,6.61607426510692e-94,1.03435132478381e-71,1.05997695834429e-54,7.26629325820164e-43,3.44825400430606e-33,1.16750358152517e-20,8.87833074222978e-12,6.03705086913571e-08,3.0979146677307e-07,0.000111121155685573,0.000546159808841194,0.00234731614653475,0.00811613899679378,0.01524872508983,0.0224969610775458,0.0222048655285225,0.0165153003974538,0.00796127257796058,0.00238983759119942,0.000568475706754498,0.000111703499381798,1.37762505288305e-06,7.78323799691101e-13],[5.8174658995359e-173,1.79576621930351e-140,4.28308842051526e-113,6.69614350285288e-91,6.86338053828388e-74,5.70790798535558e-61,9.45947538521377e-43,1.05207977853767e-28,8.00037164310086e-20,5.43819520219381e-16,1.1447107087918e-12,7.6069411229749e-08,1.88824406030061e-05,0.000282589139759991,0.0013566840600888,0.0043332775154336,0.00841566316788047,0.0115467512308974,0.00989353732973917,0.00702460127430449,0.00248407446365753,0.000835282652146337,0.00019689042809369,3.98684425041365e-05,1.13279935581737e-06],[6.20932658184517e-197,2.25939039635564e-164,5.3888801122331e-137,8.42494444063686e-115,9.85285809081692e-98,9.81016236238191e-75,1.65677535778078e-55,1.84264779117487e-41,1.40112690321962e-32,9.7734482363793e-29,8.84275975640076e-21,5.42678565856387e-14,3.55725848792818e-09,2.50688031203498e-05,0.00037257061396806,0.000652072224755515,0.00220596575329706,0.00390824530472625,0.00383520710782124,0.00356746514374532,0.00198660746096792,0.000847086231459706,0.000420124430561813,0.000206161951735914,0.000139297549047621],[1.51834614100114e-225,5.52481278783358e-193,1.31772509679596e-165,2.06533081524484e-143,1.29673322046541e-116,3.33931942363595e-92,5.63955821152384e-73,6.27221302516466e-59,4.76902554018659e-50,2.05571003722159e-43,6.4564082722214e-32,9.97509200941749e-22,2.50203874102328e-11,5.38184636508631e-06,2.28640215213753e-05,5.21287951737725e-05,0.000417456509937771,0.000641775046044822,0.00116730324640233,0.00158181795727826,0.00100667520344559,0.00068510033767778,0.000277599060128235,4.61300248449355e-05,4.35426880886139e-05],[7.215756742882e-259,2.6256005832423e-226,6.26274913779807e-199,2.18370540673512e-168,8.57861654858231e-139,2.20914667283235e-114,3.73088057671666e-95,4.14938831485597e-81,3.15554639168223e-72,1.05662622923261e-59,1.43227275358807e-42,5.4931932302565e-27,1.4524397658288e-16,3.79389505892861e-11,2.20909001199427e-10,3.05546580679959e-09,4.35913186858356e-06,3.31707747133925e-05,0.000430542207310076,0.000586742208506192,0.000307810148878761,0.000253683181760847,0.000409041984564786,7.35977011753656e-06,5.00851432147429e-07],[6.66465670367594e-297,2.42507689762034e-264,4.68473831753259e-230,2.80766623244054e-195,1.10298265871409e-165,2.84037672197857e-141,4.79691936622069e-122,5.33497231006159e-108,2.51418740546229e-97,2.69430717937953e-73,1.56978231833671e-52,6.05179120216435e-37,1.68469487817489e-26,5.83767588635578e-21,4.46168128161558e-20,1.47718573329587e-15,3.03760156043252e-12,1.11175862458942e-08,4.77448480759622e-07,1.37527946349091e-05,3.27369657863926e-05,4.5069603918654e-05,2.18665863961594e-05,2.45790160940866e-07,2.16743981653795e-12],[0,1.28033478220917e-301,1.17063504610327e-261,7.01587297133337e-227,2.75616313180305e-197,7.09761020470235e-173,1.1986662995098e-153,1.33312158277165e-139,6.45923897222376e-114,5.73686958901279e-88,3.34560845825795e-67,1.30290708566137e-51,3.98283248267262e-41,1.95445068709012e-35,2.5163612212255e-34,2.13073194576148e-26,2.2103622973781e-22,1.36299881951402e-16,5.4223823620928e-13,9.64890337003241e-07,4.75103088380026e-05,1.74076683148872e-08,2.3982844765835e-05,4.12736376796499e-05,4.65593304437425e-10]],"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"surface","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"scene":{"xaxis":{"title":[]},"yaxis":{"title":[]},"zaxis":{"title":[]}},"hovermode":"closest","showlegend":false,"legend":{"yanchor":"top","y":0.5}},"source":"A","config":{"showSendToCloud":false},"data":[{"colorbar":{"title":"","ticklen":2,"len":0.5,"lenmode":"fraction","y":1,"yanchor":"top"},"colorscale":[["0","rgba(68,1,84,1)"],["0.0416666666666667","rgba(70,19,97,1)"],["0.0833333333333333","rgba(72,32,111,1)"],["0.125","rgba(71,45,122,1)"],["0.166666666666667","rgba(68,58,128,1)"],["0.208333333333333","rgba(64,70,135,1)"],["0.25","rgba(60,82,138,1)"],["0.291666666666667","rgba(56,93,140,1)"],["0.333333333333333","rgba(49,104,142,1)"],["0.375","rgba(46,114,142,1)"],["0.416666666666667","rgba(42,123,142,1)"],["0.458333333333333","rgba(38,133,141,1)"],["0.5","rgba(37,144,140,1)"],["0.541666666666667","rgba(33,154,138,1)"],["0.583333333333333","rgba(39,164,133,1)"],["0.625","rgba(47,174,127,1)"],["0.666666666666667","rgba(53,183,121,1)"],["0.708333333333333","rgba(79,191,110,1)"],["0.75","rgba(98,199,98,1)"],["0.791666666666667","rgba(119,207,85,1)"],["0.833333333333333","rgba(147,214,70,1)"],["0.875","rgba(172,220,52,1)"],["0.916666666666667","rgba(199,225,42,1)"],["0.958333333333333","rgba(226,228,40,1)"],["1","rgba(253,231,37,1)"]],"showscale":true,"x":[-4.11222323909044,-3.76275945114626,-3.41329566320208,-3.0638318752579,-2.71436808731372,-2.36490429936954,-2.01544051142536,-1.66597672348118,-1.316512935537,-0.967049147592815,-0.617585359648634,-0.268121571704453,0.0813422162397277,0.430806004183909,0.780269792128089,1.12973358007227,1.47919736801645,1.82866115596063,2.17812494390481,2.52758873184899,2.87705251979317,3.22651630773736,3.57598009568154,3.92544388362572,4.2749076715699],"y":[-4.32381413035071,-3.95784855910568,-3.59188298786066,-3.22591741661563,-2.85995184537061,-2.49398627412558,-2.12802070288055,-1.76205513163553,-1.3960895603905,-1.03012398914547,-0.664158417900448,-0.298192846655422,0.0677727245896049,0.433738295834631,0.799703867079657,1.16566943832468,1.53163500956971,1.89760058081474,2.26356615205976,2.62953172330479,2.99549729454982,3.36146286579484,3.72742843703987,4.09339400828489,4.45935957952992],"z":[[3.40651108352134e-09,1.41934533126133e-08,8.54786240302624e-08,0.000130831863209747,1.94776526567504e-06,1.49783603255103e-06,1.1170089576991e-08,6.01986954373106e-12,1.16817732135535e-10,1.50245544102462e-14,4.62944974810078e-23,4.83295093316628e-35,2.28048400569722e-45,8.78734985512727e-51,2.21962779786052e-61,3.67504668072926e-77,3.98846726370328e-98,2.83738455537123e-124,1.16702068177763e-153,1.56588648116791e-183,5.9460095882168e-217,3.04648237511363e-242,1.0476778777822e-272,2.36166828733039e-308,0],[4.39462560522794e-05,6.94943900679841e-05,1.04291502349634e-05,5.75970473307081e-05,0.000176906604268204,0.000370540209494104,1.55421446807263e-05,8.30475843056959e-07,1.53069632670964e-05,7.14342142452053e-09,1.13543480848847e-15,2.9038893623358e-25,2.64561847471716e-28,1.01950388004498e-33,2.57520093025581e-44,4.26377054766638e-60,4.6281649856682e-81,2.42118913413043e-104,5.00622985414094e-129,7.25515626339583e-159,3.68875889960785e-180,1.93530271945878e-205,6.65546074071442e-236,5.25171440440826e-271,5.21884573812369e-305],[9.55774448047614e-05,0.000177213516750328,0.000316039775630404,0.000475626271585416,0.000761122825446468,0.000814816903847166,0.000578652080468251,0.000157642005236617,0.000152603615623742,3.79131793396399e-06,7.51171055499296e-11,3.17899382836251e-15,5.96544729558909e-16,2.29881835031841e-21,5.80666661659396e-32,9.62751627134557e-48,6.45601148716749e-65,2.03894997743999e-84,4.22210611955478e-109,5.68993288800346e-128,4.55423370733433e-148,2.3893730364403e-173,9.74271181456202e-204,3.23808866743861e-233,4.50467722508192e-267],[1.98596665642571e-07,4.68000995544877e-05,0.000509090380019503,0.000931319298108951,0.0012891264719117,0.00255519224543074,0.00194691180666576,0.00139812985945186,0.000387322200480871,0.000138389622336007,1.12962183753118e-05,4.51541808458966e-08,2.61431851364547e-08,1.00740783248176e-13,2.57450769746435e-24,2.19535111827777e-35,1.05790746618256e-49,3.3419444921475e-69,1.11809791229766e-85,1.36529655130866e-100,1.09278610207721e-120,5.81233702380819e-146,2.55947654424468e-171,5.43203463930242e-200,7.55679638075802e-234],[2.0971717790889e-11,2.45146152673218e-05,0.00101641626246237,0.0012023963529308,0.00431348854715178,0.00596725675304324,0.00681722538407796,0.00633846543983796,0.00269032102983323,0.00186745629509051,0.000257016293377211,6.68099172102812e-05,2.23554936688109e-05,9.43773499495428e-11,9.51160167439667e-16,6.99272785694416e-25,3.37970089697892e-39,2.8443677530022e-53,5.21415549375954e-63,6.36695308508056e-78,5.10133947007011e-98,2.57749276005559e-119,8.34462177624758e-143,1.77101149161936e-171,2.46374961111803e-205],[2.18739954530607e-13,8.27469962250889e-07,0.00068247158549802,0.00129956984621859,0.00404868380339934,0.0102606158585002,0.0148087501034371,0.0152333593380476,0.0125919827053159,0.00699472312030991,0.00241781085109058,0.000326864762138592,1.64609783322298e-05,5.34463376690191e-06,5.93226571697135e-10,5.36558733277978e-19,1.90647639364607e-28,2.53683060667389e-35,4.72578158624974e-45,5.77104072981931e-60,3.31061440322712e-77,1.63303711875425e-95,5.28749916069209e-119,1.12218648450566e-147,1.56113414734455e-181],[2.95266849169562e-16,2.85416661335113e-08,8.90740945415943e-05,0.00122580118110615,0.0046414034091961,0.0107569609558745,0.0239117407486324,0.0345320261172182,0.034266290423328,0.025908337162062,0.0111683859733492,0.00396670124627087,0.00103938025934649,0.000215424763750705,2.74471340647353e-07,1.04918685044655e-11,1.59258336217706e-17,4.46886513511614e-22,8.32438239306983e-32,5.50420318373213e-45,4.07127773250312e-58,2.01105763346145e-76,6.51146592352183e-100,1.38195370474173e-128,2.93245589422197e-157],[5.39964840899981e-19,5.73783566121195e-10,4.95237822889483e-06,0.000356036530448518,0.00364161528795007,0.0112329442468965,0.0252826501600385,0.0504539247890418,0.0644047045560643,0.0565147591080807,0.0365725560107204,0.0168018818177516,0.00511766159567819,0.00114102783214639,0.000134221597433633,3.14802960871893e-07,5.45629826051782e-09,1.53072361775968e-13,1.41245242401531e-22,1.29303645153607e-30,9.74415078109988e-44,4.81324295289534e-62,1.55844700619099e-85,4.43400824553211e-109,2.84966144455127e-127],[8.08171755432348e-23,9.9520282620662e-12,8.72151014566793e-06,0.000237656044981198,0.00242087074777216,0.0074732039291603,0.022384642393563,0.0557037311872487,0.0912557128673284,0.111817977555221,0.0876421013472796,0.0510910440320731,0.0211567749509494,0.00631968870616185,0.00125306808856439,0.000249914243381994,3.94877458670163e-05,1.74347212052722e-09,5.23218109941235e-13,6.0146277187387e-21,4.53254441838339e-34,2.23890921563308e-52,8.54657858913127e-71,8.37418644669075e-84,5.38198765821467e-102],[1.77556608338451e-26,4.68244714950935e-15,5.72836682532587e-08,5.26618049520792e-05,0.000520971666093416,0.00358304354991811,0.0146024372316178,0.0418007880446392,0.0937576081086299,0.158070989476187,0.157995985258691,0.117472705761148,0.068309234060372,0.0258290121813925,0.00614303473251792,0.00140371367897623,0.000338744362715045,2.87186516456263e-05,4.72966243885067e-08,5.43755630957161e-16,4.12176724282202e-29,8.46961929462488e-42,3.13499804301411e-50,3.07380889542921e-63,1.97549954784854e-81],[3.73881979289422e-28,4.1820126805177e-15,3.42658639075899e-07,0.000213096739325229,4.3973222484619e-05,0.00128105280915237,0.00620857351658763,0.0236609682820968,0.0673959425125629,0.142023226278179,0.202085537513268,0.206177388365867,0.142910430049431,0.0718865969637724,0.0247087506133945,0.0047660988724505,0.0012606718949474,0.000106045234620241,1.61011212783354e-07,3.22788996902712e-14,9.2123618335293e-20,1.49536811118862e-26,2.23643511113796e-34,2.19278426565827e-47,1.4092757463806e-65],[3.96017717925257e-29,3.86645225973798e-16,2.47948115467607e-08,1.04690276048912e-05,9.33739859692154e-08,0.000133111110976272,0.001505336639134,0.0100449990636382,0.0356202331310127,0.105081641208442,0.19439947445164,0.245025075795557,0.223771691425712,0.143465906225543,0.0646419650813796,0.0193175819154857,0.00436838485724641,0.000892066964783552,3.18041827586292e-05,1.69881000386951e-07,1.59463339843398e-12,2.07291272771527e-15,3.10070286927428e-23,3.04018320512746e-36,1.95388872614587e-54],[9.27339116358244e-35,9.03850964769535e-22,5.77463739774986e-14,2.41842863581794e-11,3.88926919292566e-09,0.000100098427596149,0.00050944399843051,0.00360939499961912,0.0136893590316382,0.0543814561636372,0.125589050531115,0.214168898320003,0.252702330848491,0.212680258807483,0.12368371559332,0.0571604244308721,0.0148492657453032,0.00428301746930206,0.000533538675367115,2.75095327364781e-05,2.44919907449026e-06,5.58559793676326e-09,8.35504525271334e-17,8.19197108729206e-30,5.26488017941314e-48],[4.22630081869033e-45,4.11918272416941e-32,2.63161451387286e-24,3.34109926960455e-18,4.16151119979132e-09,3.41162097549106e-05,8.99545384914694e-05,0.000537014515485226,0.00565794795375072,0.0201673293936082,0.0650968150283119,0.13459457027411,0.216709166154952,0.233737316709245,0.179942550046156,0.0954030715862073,0.0358967231160644,0.00978785209447172,0.00200550639931911,0.000394946604594165,0.000128582191560498,2.92511773464097e-07,4.37544553451306e-15,4.29280429019131e-28,6.30606127729647e-38],[3.74346108554796e-60,3.64858019840399e-47,6.70536258912719e-37,1.26938304068891e-22,1.58065154101849e-13,1.29158993030982e-09,1.61465392359957e-06,9.08018401722032e-05,0.000992221126994708,0.00512632101729583,0.0213674249325609,0.0609771333181536,0.127073954333846,0.182795988224094,0.182286136161845,0.128019925458391,0.0639035259991266,0.0214065384771248,0.00490871234422249,0.000973054976315337,4.01022180114187e-05,5.72791275188721e-09,9.59043068097496e-17,2.97039793505775e-18,6.78914545169897e-25],[6.44423115594109e-80,1.76612292089083e-65,4.93647515191911e-46,9.37777211109363e-32,1.1698365693386e-22,1.41425275871238e-13,6.22698386517161e-07,2.62951805516803e-05,0.000279527597873221,0.00157860429446793,0.00602574560623074,0.018752616701671,0.0543021443993639,0.103895733283513,0.132977779790837,0.128374603771506,0.0753939336135714,0.0355212183761688,0.0120559569069517,0.00206194514165532,0.000441096970059341,2.73484240954569e-07,1.78469373193845e-08,6.21521805008958e-10,1.42055105743125e-16],[7.68729358424888e-104,2.44560642444526e-79,7.08775698856484e-60,1.3645720073284e-45,1.85668279000812e-30,1.24717099176323e-18,5.51514928616487e-12,3.59878422919363e-08,7.11836377827706e-06,0.000206159016212575,0.000677559737625132,0.00454096610629842,0.0184411701444843,0.0423810497069583,0.0716411419156444,0.0888352172498334,0.0766481090433616,0.0426458883542985,0.0175314894554273,0.00410447707852974,0.00104229547613349,0.000236141437094331,7.29387726175071e-05,2.52746047466519e-06,5.77674769488895e-13],[1.54348158058503e-122,6.82438055278491e-98,2.1764367130903e-78,3.10524776593914e-57,3.18217737427384e-40,2.1376226328524e-28,2.96521296109842e-21,3.35038012197265e-15,1.97523298476773e-08,0.000133046448270912,0.000137471144441657,0.000903339786529172,0.00339562223667828,0.0128631814378422,0.0284907613212608,0.0459004645516009,0.0504343969800885,0.0368454386741711,0.020295131275482,0.00834622530427719,0.0025276260264015,0.000264485978452582,7.42808296982338e-05,2.97754176124738e-07,5.54723640489585e-14],[8.37072222983159e-146,6.47496277221125e-121,6.61607426510692e-94,1.03435132478381e-71,1.05997695834429e-54,7.26629325820164e-43,3.44825400430606e-33,1.16750358152517e-20,8.87833074222978e-12,6.03705086913571e-08,3.0979146677307e-07,0.000111121155685573,0.000546159808841194,0.00234731614653475,0.00811613899679378,0.01524872508983,0.0224969610775458,0.0222048655285225,0.0165153003974538,0.00796127257796058,0.00238983759119942,0.000568475706754498,0.000111703499381798,1.37762505288305e-06,7.78323799691101e-13],[5.8174658995359e-173,1.79576621930351e-140,4.28308842051526e-113,6.69614350285288e-91,6.86338053828388e-74,5.70790798535558e-61,9.45947538521377e-43,1.05207977853767e-28,8.00037164310086e-20,5.43819520219381e-16,1.1447107087918e-12,7.6069411229749e-08,1.88824406030061e-05,0.000282589139759991,0.0013566840600888,0.0043332775154336,0.00841566316788047,0.0115467512308974,0.00989353732973917,0.00702460127430449,0.00248407446365753,0.000835282652146337,0.00019689042809369,3.98684425041365e-05,1.13279935581737e-06],[6.20932658184517e-197,2.25939039635564e-164,5.3888801122331e-137,8.42494444063686e-115,9.85285809081692e-98,9.81016236238191e-75,1.65677535778078e-55,1.84264779117487e-41,1.40112690321962e-32,9.7734482363793e-29,8.84275975640076e-21,5.42678565856387e-14,3.55725848792818e-09,2.50688031203498e-05,0.00037257061396806,0.000652072224755515,0.00220596575329706,0.00390824530472625,0.00383520710782124,0.00356746514374532,0.00198660746096792,0.000847086231459706,0.000420124430561813,0.000206161951735914,0.000139297549047621],[1.51834614100114e-225,5.52481278783358e-193,1.31772509679596e-165,2.06533081524484e-143,1.29673322046541e-116,3.33931942363595e-92,5.63955821152384e-73,6.27221302516466e-59,4.76902554018659e-50,2.05571003722159e-43,6.4564082722214e-32,9.97509200941749e-22,2.50203874102328e-11,5.38184636508631e-06,2.28640215213753e-05,5.21287951737725e-05,0.000417456509937771,0.000641775046044822,0.00116730324640233,0.00158181795727826,0.00100667520344559,0.00068510033767778,0.000277599060128235,4.61300248449355e-05,4.35426880886139e-05],[7.215756742882e-259,2.6256005832423e-226,6.26274913779807e-199,2.18370540673512e-168,8.57861654858231e-139,2.20914667283235e-114,3.73088057671666e-95,4.14938831485597e-81,3.15554639168223e-72,1.05662622923261e-59,1.43227275358807e-42,5.4931932302565e-27,1.4524397658288e-16,3.79389505892861e-11,2.20909001199427e-10,3.05546580679959e-09,4.35913186858356e-06,3.31707747133925e-05,0.000430542207310076,0.000586742208506192,0.000307810148878761,0.000253683181760847,0.000409041984564786,7.35977011753656e-06,5.00851432147429e-07],[6.66465670367594e-297,2.42507689762034e-264,4.68473831753259e-230,2.80766623244054e-195,1.10298265871409e-165,2.84037672197857e-141,4.79691936622069e-122,5.33497231006159e-108,2.51418740546229e-97,2.69430717937953e-73,1.56978231833671e-52,6.05179120216435e-37,1.68469487817489e-26,5.83767588635578e-21,4.46168128161558e-20,1.47718573329587e-15,3.03760156043252e-12,1.11175862458942e-08,4.77448480759622e-07,1.37527946349091e-05,3.27369657863926e-05,4.5069603918654e-05,2.18665863961594e-05,2.45790160940866e-07,2.16743981653795e-12],[0,1.28033478220917e-301,1.17063504610327e-261,7.01587297133337e-227,2.75616313180305e-197,7.09761020470235e-173,1.1986662995098e-153,1.33312158277165e-139,6.45923897222376e-114,5.73686958901279e-88,3.34560845825795e-67,1.30290708566137e-51,3.98283248267262e-41,1.95445068709012e-35,2.5163612212255e-34,2.13073194576148e-26,2.2103622973781e-22,1.36299881951402e-16,5.4223823620928e-13,9.64890337003241e-07,4.75103088380026e-05,1.74076683148872e-08,2.3982844765835e-05,4.12736376796499e-05,4.65593304437425e-10]],"type":"surface","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
<p class="caption">
Figure 4: Imagem 3-D Interativa de uma distribuição Multivariada Normal
</p>
</div>
</div>
<h3 id="metropolis-e-metropolis-hastings">Metropolis e Metropolis-Hastings</h3>
<p>O primeiro algoritmo MCMC amplamente utilizado para gerar amostras de correntes Markov foi originário na física na década de 1950 (inclusive uma relação muito próxima com a bomba atômica no projeto Manhattan) e chama-se Metropolis <span class="citation" data-cites="metropolisEquationStateCalculations1953">(<a href="#ref-metropolisEquationStateCalculations1953" role="doc-biblioref">Metropolis, Rosenbluth, Rosenbluth, Teller, &amp; Teller, 1953</a>)</span> em homenagem ao primeiro autor <a href="https://en.wikipedia.org/wiki/Nicholas_Metropolis" title="Nicholas Metropolis">Nicholas Metropolis</a> (figura <a href="#fig:metropolis-hastings">5</a>). Em síntese, o algoritmo de Metropolis é uma adaptação de um passeio aleatório (<em>random walk</em>) com uma regra de aceitação/rejeição para convergir à distribuição-alvo.</p>
<p>O algorimo de Metropolis usa uma <strong>distribuição de propostas</strong> <span class="math inline">\(J_t(\theta^*)\)</span> (<span class="math inline">\(J\)</span> quer dizer <em>jumping distribution</em> e <span class="math inline">\(t\)</span> indica em qual estado da corrente Markov estamos) para definir próximos valores da distribuição <span class="math inline">\(P^*(\theta^* | \text{data})\)</span>. Essa distribuição deve ser simétrica:</p>
<p><span class="math display">\[
J_t (\theta^* | \theta^{t-1}) = J_t(\theta^{t-1}|\theta^*).
\]</span></p>
<p>Na década de 1970, surgiu um generalização do algoritmo de Metropolis que <strong>não</strong> necessita que as distribuições de proposta sejam simétricas. A generalização foi proposta por <a href="https://en.wikipedia.org/wiki/W._K._Hastings">Wilfred Keith Hastings</a> <span class="citation" data-cites="hastingsMonteCarloSampling1970">(<a href="#ref-hastingsMonteCarloSampling1970" role="doc-biblioref">Hastings, 1970</a>)</span> (figura <a href="#fig:metropolis-hastings">5</a>) e chama-se algoritmo de Metropolis-Hastings.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:metropolis-hastings"></span>
<img src="5-MCMC_files/figure-html5/metropolis-hastings-1.png" alt="Da esquerda para direita: Nicholas Metropolis e Wilfred Hastings -- Figuras de https://www.wikipedia.org" width="33%" class=external />
<p class="caption">
Figure 5: Da esquerda para direita: Nicholas Metropolis e Wilfred Hastings – Figuras de <a href="https://www.wikipedia.org" class="uri">https://www.wikipedia.org</a>
</p>
</div>
</div>
<h4 id="algoritmo-de-metropolis">Algoritmo de Metropolis</h4>
<p>A essência do algoritmo é um passeio aleatório (<em>random walk</em>) pelo espaço amostral dos parâmetros, onde a probabilidade da corrente Markov mudar de estado é definida como:</p>
<p><span class="math display">\[
P_{\text{mudar}} = \min\left({\frac{P (\theta_{\text{proposto}})}{P (\theta_{\text{atual}})}},1\right).
\]</span></p>
<p>Isso quer dizer a corrente Markov somente mudará para um novo estado em duas condições:</p>
<ol type="1">
<li>Quando a probabilidade dos parâmetros propostos pelo passeio aleatório <span class="math inline">\(P(\theta_{\text{proposto}})\)</span> é <strong>maior</strong> que a probabilidade dos parâmetros do estado atual <span class="math inline">\(P(\theta_{\text{atual}})\)</span>, mudamos com 100% de probabilidade. Vejam que se <span class="math inline">\(P(\theta_{\text{proposto}}) &gt; P(\theta_{\text{atual}})\)</span> então a função <span class="math inline">\(\min\)</span> escolhe o valor 1 que quer dizer 100%.</li>
<li>Quando a probabilidade dos parâmetros propostos pelo passeio aleatório <span class="math inline">\(P(\theta_{\text{proposto}})\)</span> é <strong>menor</strong> que a probabilidade dos parâmetros do estado atual <span class="math inline">\(P(\theta_{\text{atual}})\)</span>, mudamos com probabilidade igual a proporção dessa diferença. Vejam que se <span class="math inline">\(P(\theta_{\text{proposto}}) &lt; P(\theta_{\text{atual}})\)</span> então a função <span class="math inline">\(\min\)</span> <strong>não</strong> escolhe o valor 1, mas sim o valor <span class="math inline">\(\frac{P (\theta_{\text{proposto}})}{P (\theta_{\text{atual}})}\)</span> que equivale a proporção da probabilidade dos parâmetros propostos pela probabilidade dos parâmetros do estado atual.</li>
</ol>
<p>De qualquer maneira, a cada iteração do algoritmo de Metropolis, mesmo que a corrente muda de estado ou não, amostramos o parâmetro <span class="math inline">\(\theta\)</span> de qualquer maneira. Ou seja, se a corrente não mudar em um certo estado <span class="math inline">\(\theta\)</span> será amostrado duas vezes (ou mais caso a corrente fique estacionária no mesmo estado).</p>
<p>O algoritmo de Metropolis-Hastings pode ser descrito na seguinte maneira<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a> (<span class="math inline">\(\theta\)</span> é o parâmetro, ou conjunto de parâmetros, de interesse e <span class="math inline">\(y\)</span> são os dados):</p>
<ol type="1">
<li><p>Defina um ponto inicial <span class="math inline">\(\theta^0\)</span> do qual <span class="math inline">\(p(\theta^0|y) &gt; 0\)</span>, ou amostre-o de uma distribuição inicial <span class="math inline">\(p_0 (\theta)\)</span>. <span class="math inline">\(p_0(\theta)\)</span> pode ser uma distribuição normal ou uma distribuição prévia de <span class="math inline">\(\theta\)</span> (<span class="math inline">\(p(\theta)\)</span>).</p></li>
<li><p>Para <span class="math inline">\(t = 1, 2, \dots\)</span>:</p>
<ul>
<li><p>Amostra uma proposta <span class="math inline">\(\theta^*\)</span> de uma distribuição de propostas no tempo <span class="math inline">\(t\)</span>, <span class="math inline">\(J_t (\theta^* | \theta^{t-1})\)</span>.</p></li>
<li><p>Calcule a proporção das probabilidades:</p>
<ul>
<li><strong>Metropolis</strong>: <span class="math inline">\(r = \frac{p(\theta^* | y)}{p(\theta^{t-1} | y)}\)</span></li>
<li><strong>Metropolis-Hastings</strong>: <span class="math inline">\(r = \frac{\frac{p(\theta^* | y)}{J_t(\theta^*|\theta^{t-1})}}{\frac{p(\theta^{t-1} | y)}{J_t(\theta^{t-1}|\theta^*)}}\)</span></li>
</ul></li>
<li><p>Designe:</p>
<p><span class="math display">\[\theta^t =
  \begin{cases}
  \theta^* &amp; \text{com probabilidade $\min(r,1)$}\\
  \theta^{t-1} &amp; \text{caso contrário}
  \end{cases}\]</span></p></li>
</ul></li>
</ol>
<h4 id="limitações-do-algoritmo-de-metropolis">Limitações do Algoritmo de Metropolis</h4>
<p>As limitações do algoritmo de Metropolis-Hastings são principalmente computacionais. Com propostas geradas aleatoriamente, geralmente leva um grande número de iterações para entrar em áreas de densidade posterior mais alta (mais provável). Mesmo algoritmos de Metropolis-Hastings eficientes às vezes aceitam menos de 25% das propostas <span class="citation" data-cites="robertsWeakConvergenceOptimal1997">(<a href="#ref-robertsWeakConvergenceOptimal1997" role="doc-biblioref">Roberts, Gelman, &amp; Gilks, 1997</a>)</span>. Em situações dimensionais mais baixas, o poder computacional aumentado pode compensar a eficiência mais baixa até certo ponto. Mas em situações de modelagem de dimensões mais altas e mais complexas, computadores maiores e mais rápidos sozinhos raramente são suficientes para superar o desafio.</p>
<h4 id="metropolis-implementação">Metropolis – Implementação</h4>
<p>No nosso exemplo didático vamos partir do pressuposto que <span class="math inline">\(J_t(\theta^* | \theta^{t-1})\)</span> é simétrico à <span class="math inline">\(J_t (\theta^* | \theta^{t-1}) = J_t(\theta^{t-1}|\theta^*)\)</span>, portanto vamos apenas demonstrar o algoritmo de Metropolis (e não o algoritmo de Metropolis-Hastings).</p>
<p>O Stan <span class="citation" data-cites="carpenterStanProbabilisticProgramming2017">(<a href="#ref-carpenterStanProbabilisticProgramming2017" role="doc-biblioref">Carpenter et al., 2017</a>)</span> (e consequentemente seu ecossistema inteiro de pacotes) não tem implementações de outros algoritmos a não ser o HMC (Hamiltonean Monte Carlo), portanto abaixo criei um amostrador Metropolis para o nosso exemplo didático. No fim ele imprime a porcentagem total de aceitação das propostas. Aqui estamos usando a mesma distribuição de propostas para tanto <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>: uma distribuição uniforme parameterizada com um parâmetro largura <code>width</code>:</p>
<p><span class="math display">\[
X \sim \text{Uniforme} \left( X - \frac{\text{largura}}{2}, X + \frac{\text{largura}}{2} \right) \\
Y \sim \text{Uniforme} \left( Y - \frac{\text{largura}}{2}, Y + \frac{\text{largura}}{2} \right)
\]</span> O pacote <code>mnormt</code> possui algumas funcionalidades para lidar com distribuições multivariadas, a função <code>dmnorm()</code> em especial calcula a função densidade de probabilidade (FDP)<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> de uma distribuição normal multivariada, que é usada no cálculo proporção das probabilidades <span class="math inline">\(r\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
r &amp;= \frac{
\operatorname{FDP}\left(
\text{Normal Multivariada} \left(
\begin{bmatrix}
x_{\text{proposto}} \\
y_{\text{proposto}}
\end{bmatrix}
\right)
\Bigg|
\text{Normal Multivariada} \left(
\begin{bmatrix}
\mu_X \\
\mu_Y
\end{bmatrix}, \mathbf{\Sigma}
\right)
\right)}
{
\operatorname{FDP}\left(
\text{Normal Multivariada} \left(
\begin{bmatrix}
x_{\text{atual}} \\
y_{\text{atual}}
\end{bmatrix}
\right)
\Bigg|
\text{Normal Multivariada} \left(
\begin{bmatrix}
\mu_X \\
\mu_Y
\end{bmatrix}, \mathbf{\Sigma}
\right)
\right)}\\
&amp;=\frac{\operatorname{FDP}_{\text{proposto}}}{\operatorname{FDP}_{\text{atual}}}\\
&amp;= \exp\Big(
\log\left(\operatorname{FDP}_{\text{proposto}}\right)
-
\log\left(\operatorname{FDP}_{\text{atual}}\right)
\Big)
\end{aligned}
\]</span></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>metropolis</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>S</span>, <span class='va'>half_width</span>,
                       <span class='va'>mu_X</span> <span class='op'>=</span> <span class='fl'>0</span>, <span class='va'>mu_Y</span> <span class='op'>=</span> <span class='fl'>0</span>,
                       <span class='va'>sigma_X</span> <span class='op'>=</span> <span class='fl'>1</span>, <span class='va'>sigma_Y</span> <span class='op'>=</span> <span class='fl'>1</span>,
                       <span class='va'>rho</span>,
                       <span class='va'>start_x</span>, <span class='va'>start_y</span>,
                       <span class='va'>seed</span> <span class='op'>=</span> <span class='fl'>123</span><span class='op'>)</span> <span class='op'>{</span>
   <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='va'>seed</span><span class='op'>)</span>
   <span class='va'>Sigma</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>2</span><span class='op'>)</span>
   <span class='va'>Sigma</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>rho</span>
   <span class='va'>Sigma</span><span class='op'>[</span><span class='fl'>2</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>rho</span>
   <span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span>nrow <span class='op'>=</span> <span class='va'>S</span>, ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
   <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>start_x</span>
   <span class='va'>y</span> <span class='op'>&lt;-</span> <span class='va'>start_y</span>
   <span class='va'>accepted</span> <span class='op'>&lt;-</span> <span class='fl'>0</span>
   <span class='va'>draws</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>x</span>
   <span class='va'>draws</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>y</span>
   <span class='kw'>for</span> <span class='op'>(</span><span class='va'>s</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='va'>S</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>x_</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>x</span> <span class='op'>-</span> <span class='va'>half_width</span>, <span class='va'>x</span> <span class='op'>+</span> <span class='va'>half_width</span><span class='op'>)</span>
      <span class='va'>y_</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>y</span> <span class='op'>-</span> <span class='va'>half_width</span>, <span class='va'>y</span> <span class='op'>+</span> <span class='va'>half_width</span><span class='op'>)</span>
      <span class='va'>r</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='fu'>mnormt</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/mnormt/man/mnorm.html'>dmnorm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>x_</span>, <span class='va'>y_</span><span class='op'>)</span>, mean <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>mu_X</span>, <span class='va'>mu_Y</span><span class='op'>)</span>, varcov <span class='op'>=</span> <span class='va'>Sigma</span>, log <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>-</span>
                        <span class='fu'>mnormt</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/mnormt/man/mnorm.html'>dmnorm</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span>, mean <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>mu_X</span>, <span class='va'>mu_Y</span><span class='op'>)</span>, varcov <span class='op'>=</span> <span class='va'>Sigma</span>, log <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span>
      <span class='kw'>if</span> <span class='op'>(</span><span class='va'>r</span> <span class='op'>&gt;</span> <span class='fu'><a href='https://rdrr.io/r/stats/Uniform.html'>runif</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>x_</span>
        <span class='va'>y</span> <span class='op'>&lt;-</span> <span class='va'>y_</span>
        <span class='va'>accepted</span> <span class='op'>&lt;-</span> <span class='va'>accepted</span> <span class='op'>+</span> <span class='fl'>1</span>
      <span class='op'>}</span>
      <span class='va'>draws</span><span class='op'>[</span><span class='va'>s</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>x</span>
      <span class='va'>draws</span><span class='op'>[</span><span class='va'>s</span>, <span class='fl'>2</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>y</span>
   <span class='op'>}</span>
   <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>"Taxa de aceitação "</span>, <span class='va'>accepted</span> <span class='op'>/</span> <span class='va'>S</span><span class='op'>)</span><span class='op'>)</span>
   <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>draws</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>n_sim</span> <span class='op'>&lt;-</span> <span class='fl'>1e4</span>
</code></pre>
</div>
</div>
<p>Vamos executar nosso algoritmo Metropolis com 10,000 iterações.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>X_met</span> <span class='op'>&lt;-</span> <span class='fu'>metropolis</span><span class='op'>(</span>
  S <span class='op'>=</span> <span class='va'>n_sim</span>, half_width <span class='op'>=</span> <span class='fl'>2.75</span>,
  mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
  sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
  rho <span class='op'>=</span> <span class='va'>r</span>,
  start_x <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='fl'>2.5</span>
<span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;Taxa de aceitação 0.2076&quot;</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='va'>X_met</span>, <span class='fl'>7</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>      [,1] [,2]
[1,] -2.50  2.5
[2,] -2.50  2.5
[3,] -2.50  2.5
[4,] -2.50  2.5
[5,] -2.50  2.5
[6,] -1.52  2.9
[7,]  0.68  1.5</code></pre>
</div>
<p>Na nossa primeira execução do algoritmo Metropolis temos como resultado uma matriz <code>X_met</code> com 10,000 linhas e 2 colunas (uma para cada valor de <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>, que passarei a chamar de <span class="math inline">\(\theta_1\)</span> e <span class="math inline">\(\theta_2\)</span>, respectivamente). Vejam que a aceitação das propostas ficou em 20.8%, o esperado para algoritmos Metropolis (em torno de 20-25%) <span class="citation" data-cites="robertsWeakConvergenceOptimal1997">(<a href="#ref-robertsWeakConvergenceOptimal1997" role="doc-biblioref">Roberts et al., 1997</a>)</span>.</p>
<p>Para métricas de convergência e desempenho vamos usar a função <code>rstan::monitor()</code> que simula um <code>print(stanfit)</code><a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>mas para matrizes.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://mc-stan.org/rstan/reference/monitor.html'>monitor</a></span><span class='op'>(</span><span class='va'>X_met</span>, digits_summary <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Inference for the input samples (2 chains: each with iter = 10000; warmup = 5000):

     Q5 Q50 Q95 Mean SD  Rhat Bulk_ESS Tail_ESS
V1 -1.6   0 1.7    0  1     1      952      909

For each parameter, Bulk_ESS and Tail_ESS are crude measures of 
effective sample size for bulk and tail quantities respectively (an ESS &gt; 100 
per chain is considered good), and Rhat is the potential scale reduction 
factor on rank normalized split chains (at convergence, Rhat &lt;= 1.05).</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>neff</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>[</span>, <span class='st'>"n_eff"</span><span class='op'>]</span>
<span class='va'>reff</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>neff</span> <span class='op'>/</span> <span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_met</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='co'>#  9.5%</span>
</code></pre>
</div>
</div>
<p>Vejam que o número de amostras eficientes em relação ao número total de iterações <code>reff</code> é 9,5% para todas as iterações incluindo <em>warm-up</em>.</p>
<h5 id="metropolis-intuição-visual">Metropolis – Intuição Visual</h5>
<p>Eu acredito que uma boa intuição visual, mesmo que você não tenha entendido nenhuma fórmula matemática, é a chave para você começar a jornada de aprendizagem. Portanto fiz algumas animações com GIFs.</p>
<p>A animação na figura <a href="#fig:metropolis-gif">6</a> mostra as 100 primeiras simulações do algoritmo Metropolis usado para gerar <code>X_met</code>. Vejam que em diversas iterações a proposta é recusada e o algoritmo amostra os parâmetros <span class="math inline">\(\theta_1\)</span> e <span class="math inline">\(\theta_2\)</span> do estado anterior (que se torna o atual, pois a proposta é recusada).</p>
<p>Observação: <code>HPD</code> é a sigla para <em>Highest Probability Density</em> (que é o intervalo de 90% de probabilidade da posterior).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df100</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
    id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>100</span><span class='op'>)</span>,
    iter <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span>,
    th1 <span class='op'>=</span> <span class='va'>X_met</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span>, <span class='fl'>1</span><span class='op'>]</span>,
    th2 <span class='op'>=</span> <span class='va'>X_met</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span>, <span class='fl'>2</span><span class='op'>]</span>,
    th1l <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>X_met</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>X_met</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fl'>100</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,
    th2l <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>X_met</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span>, <span class='va'>X_met</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fl'>100</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='va'>labs1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Amostras"</span>, <span class='st'>"Iterações do Algoritmo"</span>, <span class='st'>"90% HPD"</span><span class='op'>)</span>

<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_jitter.html'>geom_jitter</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df100</span>, width <span class='op'>=</span> <span class='fl'>0.05</span>, height <span class='op'>=</span> <span class='fl'>0.05</span>,
             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, group <span class='op'>=</span> <span class='va'>id</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_segment.html'>geom_segment</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df100</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>th1</span>, xend <span class='op'>=</span> <span class='va'>th1l</span>, color <span class='op'>=</span> <span class='st'>"2"</span>,
                                 y <span class='op'>=</span> <span class='va'>th2</span>, yend <span class='op'>=</span> <span class='va'>th2l</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"3"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Metropolis"</span>, subtitle <span class='op'>=</span> <span class='st'>"100 Amostragens Iniciais"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"red"</span>, <span class='st'>"forestgreen"</span>, <span class='st'>"blue"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs1</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span>, <span class='cn'>NA</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>p1</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/transition_reveal.html'>transition_reveal</a></span><span class='op'>(</span>along <span class='op'>=</span> <span class='va'>iter</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/shadow_trail.html'>shadow_trail</a></span><span class='op'>(</span><span class='fl'>0.01</span><span class='op'>)</span>,
  <span class='co'># animation options</span>
  height <span class='op'>=</span> <span class='fl'>7</span>, width <span class='op'>=</span> <span class='fl'>7</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>300</span>
<span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:metropolis-gif"></span>
<img src="5-MCMC_files/figure-html5/metropolis-gif-1.gif" alt="Animação Metropolis"  />
<p class="caption">
Figure 6: Animação Metropolis
</p>
</div>
</div>
<p>Na figura <a href="#fig:metropolis-first1000">7</a> é possível ver como ficaram as primeiras 1.000 simulações excluindo 1.000 iterações iniciais como <em>warmup</em>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Take all the 10,000 observations after warmup of 1,000</span>
<span class='va'>warm</span> <span class='op'>&lt;-</span> <span class='fl'>1e3</span>
<span class='va'>dfs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
  th1 <span class='op'>=</span> <span class='va'>X_met</span><span class='op'>[</span><span class='op'>(</span><span class='va'>warm</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_met</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>]</span>,
  th2 <span class='op'>=</span> <span class='va'>X_met</span><span class='op'>[</span><span class='op'>(</span><span class='va'>warm</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_met</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>]</span>
<span class='op'>)</span>

<span class='va'>labs2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Amostras"</span>, <span class='st'>"90% HPD"</span><span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dfs</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1000</span>, <span class='op'>]</span>,
             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"2"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Metropolis"</span>, subtitle <span class='op'>=</span> <span class='st'>"1.000 Amostragens Iniciais"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"steelblue"</span>, <span class='st'>"blue"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:metropolis-first1000"></span>
<img src="5-MCMC_files/figure-html5/metropolis-first1000-1.png" alt="Primeiras 1.000 simulações Metropolis após descarte de 1.000 iterações como *warmup*" width="624" />
<p class="caption">
Figure 7: Primeiras 1.000 simulações Metropolis após descarte de 1.000 iterações como <em>warmup</em>
</p>
</div>
</div>
<p>E na figura <a href="#fig:metropolis-all">8</a> é possível ver as restantes 9.000 simulações excluindo 1.000 iterações iniciais como <em>warmup</em>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Show all 10,000 samples</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dfs</span>,
             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"2"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Metropolis"</span>, subtitle <span class='op'>=</span> <span class='st'>"10.000 Amostragens"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"steelblue"</span>, <span class='st'>"blue"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:metropolis-all"></span>
<img src="5-MCMC_files/figure-html5/metropolis-all-1.png" alt="9.000 simulações Metropolis após descarte de 1.000 iterações como *warmup*" width="624" />
<p class="caption">
Figure 8: 9.000 simulações Metropolis após descarte de 1.000 iterações como <em>warmup</em>
</p>
</div>
</div>
<h3 id="gibbs">Gibbs</h3>
<p>Para contornar o problema de baixa taxa de aceitação do algoritmo de Metropolis (e Metropolis-Hastings) foi desenvolvido o algoritmo de Gibbs que não possui uma regra de aceitação/rejeição para a mudança de estado da corrente Markov. <strong>Todas as propostas são aceitas</strong>.</p>
<p>O algoritmo de Gibbs teve ideia original concebida pelo físico Josiah Willard Gibbs (figura <a href="#fig:gibbs-geman">9</a>), em referência a uma analogia entre um algoritmo de amostragem e a física estatística (<em>statistical physics</em> um ramo da física que tem sua base em mecânica estatística <em>statistical mechanics</em>). O algoritmo foi descrito pelos irmãos Stuart e Donald Geman (figura <a href="#fig:gibbs-geman">9</a>) em 1984 <span class="citation" data-cites="gemanStochasticRelaxationGibbs1984">(<a href="#ref-gemanStochasticRelaxationGibbs1984" role="doc-biblioref">Geman &amp; Geman, 1984</a>)</span>, cerca de oito décadas após a morte de Gibbs.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure"><span id="fig:gibbs-geman"></span>
<img src="5-MCMC_files/figure-html5/gibbs-geman-1.png" alt="Da esquerda para direita: Josiah Gibbs,Stuart Geman e Donald Geman -- Figuras de https://www.wikipedia.org" width="20%" class=external />
<p class="caption">
Figure 9: Da esquerda para direita: Josiah Gibbs,Stuart Geman e Donald Geman – Figuras de <a href="https://www.wikipedia.org" class="uri">https://www.wikipedia.org</a>
</p>
</div>
</div>
<p>O algoritmo de Gibbs é muito útil em espaços amostrais multidimensionais (no qual há bem mais que 2 parâmetros a serem amostrados da probabilidade posterior). Também é conhecido como <strong>amostragem condicional alternativa</strong> (<em>alternating conditional sampling</em>), pois amostramos sempre um parâmetro <strong>condicionado</strong> à probabilidade dos outros parâmetros do modelo.</p>
<p>O algoritmo de Gibbs pode ser visto como um <strong>caso especial</strong> do algoritmo de Metropolis-Hastings porque todas as propostas são aceitas <span class="citation" data-cites="gelmanIterativeNonIterativeSimulation1992">(<a href="#ref-gelmanIterativeNonIterativeSimulation1992" role="doc-biblioref">Gelman, 1992</a>)</span>.</p>
<h4 id="algoritmo-de-gibbs">Algoritmo de Gibbs</h4>
<p>A essência do algoritmo de Gibbs é a amostragem de parâmetros condicionada à outros parâmetros <span class="math inline">\(P(\theta_1 | \theta_2, \dots \theta_n)\)</span>.</p>
<p>O algoritmo de Gibbs pode ser descrito na seguinte maneira<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a> (<span class="math inline">\(\theta\)</span> é o parâmetro, ou conjunto de parâmetros, de interesse e <span class="math inline">\(y\)</span> são os dados):</p>
<ol type="1">
<li><p>Defina <span class="math inline">\(p(\theta_1), p(\theta_2), \dots, p(\theta_n)\)</span>: a probabilidade prévia (<em>prior</em>) de cada um dos parâmetros <span class="math inline">\(\theta_n\)</span>.</p></li>
<li><p>Amostre um ponto inicial <span class="math inline">\(\theta^0_1, \theta^0_2, \dots, \theta^0_n\)</span>. Geralmente amostramos de uma distribuição normal ou de uma distribuição especificada como a distribuição prévia (<em>prior</em>) de <span class="math inline">\(\theta_n\)</span>.</p></li>
<li><p>Para <span class="math inline">\(t = 1,2,\dots\)</span>:</p>
<p><span class="math display">\[\begin{aligned}
 \theta^t_1 &amp;\sim p(\theta_1 | \theta^0_2, \dots, \theta^0_n) \\
 \theta^t_2 &amp;\sim p(\theta_2 | \theta^{t-1}_1, \dots, \theta^0_n) \\
 &amp;\vdots \\
 \theta^t_n &amp;\sim p(\theta_n | \theta^{t-1}_1, \dots, \theta^{t-1}_{n-1})
 \end{aligned}\]</span></p></li>
</ol>
<h4 id="limitações-do-algoritmo-de-gibbs">Limitações do Algoritmo de Gibbs</h4>
<p>A principal limitação do algoritmo de Gibbs é com relação a amostragem condicional alternativa.</p>
<p>Se compararmos com o algoritmo Metropolis (e consequentemente Metropolis-Hastings) temos propostas aleatórias de uma distribuição de propostas na qual amostramos cada parâmetro incondicionalmente à outros parâmetros. Para que as propostas nos levem a locais corretos da probabilidade posterior para amostrarmos temos uma regra de aceitação/rejeição dessas propostas, se não as amostras do algoritmo de Metropolis não se aproximariam à distribuição-alvo de interesse. As mudanças de estado da corrente Markov são então executadas multidimensionalmente<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. Como você viu nas figuras <a href="#fig:metropolis-gif">6</a>, <a href="#fig:metropolis-first1000">7</a> e <a href="#fig:metropolis-all">8</a> de intuição visual do algoritmo de Metropolis, em um espaço 2-D (como é o nosso exemplo didático bivariado normal), quando há uma mudança de estado na corrente Markov, o novo local de proposta considera tanto <span class="math inline">\(\theta_1\)</span> quanto <span class="math inline">\(\theta_2\)</span>, provocando uma movimentação na <strong>diagonal</strong> no espaço amostral 2-D.</p>
<p>No caso do algoritmo de Gibbs, no nosso exemplo, essa movimentação se dá apenas em um único parâmetro, pois amostramos sequencialmente e condicionalmente à outros parâmetros. Isto provoca movimentos <strong>horizontais</strong> (no caso de <span class="math inline">\(\theta_1\)</span>) e movimentos <strong>verticais</strong> (no caso de <span class="math inline">\(\theta_2\)</span>), mas nunca movimentos diagonais como o que vemos no algoritmo de Metropolis.</p>
<h4 id="gibbs-implementação">Gibbs – Implementação</h4>
<p>O Stan <span class="citation" data-cites="carpenterStanProbabilisticProgramming2017">(<a href="#ref-carpenterStanProbabilisticProgramming2017" role="doc-biblioref">Carpenter et al., 2017</a>)</span> (e consequentemente seu ecossistema inteiro de pacotes) não tem implementações de outros algoritmos a não ser o HMC (Hamiltonian Monte Carlo), portanto abaixo criei um amostrador Gibbs para o nosso exemplo didático.</p>
<p>Aqui temos algumas coisas novas comparando com a implementação do amostrador Metropolis. Primeiro para amostrar condicionalmente os parâmetros <span class="math inline">\(P(\theta_1 | \theta_2)\)</span> e <span class="math inline">\(P(\theta_2 | \theta_1)\)</span>, precisamos criar duas variáveis novas <code>beta</code> (<span class="math inline">\(\beta\)</span>) e <code>lambda</code> (<span class="math inline">\(\lambda\)</span>). Essas variáveis representam a correlação entre <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span> (<span class="math inline">\(\theta_1\)</span> e <span class="math inline">\(\theta_2\)</span> respectivamente). E então usamos essas variáveis na amostragem de <span class="math inline">\(\theta_1\)</span> e <span class="math inline">\(\theta_2\)</span>:</p>
<p><span class="math display">\[
\begin{aligned}
\beta &amp;= \rho \cdot \frac{\sigma_Y}{\sigma_X} = \rho \\
\lambda &amp;= \rho \cdot \frac{\sigma_X}{\sigma_Y} = \rho \\
\sigma_{YX} &amp;= 1 - \rho^2\\
\sigma_{XY} &amp;= 1 - \rho^2\\
\theta_1 &amp;\sim \text{Normal} \bigg( \mu_X + \lambda \cdot (y^* - \mu_Y), \sigma_{XY} \bigg) \\
\theta_2 &amp;\sim \text{Normal} \bigg( \mu_y + \beta \cdot (x^* - \mu_X), \sigma_{YX} \bigg).
\end{aligned}
\]</span></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>gibbs</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>S</span>,
                  <span class='va'>mu_X</span> <span class='op'>=</span> <span class='fl'>0</span>, <span class='va'>mu_Y</span> <span class='op'>=</span> <span class='fl'>0</span>,
                  <span class='va'>sigma_X</span> <span class='op'>=</span> <span class='fl'>1</span>, <span class='va'>sigma_Y</span> <span class='op'>=</span> <span class='fl'>1</span>,
                  <span class='va'>rho</span>,
                  <span class='va'>start_x</span>, <span class='va'>start_y</span>,
                  <span class='va'>seed</span> <span class='op'>=</span> <span class='fl'>123</span><span class='op'>)</span> <span class='op'>{</span>
   <span class='fu'><a href='https://rdrr.io/r/base/Random.html'>set.seed</a></span><span class='op'>(</span><span class='va'>seed</span><span class='op'>)</span>
   <span class='va'>Sigma</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/diag.html'>diag</a></span><span class='op'>(</span><span class='fl'>2</span><span class='op'>)</span>
   <span class='va'>Sigma</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>rho</span>
   <span class='va'>Sigma</span><span class='op'>[</span><span class='fl'>2</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>rho</span>
   <span class='va'>draws</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>matrix</a></span><span class='op'>(</span>nrow <span class='op'>=</span> <span class='va'>S</span>, ncol <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>
   <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='va'>start_x</span>
   <span class='va'>y</span> <span class='op'>&lt;-</span> <span class='va'>start_y</span>
   <span class='va'>beta</span> <span class='op'>&lt;-</span> <span class='va'>rho</span> <span class='op'>*</span> <span class='va'>sigma_Y</span> <span class='op'>/</span> <span class='va'>sigma_X</span>
   <span class='va'>lambda</span> <span class='op'>&lt;-</span> <span class='va'>rho</span> <span class='op'>*</span> <span class='va'>sigma_X</span> <span class='op'>/</span> <span class='va'>sigma_Y</span>
   <span class='va'>sqrt1mrho2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fl'>1</span> <span class='op'>-</span> <span class='va'>rho</span><span class='op'>^</span><span class='fl'>2</span><span class='op'>)</span>
   <span class='va'>sigma_YX</span> <span class='op'>&lt;-</span> <span class='va'>sigma_Y</span> <span class='op'>*</span> <span class='va'>sqrt1mrho2</span>
   <span class='va'>sigma_XY</span> <span class='op'>&lt;-</span> <span class='va'>sigma_X</span> <span class='op'>*</span> <span class='va'>sqrt1mrho2</span>
   <span class='va'>draws</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>x</span>
   <span class='va'>draws</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>y</span>
   <span class='kw'>for</span> <span class='op'>(</span><span class='va'>s</span> <span class='kw'>in</span> <span class='fl'>2</span><span class='op'>:</span><span class='va'>S</span><span class='op'>)</span> <span class='op'>{</span>
     <span class='kw'>if</span> <span class='op'>(</span><span class='va'>s</span> <span class='op'>%%</span> <span class='fl'>2</span> <span class='op'>==</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>{</span>
        <span class='va'>y</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>mu_Y</span> <span class='op'>+</span> <span class='va'>beta</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>x</span> <span class='op'>-</span> <span class='va'>mu_X</span><span class='op'>)</span>, <span class='va'>sigma_YX</span><span class='op'>)</span>
     <span class='op'>}</span>
     <span class='kw'>else</span> <span class='op'>{</span>
        <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='va'>mu_X</span> <span class='op'>+</span> <span class='va'>lambda</span> <span class='op'>*</span> <span class='op'>(</span><span class='va'>y</span> <span class='op'>-</span> <span class='va'>mu_Y</span><span class='op'>)</span>, <span class='va'>sigma_XY</span><span class='op'>)</span>
     <span class='op'>}</span>
     <span class='va'>draws</span><span class='op'>[</span><span class='va'>s</span>, <span class='fl'>1</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>x</span>
     <span class='va'>draws</span><span class='op'>[</span><span class='va'>s</span>, <span class='fl'>2</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>y</span>
   <span class='op'>}</span>
   <span class='kw'><a href='https://rdrr.io/r/base/function.html'>return</a></span><span class='op'>(</span><span class='va'>draws</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<p>Vamos executar nosso algoritmo Gibbs com 10,000 iterações.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>X_gibbs</span> <span class='op'>&lt;-</span> <span class='fu'>gibbs</span><span class='op'>(</span>
  S <span class='op'>=</span> <span class='va'>n_sim</span>,
  mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
  sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
  rho <span class='op'>=</span> <span class='va'>r</span>,
  start_x <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='fl'>2.5</span>
<span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='va'>X_gibbs</span>, <span class='fl'>7</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>      [,1]  [,2]
[1,] -2.50  2.50
[2,] -2.50 -2.34
[3,] -2.01 -2.34
[4,] -2.01 -0.67
[5,] -0.49 -0.67
[6,] -0.49 -0.32
[7,]  0.77 -0.32</code></pre>
</div>
<p>Na nossa primeira execução do algoritmo Gibbs temos como resultado uma matriz <code>X_gibbs</code> com 10,000 linhas e 2 colunas (as mesmas condições já mostradas no exemplo anterior com algoritmo Metropolis).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://mc-stan.org/rstan/reference/monitor.html'>monitor</a></span><span class='op'>(</span><span class='va'>X_gibbs</span>, digits_summary <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Inference for the input samples (2 chains: each with iter = 10000; warmup = 5000):

     Q5 Q50 Q95 Mean SD  Rhat Bulk_ESS Tail_ESS
V1 -1.7   0 1.6    0  1     1     1156     1972

For each parameter, Bulk_ESS and Tail_ESS are crude measures of 
effective sample size for bulk and tail quantities respectively (an ESS &gt; 100 
per chain is considered good), and Rhat is the potential scale reduction 
factor on rank normalized split chains (at convergence, Rhat &lt;= 1.05).</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>neff</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>[</span>, <span class='st'>"n_eff"</span><span class='op'>]</span>
<span class='va'>reff</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>neff</span> <span class='op'>/</span> <span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_gibbs</span><span class='op'>)</span> <span class='op'>/</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span> <span class='co'>#  23.2%</span>
</code></pre>
</div>
</div>
<p>Vejam que o número de amostras eficientes em relação ao número total de iterações <code>reff</code><a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a> é 23% para todas as iterações incluindo <em>warm-up</em>. A eficiência do algoritmo Gibbs, no nosso exemplo didático, é o mais que dobro da eficiência do algoritmo de Metropolis (9,5% vs 23%).</p>
<h5 id="gibbs-intuição-visual">Gibbs – Intuição Visual</h5>
<p>A animação na figura <a href="#fig:gibbs-gif">10</a> mostra as 100 primeiras simulações do algoritmo Gibbs usado para gerar <code>X_gibbs</code>. Vejam que aqui não há movimentação na diagonal no espaço amostral devido à amostragem condicional alternativa dos parâmetros <span class="math inline">\(\theta_1\)</span> e <span class="math inline">\(\theta_2\)</span>. A movimentação do algoritmo Gibbs no espaço amostral está condicionada a apenas um movimento por dimensão de parâmetro (que no nosso exemplo didático 2-D são as dimensões horizontais <span class="math inline">\(\theta_1\)</span> e verticais <span class="math inline">\(\theta_2\)</span>).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df100</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
    id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>100</span><span class='op'>)</span>,
    iter <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span>,
    th1 <span class='op'>=</span> <span class='va'>X_gibbs</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span>, <span class='fl'>1</span><span class='op'>]</span>,
    th2 <span class='op'>=</span> <span class='va'>X_gibbs</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>100</span>, <span class='fl'>2</span><span class='op'>]</span>,
    th1l <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>X_gibbs</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>X_gibbs</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fl'>100</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,
    th2l <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>X_gibbs</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span>, <span class='va'>X_gibbs</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fl'>100</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='va'>labs1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Amostras"</span>, <span class='st'>"Iterações do Algoritmo"</span>, <span class='st'>"90% HPD"</span><span class='op'>)</span>

<span class='va'>ind1</span> <span class='op'>&lt;-</span> <span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>50</span><span class='op'>)</span> <span class='op'>*</span> <span class='fl'>2</span> <span class='op'>-</span> <span class='fl'>1</span>
<span class='va'>df100s</span> <span class='op'>&lt;-</span> <span class='va'>df100</span>
<span class='va'>df100s</span><span class='op'>[</span><span class='va'>ind1</span> <span class='op'>+</span> <span class='fl'>1</span>, <span class='fl'>3</span><span class='op'>:</span><span class='fl'>4</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>df100s</span><span class='op'>[</span><span class='va'>ind1</span>, <span class='fl'>3</span><span class='op'>:</span><span class='fl'>4</span><span class='op'>]</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df100s</span>,
             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, group <span class='op'>=</span> <span class='va'>id</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_segment.html'>geom_segment</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df100</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>th1</span>, xend <span class='op'>=</span> <span class='va'>th1l</span>, color <span class='op'>=</span> <span class='st'>"2"</span>,
                                 y <span class='op'>=</span> <span class='va'>th2</span>, yend <span class='op'>=</span> <span class='va'>th2l</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"3"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Gibbs"</span>, subtitle <span class='op'>=</span> <span class='st'>"100 Amostragens Iniciais"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"red"</span>, <span class='st'>"forestgreen"</span>, <span class='st'>"blue"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs1</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span>, <span class='cn'>NA</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>p1</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/transition_reveal.html'>transition_reveal</a></span><span class='op'>(</span>along <span class='op'>=</span> <span class='va'>iter</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/shadow_trail.html'>shadow_trail</a></span><span class='op'>(</span><span class='fl'>0.01</span><span class='op'>)</span>,
  <span class='co'># animation options</span>
  height <span class='op'>=</span> <span class='fl'>7</span>, width <span class='op'>=</span> <span class='fl'>7</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>300</span>
<span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:gibbs-gif"></span>
<img src="5-MCMC_files/figure-html5/gibbs-gif-1.gif" alt="Animação Gibbs"  />
<p class="caption">
Figure 10: Animação Gibbs
</p>
</div>
</div>
<p>Na figura <a href="#fig:gibbs-first1000">11</a> é possível ver como ficaram as primeiras 1.000 simulações excluindo 1.000 iterações iniciais como <em>warmup</em>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Take all the 10,000 observations after warmup of 1,000</span>
<span class='va'>warm</span> <span class='op'>&lt;-</span> <span class='fl'>1e3</span>
<span class='va'>dfs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
  th1 <span class='op'>=</span> <span class='va'>X_gibbs</span><span class='op'>[</span><span class='op'>(</span><span class='va'>warm</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_gibbs</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>]</span>,
  th2 <span class='op'>=</span> <span class='va'>X_gibbs</span><span class='op'>[</span><span class='op'>(</span><span class='va'>warm</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_gibbs</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>]</span>
<span class='op'>)</span>

<span class='va'>labs2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Amostras"</span>, <span class='st'>"90% HPD"</span><span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dfs</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1000</span>, <span class='op'>]</span>,
             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"2"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Gibbs"</span>, subtitle <span class='op'>=</span> <span class='st'>"1.000 Amostragens Iniciais"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"steelblue"</span>, <span class='st'>"blue"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:gibbs-first1000"></span>
<img src="5-MCMC_files/figure-html5/gibbs-first1000-1.png" alt="Primeiras 1.000 simulações Gibbs após descarte de 1.000 iterações como *warmup*" width="624" />
<p class="caption">
Figure 11: Primeiras 1.000 simulações Gibbs após descarte de 1.000 iterações como <em>warmup</em>
</p>
</div>
</div>
<p>E na figura <a href="#fig:gibbs-all">12</a> é possível ver as restantes 9.000 simulações excluindo 1.000 iterações iniciais como <em>warmup</em>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Show all 10,000 samples</span>
<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dfs</span>,
             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"2"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Gibbs"</span>, subtitle <span class='op'>=</span> <span class='st'>"10.000 Amostragens"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"steelblue"</span>, <span class='st'>"blue"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:gibbs-all"></span>
<img src="5-MCMC_files/figure-html5/gibbs-all-1.png" alt="9.000 simulações Gibbs após descarte de 1.000 iterações como *warmup*" width="624" />
<p class="caption">
Figure 12: 9.000 simulações Gibbs após descarte de 1.000 iterações como <em>warmup</em>
</p>
</div>
</div>
<h3 id="o-que-acontece-quando-rodamos-correntes-markov-em-paralelo">O que acontece quando rodamos correntes Markov em paralelo?</h3>
<p>Como as correntes Markov são <strong>independentes</strong>, podemos executá-las em <strong>paralelo</strong> no computador. A chave para isso é <strong>definir pontos iniciais diferentes de cada corrente Markov</strong> (caso você use como ponto inicial uma amostra de uma distribuição prévia dos parâmetros isto não é um problema). Vamos usar o mesmo exemplo didático de uma distribuição normal bivariada <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span> que usamos nos exemplos anteriores, mas agora com <strong>4 correntes Markov com diferentes pontos de início</strong>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>starts</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>2.5</span>, <span class='fl'>2.5</span><span class='op'>)</span>,
               <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2.5</span>, <span class='op'>-</span><span class='fl'>2.5</span><span class='op'>)</span>,
               <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>2.5</span>, <span class='op'>-</span><span class='fl'>2.5</span><span class='op'>)</span>,
               <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>2.5</span>, <span class='fl'>2.5</span><span class='op'>)</span>
               <span class='op'>)</span>
</code></pre>
</div>
</div>
<h4 id="correntes-markov-em-paralelo-metropolis">Correntes Markov em Paralelo – Metropolis</h4>
<p>Para criar 4 correntes Markov com pontos diferentes de início dos parâmetros, usamos 4 vezes o amostrador Metropolis que codificamos anterior, mas agora passamos diferentes argumentos <code>start_x</code> e <code>start_y</code>, além de diferentes <code>seed</code> do pseudogerador de número aleatórios para termos diferentes comportamentos das correntes Markov. Todo o resultado é combinado em um <em>dataframe</em> com uma coluna <code>id</code> representando o número de cada corrente (de 1 a 4).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
<span class='va'>n_sim</span> <span class='op'>&lt;-</span> <span class='fl'>100</span>
<span class='va'>Xs_met</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_rows</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>metropolis</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>, half_width <span class='op'>=</span> <span class='fl'>2.75</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>,
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>metropolis</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>, half_width <span class='op'>=</span> <span class='fl'>2.75</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>,
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>metropolis</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>, half_width <span class='op'>=</span> <span class='fl'>2.75</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span>,
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>metropolis</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>, half_width <span class='op'>=</span> <span class='fl'>2.75</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span><span class='op'>)</span>,
  .id <span class='op'>=</span> <span class='st'>"chain"</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>[1] &quot;Taxa de aceitação 0.28&quot;
[1] &quot;Taxa de aceitação 0.19&quot;
[1] &quot;Taxa de aceitação 0.29&quot;
[1] &quot;Taxa de aceitação 0.15&quot;</code></pre>
</div>
<p>Vejam que aqui não estamos interessados em muitas iterações, portanto cada corrente Markov amostrará 100 amostras dando um total de 400 amostras.</p>
<p>Houveram algumas mudanças significativas na taxa de aprovação das propostas Metropolis. Todas ficaram em torno de 15%-29%, isso é por conta do baixo número de amostras (100), caso as amostras fosse maiores veremos esses valores convergirem para próximo de 20% conforme o exemplo anterior de 10.000 amostras com uma única corrente. errores Na figura <a href="#fig:metropolismulti-gif">13</a> é possível ver as 4 correntes Markov do algoritmo de Metropolis explorando o espaço amostral.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>dfs100_met</span> <span class='op'>&lt;-</span> <span class='va'>Xs_met</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>chain</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='va'>chain</span>,
    iter <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_sim</span>,
    th1 <span class='op'>=</span> <span class='va'>V1</span>,
    th2 <span class='op'>=</span> <span class='va'>V2</span>,
    th1l <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/lead-lag.html'>lag</a></span><span class='op'>(</span><span class='va'>V1</span>, default <span class='op'>=</span> <span class='va'>V1</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,
    th2l <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/lead-lag.html'>lag</a></span><span class='op'>(</span><span class='va'>V2</span>, default <span class='op'>=</span> <span class='va'>V2</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>dfs100_met</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_jitter.html'>geom_jitter</a></span><span class='op'>(</span>width <span class='op'>=</span> <span class='fl'>0.05</span>, height <span class='op'>=</span> <span class='fl'>0.05</span>,
              <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, group <span class='op'>=</span> <span class='va'>chain</span>, color <span class='op'>=</span> <span class='va'>chain</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_segment.html'>geom_segment</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>th1</span>, xend <span class='op'>=</span> <span class='va'>th1l</span>, y <span class='op'>=</span> <span class='va'>th2</span>, yend <span class='op'>=</span> <span class='va'>th2l</span>,
                   color <span class='op'>=</span> <span class='va'>chain</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='co'>#geom_point(aes(x = th1, y = th2, color = chain)) +</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"black"</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Metropolis"</span>,subtitle <span class='op'>=</span> <span class='st'>"100 Amostragens Iniciais"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_brewer.html'>scale_color_brewer</a></span><span class='op'>(</span>palette <span class='op'>=</span> <span class='st'>"Set1"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"NULL"</span><span class='op'>)</span>

<span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>p1</span> <span class='op'>+</span>
          <span class='fu'><a href='https://gganimate.com/reference/transition_reveal.html'>transition_reveal</a></span><span class='op'>(</span>along <span class='op'>=</span> <span class='va'>iter</span><span class='op'>)</span> <span class='op'>+</span>
          <span class='fu'><a href='https://gganimate.com/reference/shadow_trail.html'>shadow_trail</a></span><span class='op'>(</span><span class='fl'>0.01</span><span class='op'>)</span>,
        <span class='co'># animation options</span>
        height <span class='op'>=</span> <span class='fl'>7</span>, width <span class='op'>=</span> <span class='fl'>7</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>300</span>
<span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:metropolismulti-gif"></span>
<img src="5-MCMC_files/figure-html5/metropolismulti-gif-1.gif" alt="Animação Metropolis -- 4 correntes Markov em Paralelo"  />
<p class="caption">
Figure 13: Animação Metropolis – 4 correntes Markov em Paralelo
</p>
</div>
</div>
<h4 id="correntes-markov-em-paralelo-gibbs">Correntes Markov em Paralelo – Gibbs</h4>
<p>Similar ao exemplo das correntes Markov em paralelo com o algoritmo Metropoli, para criarmos 4 correntes Markov com pontos diferentes de início dos parâmetros, usamos 4 vezes o amostrador Gibbs que codificamos anterior, mas agora passamos diferentes argumentos <code>start_x</code> e <code>start_y</code>, além de diferentes <code>seed</code> do pseudogerador de número aleatórios para termos diferentes comportamentos das correntes Markov. Todo o resultado é combinado em um <em>dataframe</em> com uma coluna <code>id</code> representando o número de cada corrente (de 1 a 4).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>Xs_gibbs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_rows</a></span><span class='op'>(</span>
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>gibbs</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>,
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>gibbs</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>,
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>gibbs</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='op'>-</span><span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span>,
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='fu'>gibbs</span><span class='op'>(</span>S <span class='op'>=</span> <span class='va'>n_sim</span>,
                       mu_X <span class='op'>=</span> <span class='fl'>0</span>, mu_Y <span class='op'>=</span> <span class='fl'>0</span>,
                       sigma_X <span class='op'>=</span> <span class='fl'>1</span>, sigma_Y <span class='op'>=</span> <span class='fl'>1</span>,
                       rho <span class='op'>=</span> <span class='va'>r</span>,
                       start_x <span class='op'>=</span> <span class='fl'>2.5</span>, start_y <span class='op'>=</span> <span class='fl'>2.5</span>,
                       seed <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span><span class='op'>)</span>,
  .id <span class='op'>=</span> <span class='st'>"chain"</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Vejam que aqui não estamos interessados em muitas iterações, portanto cada corrente Markov amostrará 100 amostras dando um total de 400 amostras.</p>
<p>Na figura <a href="#fig:gibbsmulti-gif">14</a> é possível ver as 4 correntes Markov do algoritmo de Gibbs explorando o espaço amostral.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>dfs100_gibbs</span> <span class='op'>&lt;-</span> <span class='va'>Xs_gibbs</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>group_by</a></span><span class='op'>(</span><span class='va'>chain</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>transmute</a></span><span class='op'>(</span>
    <span class='va'>chain</span>,
    iter <span class='op'>=</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>n_sim</span>,
    th1 <span class='op'>=</span> <span class='va'>V1</span>,
    th2 <span class='op'>=</span> <span class='va'>V2</span>,
    th1l <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/lead-lag.html'>lag</a></span><span class='op'>(</span><span class='va'>V1</span>, default <span class='op'>=</span> <span class='va'>V1</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,
    th2l <span class='op'>=</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/lead-lag.html'>lag</a></span><span class='op'>(</span><span class='va'>V2</span>, default <span class='op'>=</span> <span class='va'>V2</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>dfs100_gibbs</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>th1</span>, y <span class='op'>=</span> <span class='va'>th2</span>, group <span class='op'>=</span> <span class='va'>chain</span>, color <span class='op'>=</span> <span class='va'>chain</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_segment.html'>geom_segment</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>th1</span>, xend <span class='op'>=</span> <span class='va'>th1l</span>, y <span class='op'>=</span> <span class='va'>th2</span>, yend <span class='op'>=</span> <span class='va'>th2l</span>,
                   color <span class='op'>=</span> <span class='va'>chain</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span><span class='op'>)</span>, color <span class='op'>=</span> <span class='st'>"black"</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"Gibbs"</span>, subtitle <span class='op'>=</span> <span class='st'>"100 Amostragens Iniciais"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_brewer.html'>scale_color_brewer</a></span><span class='op'>(</span>palette <span class='op'>=</span> <span class='st'>"Set1"</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"NULL"</span><span class='op'>)</span>

<span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>p1</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/transition_reveal.html'>transition_reveal</a></span><span class='op'>(</span>along <span class='op'>=</span> <span class='va'>iter</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/shadow_trail.html'>shadow_trail</a></span><span class='op'>(</span><span class='fl'>0.01</span><span class='op'>)</span>,
  <span class='co'># animation options</span>
  height <span class='op'>=</span> <span class='fl'>7</span>, width <span class='op'>=</span> <span class='fl'>7</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>300</span>
<span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:gibbsmulti-gif"></span>
<img src="5-MCMC_files/figure-html5/gibbsmulti-gif-1.gif" alt="Animação Gibbs -- 4 correntes Markov em Paralelo"  />
<p class="caption">
Figure 14: Animação Gibbs – 4 correntes Markov em Paralelo
</p>
</div>
</div>
<h2 id="hamiltonian-monte-carlo-hmc">Hamiltonian Monte Carlo – HMC</h2>
<p>Os problemas de baixas taxas de aceitação de propostas das técnicas de Metropolis e do desempenho baixo do algoritmo de Gibbs em problemas multidimensionais nas quais a topologia da posterior é complexa fizeram com que surgisse uma nova técnica MCMC usando dinâmica Hamiltoniana (em homenagem ao físico irlandês <a href="https://en.wikipedia.org/wiki/William_Rowan_Hamilton">William Rowan Hamilton</a> (1805-1865) figura <a href="#fig:hamilton">15</a>). O nome em inglês dessa técnica é <em>Hamiltonean Monte Carlo</em> – HMC.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="figure" style="text-align: center"><span id="fig:hamilton"></span>
<img src="images/hamilton.png" alt="William Rowan Hamilton. Figura de https://www.wikipedia.org" width="124" class=external />
<p class="caption">
Figure 15: William Rowan Hamilton. Figura de <a href="https://www.wikipedia.org" class="uri">https://www.wikipedia.org</a>
</p>
</div>
</div>
<p>O HMC é uma adaptação da técnica de Metropolis e emprega um esquema guiado de geração de novas proposta: isso melhora a taxa de aceitação de propostas e, consequentemente, a eficiência. Mais especificamente, o HMC usa o gradiente do log posterior para direcionar a cadeia de Markov para regiões de maior densidade posterior, onde a maioria das amostras são coletadas. Como resultado, uma corrente Markov com o algoritmo HMC bem ajustada aceitará propostas em uma taxa muito mais alta do que o algoritmo Metropolis tradicional <span class="citation" data-cites="robertsWeakConvergenceOptimal1997">(<a href="#ref-robertsWeakConvergenceOptimal1997" role="doc-biblioref">Roberts et al., 1997</a>)</span>.</p>
<p>HMC foi inicialmente descrito na literatura de física <span class="citation" data-cites="duaneHybridMonteCarlo1987"><a href="#ref-duaneHybridMonteCarlo1987" role="doc-biblioref">Duane, Kennedy, Pendleton, &amp; Roweth</a> (<a href="#ref-duaneHybridMonteCarlo1987" role="doc-biblioref">1987</a>)</span> (que chamaram de <em>“hybrid” Monte Carlo</em> – HMC). Logo depois, HMC foi aplicado a problemas estatísticos por <span class="citation" data-cites="nealImprovedAcceptanceProcedure1994"><a href="#ref-nealImprovedAcceptanceProcedure1994" role="doc-biblioref">Radford M. Neal</a> (<a href="#ref-nealImprovedAcceptanceProcedure1994" role="doc-biblioref">1994</a>)</span> (que chamou de <em>Hamiltonean Monte Carlo</em> – HMC). Para uma discussão aprofundada (que não é o foco deste conteúdo) de HMC eu recomendo <span class="citation" data-cites="neal2011mcmc"><a href="#ref-neal2011mcmc" role="doc-biblioref">Radford M. Neal</a> (<a href="#ref-neal2011mcmc" role="doc-biblioref">2011</a>)</span> e <span class="citation" data-cites="betancourtConceptualIntroductionHamiltonian2017"><a href="#ref-betancourtConceptualIntroductionHamiltonian2017" role="doc-biblioref">Betancourt</a> (<a href="#ref-betancourtConceptualIntroductionHamiltonian2017" role="doc-biblioref">2017</a>)</span>.</p>
<p>HMC usa dinâmica Hamiltoniana aplicada para partículas explorando a topologia de uma probabilidade posterior. Em algumas simulações Metropolis possui taxa de aceitação de aproximadamente 23%, enquanto HMC 65% <span class="citation" data-cites="gelman2013bayesian">(<a href="#ref-gelman2013bayesian" role="doc-biblioref">Gelman et al., 2013b</a>)</span>. Além de explorar melhor a topologia da posterior e tolerar topologias complexas, HMC é muito mais eficiente que Metropolis e não sofre do problema de correlação dos parâmetros que Gibbs.</p>
<p>Para cada componente <span class="math inline">\(\theta_j\)</span>, o HMC adiciona uma variável de momento <span class="math inline">\(\phi_j\)</span>. A densidade posterior <span class="math inline">\(P(\theta | y)\)</span> é incrementada por uma distribuição independente <span class="math inline">\(P(\phi)\)</span> dos momentos, definindo assim uma distribuição conjunta:</p>
<p><span class="math display">\[
P(\theta, \phi | y) = P(\phi) \cdot P(\theta|y)
\]</span></p>
<p>O HMC usa uma distribuição de propostas que muda dependendo do estado atual na corrente Markov. O HMC descobre a direção em que a distribuição posterior aumenta, chamada de <em>gradiente</em>, e distorce a distribuição de propostas em direção ao <em>gradiente</em>. No algoritmo de Metropolis, a distribuição das propostas seria uma distribuição Normal (geralmente) centrada na posição atual, de modo que saltos acima ou abaixo da posição atual teriam a mesma probabilidade de serem propostos. Mas o HMC gera propostas de maneira bem diferente.</p>
<p>Você pode imaginar que para distribuições posteriores de alta dimensão que têm <em>vales diagonais estreitos</em> e até mesmo <em>vales curvos</em>, a dinâmica do HMC encontrará posições propostas que são muito mais <strong>promissoras</strong> do que uma distribuição de proposta simétrica ingênua, e mais promissoras do que a amostragem de Gibbs, que pode obter preso em <em>paredes diagonais</em>.</p>
<p>A probabilidade da corrente Markov mudar de estado no algoritmo HMC é definida como:</p>
<p><span class="math display">\[
P_{\text{mudar}} = \min\left({\frac{P(\theta_{\text{proposto}}) \cdot P(\phi_{\text{proposto}})}{P(\theta_{\text{atual}})\cdot P(\phi_{\text{atual}})}}, 1\right),
\]</span></p>
<p>onde <span class="math inline">\(\phi\)</span> é o momento.</p>
<h3 id="distribuição-dos-momentos-pphi">Distribuição dos Momentos – <span class="math inline">\(P(\phi)\)</span></h3>
<p>Normalmente damos a <span class="math inline">\(\phi\)</span> uma distribuição normal multivariada com média 0 e covariância de <span class="math inline">\(\mathbf{M}\)</span>, uma “matriz de massa.” Para mantêr as coisas um pouco mais simples, usamos uma matriz de massa diagonal <span class="math inline">\(\mathbf{M}\)</span>. Isso faz com que os componentes de <span class="math inline">\(\phi\)</span> sejam independentes com <span class="math inline">\(\phi_j \sim \text{Normal}(0, M_{jj})\)</span></p>
<h3 id="algoritmo-de-hmc">Algoritmo de HMC</h3>
<p>O algoritmo de HM é bem similar ao algoritmo Metropolis mas com a inclusão do momento <span class="math inline">\(\phi\)</span> como uma maneira de quantificar o gradiente da posterior.</p>
<ol type="1">
<li><p>Amostre <span class="math inline">\(\phi\)</span> de uma <span class="math inline">\(\text{Normal}(0,\mathbf{M})\)</span></p></li>
<li><p>Simultaneamente amostre <span class="math inline">\(\theta\)</span> e <span class="math inline">\(\phi\)</span> com <span class="math inline">\(L\)</span> <em>leapfrog steps</em> (não sei como traduzir isso, talvez múltiplos passos) cada um reduzido por um fator <span class="math inline">\(\epsilon\)</span>. Em um <em>leapfrog step</em>, tanto <span class="math inline">\(\theta\)</span> quanto <span class="math inline">\(\phi\)</span> são alterados, um em relação ao outro. Repita os seguintes passos <span class="math inline">\(L\)</span> vezes:</p>
<ol type="1">
<li><p>Use o gradiente do log da posterior<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a> de <span class="math inline">\(\theta\)</span> para produzir um meio-salto(<em>half-step</em>) de <span class="math inline">\(\phi\)</span>:</p>
<p><span class="math display">\[\phi \leftarrow \phi + \frac{1}{2} \epsilon \frac{d \log p(\theta | y)}{d \theta}\]</span></p></li>
<li><p>Use o vetor de momentos <span class="math inline">\(\phi\)</span> para atualizar o vetor de parâmetros <span class="math inline">\(\theta\)</span>:</p>
<p><span class="math display">\[\theta \leftarrow \theta + \epsilon \mathbf{M}^{-1} \phi\]</span></p></li>
<li><p>Novamente use o gradiente de <span class="math inline">\(\theta\)</span> para produzir um meio-salto(<em>half-step</em>) de <span class="math inline">\(\phi\)</span>:</p>
<p><span class="math display">\[\phi \leftarrow \phi + \frac{1}{2} \epsilon \frac{d \log p(\theta | y)}{d \theta}\]</span></p></li>
</ol></li>
<li><p>Designe <span class="math inline">\(\theta^{t-1}\)</span> e <span class="math inline">\(\phi^{t-1}\)</span> como os valores do vetor de parâmetros e do vetor de momentos, respectivamente, no início do processo de <em>leapfrog</em> (etapa 2) e <span class="math inline">\(\theta^*\)</span> e <span class="math inline">\(\phi^*\)</span> como os valores após <span class="math inline">\(L\)</span> passos. Como regra de aceitação/rejeição calcule:</p>
<p><span class="math display">\[r = \frac{p(\theta^* | y) p(\phi^*)}{p(\theta^{t-1} | y) p(\phi^{-1})}\]</span></p></li>
<li><p>Designe:</p>
<p><span class="math display">\[\theta^t
 \begin{cases}
 \theta^* &amp; \text{with probability min($r$,1)} \\
 \theta^{t-1} &amp; \text{caso contrário}
 \end{cases}\]</span></p></li>
</ol>
<h3 id="hmc-implementação">HMC – Implementação</h3>
<p>Para HMC, não vou codificar o algoritmo na mão, pois envolve derivadas que não vai ser muito eficiente no R. Para isso temos o Stan. O arquivo <code>hmc.rds</code> possui 1.000 amostragens com um leapfrog <span class="math inline">\(L = 40\)</span>, então no total são 40.001 iterações<a href="#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>. O exemplo é o mesmo que usamos para Metropolis e Gibbs, uma distribuição normal multivariada de <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span> (ambos com média 0 e desvio padrão 1), com correlação 0.8 (<span class="math inline">\(\rho = 0.8\)</span>):</p>
<p><span class="math display">\[
\begin{bmatrix}
X \\
Y
\end{bmatrix} \sim \text{Normal Multivariada} \left(
\begin{bmatrix}
0 \\
0
\end{bmatrix}, \mathbf{\Sigma}
\right) \\
\mathbf{\Sigma} \sim
\begin{pmatrix}
1 &amp; 0.8 \\
0.8 &amp; 1
\end{pmatrix}
\]</span></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/load.html'>load</a></span><span class='op'>(</span><span class='fu'>here</span><span class='fu'>::</span><span class='fu'><a href='https://here.r-lib.org//reference/here.html'>here</a></span><span class='op'>(</span><span class='st'>"R"</span>, <span class='st'>"hmc.RData"</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>df</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://tibble.tidyverse.org/reference/tibble.html'>tibble</a></span><span class='op'>(</span>id <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>40000</span><span class='op'>)</span>,
                 iter <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>1000</span>, each <span class='op'>=</span> <span class='fl'>40</span><span class='op'>)</span>,
                 th1 <span class='op'>=</span> <span class='va'>tt</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>40000</span>, <span class='fl'>1</span><span class='op'>]</span>,
                 th2 <span class='op'>=</span> <span class='va'>tt</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>40000</span>, <span class='fl'>2</span><span class='op'>]</span>,
                 th1l <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>tt</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>]</span>, <span class='va'>tt</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fl'>40000</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>,
                 th2l <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>tt</span><span class='op'>[</span><span class='fl'>1</span>, <span class='fl'>2</span><span class='op'>]</span>, <span class='va'>tt</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fl'>40000</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>X_hmc</span> <span class='op'>&lt;-</span> <span class='va'>tt</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>2</span>, <span class='fl'>40001</span>, by <span class='op'>=</span> <span class='fl'>40</span><span class='op'>)</span>, <span class='op'>]</span>
<span class='va'>res</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://mc-stan.org/rstan/reference/monitor.html'>monitor</a></span><span class='op'>(</span><span class='va'>X_hmc</span>, digits_summary <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>Inference for the input samples (2 chains: each with iter = 1000; warmup = 500):

     Q5  Q50 Q95 Mean  SD  Rhat Bulk_ESS Tail_ESS
V1 -1.6 -0.1 1.4 -0.1 0.9     1      604      655

For each parameter, Bulk_ESS and Tail_ESS are crude measures of 
effective sample size for bulk and tail quantities respectively (an ESS &gt; 100 
per chain is considered good), and Rhat is the potential scale reduction 
factor on rank normalized split chains (at convergence, Rhat &lt;= 1.05).</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>neff</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>[</span>, <span class='st'>"n_eff"</span><span class='op'>]</span>
<span class='va'>reff</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>neff</span> <span class='op'>/</span> <span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>X_hmc</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='co'>#  61%!!!</span>
</code></pre>
</div>
</div>
<p>Na nossa execução do algoritmo HMC temos como resultado uma matriz <code>X_hmc</code> com 100 linhas e 2 colunas (as mesmas condições já mostradas nos exemplos anteriores com algoritmo Metropolis e Gibbs, porém agora somente com 1.000 amostras).</p>
<p>Vejam que o número de amostras eficientes em relação ao número total de iterações <code>reff</code> é 61% para todas as iterações incluindo <em>warm-up</em> (no caso 1 <em>leapfrog step</em> <span class="math inline">\(L = 1\)</span>). A eficiência do algoritmo HMC, no nosso exemplo didático, é o mais que 6x a eficiência do algoritmo de Metropolis (9,5% vs 61%) e quase 3x a eficiência do Gibbs (23% vs 61%).</p>
<h5 id="hmc-intuição-visual">HMC – Intuição Visual</h5>
<p>A animação na figura <a href="#fig:hmc-gif">16</a> mostra as 50 primeiras simulações do algoritmo HMC usado para gerar <code>X_hmc</code>. Vejam que aqui temos em amarelo temos os <em>leapfrog steps</em> moldandos e distorcendo a distribuição de propostas em direção ao gradiente da posterior (conduzindo-as para áreas de maior probabilidade da posterior) e em vermelho temos as amostras após os 40 <em>leapfrog step</em> <span class="math inline">\(L = 40\)</span> de cada interação. Notem como a exploração da posterior é muito mais eficiente e focada em locais onde realmente a distribuição de interesse possui maior probabilidade.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>labs3</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"Amostras"</span>, <span class='st'>"Iterações do Algoritmo"</span>, <span class='st'>"90% HPD"</span>, <span class='st'>"Leapfrog"</span><span class='op'>)</span>
<span class='co'># base plot</span>
<span class='va'>p0</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"3"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"HMC"</span>, subtitle <span class='op'>=</span> <span class='st'>"50 Amostragens Iniciais"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"red"</span>, <span class='st'>"forestgreen"</span>, <span class='st'>"blue"</span>, <span class='st'>"yellow"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span>, <span class='cn'>NA</span>, <span class='fl'>16</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span>, <span class='fl'>1</span>, <span class='fl'>0</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># first 100 iterations</span>
<span class='va'>df50</span> <span class='op'>&lt;-</span> <span class='va'>df</span> <span class='op'>%&gt;%</span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>iter</span> <span class='op'>&lt;=</span> <span class='fl'>50</span><span class='op'>)</span>
<span class='va'>pp</span> <span class='op'>&lt;-</span> <span class='va'>p0</span> <span class='op'>+</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df50</span>,
                      <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, color <span class='op'>=</span> <span class='st'>"4"</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span>, size <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_segment.html'>geom_segment</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df50</span>,
               <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>th1</span>, xend <span class='op'>=</span> <span class='va'>th1l</span>, color <span class='op'>=</span> <span class='st'>"2"</span>, y <span class='op'>=</span> <span class='va'>th2</span>, yend <span class='op'>=</span> <span class='va'>th2l</span><span class='op'>)</span>,
               alpha <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
        <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>df50</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>df50</span><span class='op'>)</span>, by <span class='op'>=</span> <span class='fl'>40</span><span class='op'>)</span>, <span class='op'>]</span>,
                   <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span>, size <span class='op'>=</span> <span class='fl'>2</span><span class='op'>)</span>

<span class='fu'><a href='https://gganimate.com/reference/animate.html'>animate</a></span><span class='op'>(</span><span class='va'>pp</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/transition_manual.html'>transition_manual</a></span><span class='op'>(</span><span class='va'>iter</span>, cumulative <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://gganimate.com/reference/shadow_trail.html'>shadow_trail</a></span><span class='op'>(</span><span class='fl'>0.05</span><span class='op'>)</span>,
  <span class='co'># animation options</span>
  height <span class='op'>=</span> <span class='fl'>7</span>, width <span class='op'>=</span> <span class='fl'>7</span>, units <span class='op'>=</span> <span class='st'>"in"</span>, res <span class='op'>=</span> <span class='fl'>300</span>
<span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:hmc-gif"></span>
<img src="5-MCMC_files/figure-html5/hmc-gif-1.gif" alt="Animação HMC"  />
<p class="caption">
Figure 16: Animação HMC
</p>
</div>
</div>
<p>Na figura <a href="#fig:hmc-all">17</a> é possível ver como ficaram as 1.000 simulações excluindo o primeiro <em>leapfrog step</em> <span class="math inline">\(L = 1\)</span> como <em>warmup</em>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Take all the 1,000 observations after warmup of 1,000</span>
<span class='va'>warm</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>
<span class='va'>dfs</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
  th1 <span class='op'>=</span> <span class='va'>tt</span><span class='op'>[</span><span class='op'>(</span><span class='va'>warm</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>tt</span><span class='op'>)</span>, <span class='fl'>1</span><span class='op'>]</span>,
  th2 <span class='op'>=</span> <span class='va'>tt</span><span class='op'>[</span><span class='op'>(</span><span class='va'>warm</span> <span class='op'>+</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>:</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>tt</span><span class='op'>)</span>, <span class='fl'>2</span><span class='op'>]</span>
<span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dfs</span><span class='op'>[</span><span class='fu'><a href='https://rdrr.io/r/base/seq.html'>seq</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>dfs</span><span class='op'>)</span>, by <span class='op'>=</span> <span class='fl'>40</span><span class='op'>)</span>, <span class='op'>]</span>,
             <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>th1</span>, <span class='va'>th2</span>, color <span class='op'>=</span> <span class='st'>"1"</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>0.3</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/stat_ellipse.html'>stat_ellipse</a></span><span class='op'>(</span>data <span class='op'>=</span> <span class='va'>dft</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='va'>X1</span>, y <span class='op'>=</span> <span class='va'>X2</span>, color <span class='op'>=</span> <span class='st'>"2"</span><span class='op'>)</span>, level <span class='op'>=</span> <span class='fl'>0.9</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/coord_cartesian.html'>coord_cartesian</a></span><span class='op'>(</span>xlim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span>, ylim <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>-</span><span class='fl'>3</span>, <span class='fl'>3</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>
    title <span class='op'>=</span> <span class='st'>"HMC"</span>, subtitle <span class='op'>=</span> <span class='st'>"1.000 Amostragens"</span>,
    x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>]</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>theta</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/scale_manual.html'>scale_color_manual</a></span><span class='op'>(</span>values <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>"steelblue"</span>, <span class='st'>"blue"</span><span class='op'>)</span>, labels <span class='op'>=</span> <span class='va'>labs2</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guides.html'>guides</a></span><span class='op'>(</span>color <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/guide_legend.html'>guide_legend</a></span><span class='op'>(</span>override.aes <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
    shape <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>16</span>, <span class='cn'>NA</span><span class='op'>)</span>, linetype <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"bottom"</span>, legend.title <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/element.html'>element_blank</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:hmc-all"></span>
<img src="5-MCMC_files/figure-html5/hmc-all-1.png" alt="1.000 simulações HMC após descarte da primeira iteração como *warmup*" width="624" />
<p class="caption">
Figure 17: 1.000 simulações HMC após descarte da primeira iteração como <em>warmup</em>
</p>
</div>
</div>
<h3 id="hmc-geometrias-complexas">HMC – Geometrias Complexas</h3>
<p>Há casos que HMC será muito melhor que Metropolis ou Gibbs. Em especial, esses casos se concentram em geometrias complicadas e de difícil exploração. Nesses contextos um algoritmo que consiga guiar as propostas para regiões de maior densidade (como é o caso do HMC) consegue explorar de maneira muito mais eficiente (menos iterações para convergência) e eficaz (maior taxa de aceitação das propostas).</p>
<p>Veja na figura <a href="#fig:plot-bimodal">18</a> um exemplo de uma posterior bimodal (destaque para o histograma marginal de <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>):</p>
<p><span class="math display">\[
X = \text{Normal} \left(
\begin{bmatrix}
10 \\
2
\end{bmatrix},
\begin{bmatrix}
1 &amp; 0 \\
0 &amp; 1
\end{bmatrix}
\right), \quad
Y = \text{Normal} \left(
\begin{bmatrix}
0 \\
0
\end{bmatrix},
\begin{bmatrix}
8.4 &amp; 2.0 \\
2.0 &amp; 1.7
\end{bmatrix}
\right).
\]</span></p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/daattali/ggExtra'>ggExtra</a></span><span class='op'>)</span>
<span class='va'>components</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>2</span>, prob <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0.5</span>, <span class='fl'>0.5</span><span class='op'>)</span>, size <span class='op'>=</span> <span class='va'>N</span>, replace <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='va'>mus_1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>10</span>, <span class='fl'>2</span><span class='op'>)</span>
<span class='va'>sds_1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>1</span>, <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>samples_1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span>n <span class='op'>=</span> <span class='va'>N</span>, mean <span class='op'>=</span> <span class='va'>mus_1</span><span class='op'>[</span><span class='va'>components</span><span class='op'>]</span>, sd <span class='op'>=</span> <span class='va'>sds_1</span><span class='op'>[</span><span class='va'>components</span><span class='op'>]</span><span class='op'>)</span>


<span class='va'>mus_2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>0</span><span class='op'>)</span>
<span class='va'>sds_2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/MathFun.html'>sqrt</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>8.4</span>, <span class='fl'>1.7</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>samples_2</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span>n <span class='op'>=</span> <span class='va'>N</span>, mean <span class='op'>=</span> <span class='va'>mus_2</span><span class='op'>[</span><span class='va'>components</span><span class='op'>]</span>, sd <span class='op'>=</span> <span class='va'>sds_2</span><span class='op'>[</span><span class='va'>components</span><span class='op'>]</span><span class='op'>)</span>

<span class='va'>dft_bimodal</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span><span class='va'>samples_1</span>, <span class='va'>samples_2</span><span class='op'>)</span>

<span class='va'>p4</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>dft_bimodal</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>samples_1</span>, <span class='va'>samples_2</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>"Multivariada Normal"</span>,
           subtitle <span class='op'>=</span> <span class='st'>"Mistura de uma Normal Bimodal com uma Normal com cauda longa"</span>,
           caption <span class='op'>=</span> <span class='st'>"10.000 simulações"</span>,
           x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>Y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
      <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"NULL"</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/pkg/ggExtra/man/ggMarginal.html'>ggMarginal</a></span><span class='op'>(</span><span class='va'>p4</span>, type <span class='op'>=</span> <span class='st'>"density"</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:plot-bimodal"></span>
<img src="5-MCMC_files/figure-html5/plot-bimodal-1.png" alt="Gráfico de Densidade de uma distribuição Multivariada Normal com Multimodalidade" width="624" />
<p class="caption">
Figure 18: Gráfico de Densidade de uma distribuição Multivariada Normal com Multimodalidade
</p>
</div>
</div>
<p>E para finalizar um exemplo do funil de Neal <span class="citation" data-cites="nealSliceSampling2003">(<a href="#ref-nealSliceSampling2003" role="doc-biblioref">Radford M. Neal, 2003</a>)</span> na figura <a href="#fig:plot-funnel">19</a>. Essa é uma posterior bem difícil de ser amostrada até mesmo para HMC, pois ela varia de geometria nas dimensões <span class="math inline">\(X\)</span> e <span class="math inline">\(Y\)</span>. Isso faz com que o amostrador HMC tenha que toda hora trocar o <em>leapfrog steps</em> <span class="math inline">\(L\)</span> e o fator <span class="math inline">\(\epsilon\)</span>, pois na parte superior da imagem (o topo do funil) são necessários um valor de <span class="math inline">\(L\)</span> grande e <span class="math inline">\(\epsilon\)</span> um valor pequeno; e na parte de baixo (no fundo do funil) o contrário: <span class="math inline">\(L\)</span> pequeno e <span class="math inline">\(\epsilon\)</span> grande.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>y</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N</span>, <span class='fl'>0</span>, <span class='fl'>3</span><span class='op'>)</span>
<span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/stats/Normal.html'>rnorm</a></span><span class='op'>(</span><span class='va'>N</span>, <span class='fl'>0</span>, <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>exp</a></span><span class='op'>(</span><span class='va'>y</span> <span class='op'>/</span> <span class='fl'>2</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>dft_funnel</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span>

<span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='va'>dft_funnel</span>, <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_point.html'>geom_point</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>title <span class='op'>=</span> <span class='st'>"Funil de Neal"</span>,
           caption <span class='op'>=</span> <span class='st'>"10.000 simulações"</span>,
           x <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>X</span><span class='op'>)</span>, y <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/expression.html'>expression</a></span><span class='op'>(</span><span class='va'>Y</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
      <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/theme.html'>theme</a></span><span class='op'>(</span>legend.position <span class='op'>=</span> <span class='st'>"NULL"</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:plot-funnel"></span>
<img src="5-MCMC_files/figure-html5/plot-funnel-1.png" alt="Gráfico de Densidade do Funil de Neal" width="624" />
<p class="caption">
Figure 19: Gráfico de Densidade do Funil de Neal
</p>
</div>
</div>
<h2 id="não-entendi-nada">“Não entendi nada…”</h2>
<p>Se você não entendeu nada até agora, não se desespere. Pule todas as fórmulas e pegue a intuição visual dos algoritmos. Veja as limitações de Metropolis e Gibbs e compare as animações e figuras com as do HMC. A superioridade de eficiência (mais amostras com baixa autocorrelação) e eficácia (mais amostras próximas das áreas de maior probabilidade da distribuição-alvo) é autoexplicativa pelas imagens.</p>
<p>Além disso, você provavelmente <strong>nunca</strong> terá que codificar o seu algoritmo HMC (Gibbs, Metropolis ou qualquer outro MCMC) na mão. Para isso há pacotes como Stan (e seu ecossistema de pacotes: <code>rstan</code>, <code>PyStan</code>, <code>brms</code>, <code>rstanarm</code>, <code>Stan.jl</code> etc.). Além disso, Stan implementa um HMC modificado com uma técnica chamada <strong>N</strong>o-<strong>U</strong>-<strong>T</strong>urn <strong>S</strong>ampling (NUTS) <span class="citation" data-cites="hoffman2014no">(<a href="#ref-hoffman2014no" role="doc-biblioref">Hoffman &amp; Gelman, 2011</a>)</span> que seleciona automaticamente os valores de <span class="math inline">\(\epsilon\)</span> (fator de redução) e <span class="math inline">\(L\)</span> (quantidade de <em>leapfrog steps</em>).<a href="#fn11" class="footnote-ref" id="fnref11" role="doc-noteref"><sup>11</sup></a> O desempenho do HMC é altamente sensível à esses dois “hiperparâmetros” (parâmetros que devem ser especificados pelo usuário). Em particular, se <span class="math inline">\(L\)</span> for muito pequeno, o algoritmo exibe comportamento indesejável de um passeio aleatório, enquanto se <span class="math inline">\(L\)</span> for muito grande, o algoritmo desperdiça eficiência computacional. NUTS usa um algoritmo recursivo para construir um conjunto de pontos candidatos prováveis que abrangem uma ampla faixa da distribuição de propostas, parando automaticamente quando começa a voltar e refazer seus passos (por isso que ele não dá meia-volta – <em>No U-turn</em>), adicionalmente NUTS também calibra automaticamente (e de maneira simultânea) <span class="math inline">\(L\)</span> e <span class="math inline">\(\epsilon\)</span>.</p>
<h2 id="implementação-com-o-rstanarm">Implementação com o <code>rstanarm</code></h2>
<p>Como configuração padrão, o pacote <code>rstanarm</code> utiliza HMC com NUTS. Além disso, os argumentos padrões do HMC no <code>rstanarm</code> são:</p>
<ul>
<li>4 correntes Markov de amostragem (<code>chains = 4</code>); e</li>
<li>2.000 iterações de cada corrente (<code>iter = 2000</code>)<a href="#fn12" class="footnote-ref" id="fnref12" role="doc-noteref"><sup>12</sup></a>.</li>
</ul>
<p>Relembrando o exemplo da aula de regressão linear, vamos usar o mesmo <em>dataset</em> <code>kidiq</code>. São dados de uma <em>survey</em> de mulheres adultas norte-americanas e seus respectivos filhos. Datado de 2007 possui 434 observações e 4 variáveis:</p>
<ul>
<li><code>kid_score</code>: QI da criança;</li>
<li><code>mom_hs</code>: binária (0 ou 1) se a mãe possui diploma de ensino médio;</li>
<li><code>mom_iq</code>: QI da mãe; e</li>
<li><code>mom_age</code>: idade da mãe.</li>
</ul>
<p>Vamos estimar um modelo de regressão linear Bayesiano na qual a variável dependente é <code>kid_score</code> e as independentes são <code>mom_hs</code> e <code>mom_iq</code>.</p>
<p>O modelo é o especificado da seguinte maneira:</p>
<p><span class="math display">\[
\begin{aligned}
\alpha &amp;\sim \text{Normal}(\mu_y, s_y) \\
\beta_k &amp;\sim \text{Normal}(0, 2.5 \cdot \frac{s_y}{s_x}) \\
\sigma &amp;\sim \text{Exponencial}(\frac{1}{s_y})\\
y &amp;\sim \text{Normal}(\alpha + \beta_1 x_1 + \dots + \beta_K x_K, \sigma),
\end{aligned}
\]</span></p>
<p>onde <span class="math inline">\(s_x = \tt{sd(x)}\)</span>, <span class="math display">\[
s_y =
\begin{cases}
\tt{sd(y)} &amp; \text{se } \tt{family = gaussian}, \\
1 &amp; \text{caso contrário}.
\end{cases}
\]</span> e <span class="math display">\[
\mu_y =
\begin{cases}
\tt{mean(y)} &amp; \text{se } \tt{family = gaussian}, \\
0 &amp; \text{caso contrário}.
\end{cases}
\]</span></p>
<p>No caso temos apenas duas variáveis independentes, então <span class="math inline">\(K=2\)</span> e <span class="math inline">\(\beta_1 = \tt{mom\_hs}\)</span> e <span class="math inline">\(\beta_2 = \tt{mom\_iq}\)</span>; variável dependente <span class="math inline">\(y = \tt{kid\_score}\)</span> e o erro do modelo $= </p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/options.html'>options</a></span><span class='op'>(</span>mc.cores <span class='op'>=</span> <span class='fu'>parallel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/r/parallel/detectCores.html'>detectCores</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/options.html'>options</a></span><span class='op'>(</span>Ncpus <span class='op'>=</span> <span class='fu'>parallel</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/r/parallel/detectCores.html'>detectCores</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://mc-stan.org/rstanarm/'>rstanarm</a></span><span class='op'>)</span>
<span class='va'>model</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://mc-stan.org/rstanarm/reference/stan_glm.html'>stan_glm</a></span><span class='op'>(</span>
  <span class='va'>kid_score</span> <span class='op'>~</span> <span class='va'>mom_hs</span> <span class='op'>+</span> <span class='va'>mom_iq</span>,
  data <span class='op'>=</span> <span class='va'>kidiq</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="métricas-da-simulação-mcmc">Métricas da simulação MCMC</h3>
<p>Um modelo estimado pelo <code>rstanarm</code> pode ser inspecionado em relação ao desempenho da amostragem MCMC. Ao chamarmos a função <code>summary()</code> no modelo estimado há uma parte chamada <code>MCMC diagnostics</code>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>model</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>
Model Info:
 function:     stan_glm
 family:       gaussian [identity]
 formula:      kid_score ~ mom_hs + mom_iq
 algorithm:    sampling
 sample:       4000 (posterior sample size)
 priors:       see help(&#39;prior_summary&#39;)
 observations: 434
 predictors:   3

Estimates:
              mean   sd   10%   50%   90%
(Intercept) 25.7    5.9 18.2  25.7  33.3 
mom_hs       6.0    2.2  3.1   6.0   8.9 
mom_iq       0.6    0.1  0.5   0.6   0.6 
sigma       18.2    0.6 17.4  18.2  19.0 

Fit Diagnostics:
           mean   sd   10%   50%   90%
mean_PPD 86.8    1.2 85.2  86.8  88.4 

The mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help(&#39;summary.stanreg&#39;)).

MCMC diagnostics
              mcse Rhat n_eff
(Intercept)   0.1  1.0  5120 
mom_hs        0.0  1.0  4168 
mom_iq        0.0  1.0  4811 
sigma         0.0  1.0  4747 
mean_PPD      0.0  1.0  4306 
log-posterior 0.0  1.0  1778 

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</code></pre>
</div>
<p>A seção <code>MCMC diagnostics</code> possui três colunas de valores para cada parâmetro estimado do modelo.</p>
<p>No nosso caso, temos três parâmetros importantes:</p>
<ol type="1">
<li>valor do coeficiente da variável <code>mom_hs</code>;</li>
<li>valor do coeficiente da variável <code>mom_iq</code>; e</li>
<li>valor do erro residual do modelo linear <code>sigma</code>. As três métricas são:</li>
</ol>
<ul>
<li><code>mcse</code>: <em>Monte Carlo Standard Error</em>, o erro de mensuração da amostragem Monte Carlo do parâmetro;</li>
<li><code>n_eff</code>: uma aproximação crua do número de amostras efetivas amostradas pelo MCMC estimada pelo valor de <code>Rhat</code>; e</li>
<li><code>Rhat</code>: uma métrica de convergência e estabilidade da corrente Markov.</li>
</ul>
<p>A métrica mais importante para levarmos em consideração é a <code>Rhat</code> que é uma métrica que mensura se as correntes Markov são estáveis e convergiram para um valor durante o progresso total das simulações. Ela é basicamente a proporção de variação ao compararmos duas metades das correntes após o descarte dos <em>warmups</em>. Valor de 1 implica em convergência e estabilidade. Como padrão o <code>Rhat</code> deve ser menor que 1.01 para que a estimação Bayesiana seja válida <span class="citation" data-cites="brooksGeneralMethodsMonitoring1998 gelmanInferenceIterativeSimulation1992">(<a href="#ref-brooksGeneralMethodsMonitoring1998" role="doc-biblioref">S. P. Brooks &amp; Gelman, 1998</a>; <a href="#ref-gelmanInferenceIterativeSimulation1992" role="doc-biblioref">Gelman &amp; Rubin, 1992</a>)</span>.</p>
<h3 id="o-que-fazer-se-não-obtermos-convergência">O que fazer se não obtermos convergência?</h3>
<p>Dependendo do modelo e dos dados é possível que HMC (mesmo com NUTS) não atinja convergência. Nesse caso, ao rodar o modelo <code>rstanarm</code> dará diversos avisos de divergências. Aqui vou restringir o amostrador HMC do <code>rstanarm</code> para apenas 200 iterações com <em>warmup</em> padrão de metade das iterações (100) com duas correntes em paralelo (<code>chains</code>). Portanto, teremos <span class="math inline">\(2 \cdot (200 - 100) = 200\)</span> amostras de MCMC. se atente as mensagens de erro.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>bad_model</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://mc-stan.org/rstanarm/reference/stan_glm.html'>stan_glm</a></span><span class='op'>(</span>
  <span class='va'>kid_score</span> <span class='op'>~</span> <span class='va'>mom_hs</span> <span class='op'>+</span> <span class='va'>mom_iq</span>,
  data <span class='op'>=</span> <span class='va'>kidiq</span>,
  chains <span class='op'>=</span> <span class='fl'>2</span>,
  iter <span class='op'>=</span> <span class='fl'>200</span>
  <span class='op'>)</span>
</code></pre>
</div>
</div>
<p>Esta é uma vantagem dos pacotes do ecossistema do Stan (incluindo <code>rstanarm</code> e <code>brms</code>). Quando o amostrador MCMC mostra problemas ele falha de uma maneira bem escandalosa com diversos avisos. <strong>Nunca ignore esses avisos</strong>, eles estão lá para te ajudar e indicar que seu modelo possui problemas sérios que devem ser inspecionados e sanados.</p>
<p>E vemos que o <code>Rhat</code> dos parâmetros estimados do modelo estão bem acima do limiar de <span class="math inline">\(1.01\)</span>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/base/summary.html'>summary</a></span><span class='op'>(</span><span class='va'>bad_model</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>
Model Info:
 function:     stan_glm
 family:       gaussian [identity]
 formula:      kid_score ~ mom_hs + mom_iq
 algorithm:    sampling
 sample:       200 (posterior sample size)
 priors:       see help(&#39;prior_summary&#39;)
 observations: 434
 predictors:   3

Estimates:
              mean   sd   10%   50%   90%
(Intercept) 25.8    6.3 17.8  25.7  33.7 
mom_hs       5.9    2.2  3.0   5.8   8.8 
mom_iq       0.6    0.1  0.5   0.6   0.6 
sigma       18.3    0.6 17.5  18.2  19.1 

Fit Diagnostics:
           mean   sd   10%   50%   90%
mean_PPD 86.9    1.3 85.2  86.9  88.2 

The mean_ppd is the sample average posterior predictive distribution of the outcome variable (for details see help(&#39;summary.stanreg&#39;)).

MCMC diagnostics
              mcse Rhat n_eff
(Intercept)   0.4  1.0  245  
mom_hs        0.1  1.0  231  
mom_iq        0.0  1.0  234  
sigma         0.1  1.0  112  
mean_PPD      0.1  1.0   78  
log-posterior 0.2  1.0   59  

For each parameter, mcse is Monte Carlo standard error, n_eff is a crude measure of effective sample size, and Rhat is the potential scale reduction factor on split chains (at convergence Rhat=1).</code></pre>
</div>
<h2 id="gráficos-de-diagnósticos-do-mcmc">Gráficos de Diagnósticos do MCMC</h2>
<p>O pacote <code>rstanarm</code> e <code>brms</code> tem diversos gráficos interessantes de diagnósticos de convergência das simulações MCMC. Eu recomendo o fluxo de visualizações de modelos Bayesianos de <span class="citation" data-cites="gabryVisualizationBayesianWorkflow2019"><a href="#ref-gabryVisualizationBayesianWorkflow2019" role="doc-biblioref">Gabry, Simpson, Vehtari, Betancourt, &amp; Gelman</a> (<a href="#ref-gabryVisualizationBayesianWorkflow2019" role="doc-biblioref">2019</a>)</span>.</p>
<h3 id="traceplot"><em>Traceplot</em></h3>
<p>A primeira coisa que devemos ver quando há mensagens de avisos sobre divergências ou valores indesejáveis de <code>Rhat</code> é inspecionar as correntes Markov para ver se elas estão estacionárias ou se divergiram durante a amostragem do MCMC. Fazemos isso com a função <code>plot(stanreg, "trace")</code>. Objetos <code>stanreg</code> são modelos oriundos do <code>rstanarm</code>. No nosso caso temos dois objetos <code>stanreg</code>: o <code>model</code> e o <code>bad_model</code>.</p>
<p>O <em>traceplot</em> é a sobreposição das amostragens MCMC das correntes para cada parâmetro estimado (eixo vertical). A ideia é que as correntes se misturam e que não haja nenhuma inclinação ao longo das iterações (eixo horizontal). Isso demonstra que elas convergiram para um certo valor do parâmetro e se mantiveram nessa região durante boa parte (ou toda) da(a) amostragem das correntes Markov.</p>
<p>Detalhe: o <em>traceplot</em> usa somente as iterações válidas, após a remoção das iterações de <em>warmup</em>.</p>
<p>Vejam na figura <a href="#fig:plot-diagnostics1">20</a> o <em>traceplot</em> do modelo que as correntes Markov convergiram e ficaram estacionárias durante a amostragem do MCMC (afinal esse é o modelo <code>model</code> que designamos <code>iter = 2.000</code> e <code>chains = 4</code>, ambos padrões do <code>rstanarm</code> e <code>brms</code>). O ideal é sempre esse padrão no qual as correntes não apresentam uma tendência específica, ou seja, elas ficam geralmente “planas” na horizontal e não há uma grande variação de valores no eixo vertical (valor dos parâmetros). Esse padrão é muito parecido com “taturana.”</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>model</span>, <span class='st'>"trace"</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:plot-diagnostics1"></span>
<img src="5-MCMC_files/figure-html5/plot-diagnostics1-1.png" alt="*Traceplot* do `model`" width="624" />
<p class="caption">
Figure 20: <em>Traceplot</em> do <code>model</code>
</p>
</div>
</div>
<p>Na figura <a href="#fig:plot-diagnostics2">21</a> temos o <em>traceplot</em> do modelo que as correntes Markov <em>não</em> convergiram, o <code>bad_model</code> (designamos <code>iter = 200</code> e <code>chains = 2</code>). Aqui você vê que se aumentarmos o período de <em>warmup</em> e o número de iterações, provavelmente as correntes Markov convergiriam e ficariam estacionárias na região de maior probabilidade da posterior (e, consequentemente, dos parâmetros de interesse).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/graphics/plot.default.html'>plot</a></span><span class='op'>(</span><span class='va'>bad_model</span>, <span class='st'>"trace"</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:plot-diagnostics2"></span>
<img src="5-MCMC_files/figure-html5/plot-diagnostics2-1.png" alt="*Traceplot* do `bad_model`" width="624" />
<p class="caption">
Figure 21: <em>Traceplot</em> do <code>bad_model</code>
</p>
</div>
</div>
<h3 id="posterior-predictive-check"><em>Posterior Predictive Check</em></h3>
<p>Um bom gráfico de diagnóstico é o <em>posterior predictive check</em> (PPC) que compara o histograma da variável dependente <span class="math inline">\(y\)</span> contra o histograma variáveis dependentes simuladas pelo modelo <span class="math inline">\(y_{\text{rep}}\)</span> após a estimação dos parâmetros. A ideia é que os histogramas reais e simulados se misturem e não haja divergências. Fazemos isso com a função <code>pp_check(stanreg)</code>.</p>
<p>Vejam na figura <a href="#fig:pp-check1">22</a> o PPC do modelo que as correntes Markov convergiram e ficaram estacionárias durante a amostragem do MCMC (<code>model</code>). Podemos ver que as simulações <span class="math inline">\(y_{\text{rep}}\)</span> realmente capturaram a natureza da variável dependente <span class="math inline">\(y\)</span>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://mc-stan.org/rstanarm/reference/pp_check.stanreg.html'>pp_check</a></span><span class='op'>(</span><span class='va'>model</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:pp-check1"></span>
<img src="5-MCMC_files/figure-html5/pp-check1-1.png" alt="*Posterior Preditive Check* do `model`" width="624" />
<p class="caption">
Figure 22: <em>Posterior Preditive Check</em> do <code>model</code>
</p>
</div>
</div>
<p>Já na na figura <a href="#fig:pp-check2">23</a> temos o PPC do modelo que as correntes Markov <em>não</em> convergiram, o <code>bad_model</code>. Aqui vemos que as simulações <span class="math inline">\(y_{\text{rep}}\)</span> falharam em capturar a natureza da variável dependente <span class="math inline">\(y\)</span>. O PPC do <code>bad_model</code> também indica que se mantivéssemos um periodo maior de <em>warmup</em> e mais iterações das correntes Markov, provavelmente conseguiríamos ter um modelo que representasse muito bem o processo de geração de dados da nossa variável dependente <span class="math inline">\(y\)</span>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://mc-stan.org/rstanarm/reference/pp_check.stanreg.html'>pp_check</a></span><span class='op'>(</span><span class='va'>bad_model</span><span class='op'>)</span>
</code></pre>
</div>
<div class="figure" style="text-align: center"><span id="fig:pp-check2"></span>
<img src="5-MCMC_files/figure-html5/pp-check2-1.png" alt="*Posterior Preditive Check* do `bad_model`" width="624" />
<p class="caption">
Figure 23: <em>Posterior Preditive Check</em> do <code>bad_model</code>
</p>
</div>
</div>
<h2 id="o-quê-fazer-para-convergir-suas-correntes-markov">O quê fazer para convergir suas correntes Markov</h2>
<p><strong>Primeiro</strong>: Antes de fazer ajustes finos no número de correntes <code>chains</code> ou no número de iterações <code>iter</code> (entre outros …) saiba que o amostrador HMC-NUTS do Stan e seu ecossistema de pacotes (<code>rstanarm</code> e <code>brms</code> inclusos) é muito eficiente e eficaz em explorar as mais diversas complexas e “malucas” topologias de distribuições-alvo posterior. Os argumentos padrões (<code>iter = 2000</code>, <code>chains = 4</code> e <code>warmup = floor(iter/2)</code>) funcionam perfeitamente para 99% dos casos (mesmo em modelos complexos). Dito isto, <strong>na maioria das vezes quando você possui problemas de amostragem e computacionais no seu modelo Bayesiano, o problema está na especificação do modelo e não no algoritmo de amostragem MCMC</strong>. Esta frase foi dita por Andrew Gelman (o “pai” do Stan) e é conhecido como o <em>Folk Theorem</em> <span class="citation" data-cites="gelmanFolkTheoremStatistical2008">(<a href="#ref-gelmanFolkTheoremStatistical2008" role="doc-biblioref">Gelman, 2008</a>)</span>: <em>“When you have computational problems, often there’s a problem with your model”</em>.</p>
<p>Se o seu modelo Bayesiano está com problemas de convergência há alguns passos que podem ser tentados<a href="#fn13" class="footnote-ref" id="fnref13" role="doc-noteref"><sup>13</sup></a>. Aqui listados do mais simples para o mais complexo:</p>
<ol type="1">
<li><strong>Aumentar o número de iterações e correntes</strong>: primeira opção é aumentar o número de iterações do MCMC com o argumento <code>iter = XXX</code> e também é possível aumentar o número de correntes com o argumento <code>chains = X</code>. Lembrando que o padrão é <code>iter = 2000</code> e <code>chains = 4</code>.</li>
<li><strong>Alterar a rotina de adaptação do HMC</strong>: a segunda opção é fazer com que o algoritmo de amostragem HMC fique mais conservador (com proposições de pulos menores). Isto pode ser alterado com o argumento <code>adapt_delta</code> da lista de opções <code>control</code>. <code>control=list(adapt_delta=0.9)</code>. O padrão do <code>adapt_delta</code> é <code>control=list(adapt_delta=0.8)</code>. Então qualquer valor entre <span class="math inline">\(0.8\)</span> e <span class="math inline">\(1.0\)</span> o torna mais conservador.</li>
<li><strong>Reparametrização do Modelo</strong>: a terceira opção é reparametrizar o modelo. Há duas maneiras de parametrizar o modelo: a primeira com parametrização centrada (<em>centered parameterization</em>) e a segunda com parametrização não-centrada (<em>non-centered parameterization</em>). Não são assuntos que vamos cobrir aqui no curso. Recomendo o <a href="https://mc-stan.org/users/documentation/case-studies/divergences_and_bias.html">material de um dos desenvolvedores da linguagem <code>Stan</code>, Michael Betancourt</a>.</li>
<li><strong>Coletar mais dados</strong>: às vezes o modelo é complexo demais e precisamos de uma amostragem maior para conseguirmos estimativas estáveis.</li>
<li><strong>Repensar o modelo</strong>: falha de convergência quando temos uma amostragem adequada geralmente é por conta de uma especificação de priors e verossimilhança que não são compatíveis com os dados. Nesse caso, é preciso repensar o processo generativo de dados no qual os pressupostos do modelo estão ancorados.</li>
</ol>
<h2 id="ambiente">Ambiente</h2>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://rdrr.io/r/utils/sessionInfo.html'>sessionInfo</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>R version 4.0.4 (2021-02-15)
Platform: x86_64-apple-darwin17.0 (64-bit)
Running under: macOS Big Sur 10.16

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRblas.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRlapack.dylib

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods  
[7] base     

other attached packages:
 [1] rstanarm_2.21.1      Rcpp_1.0.6           ggExtra_0.9         
 [4] dplyr_1.0.5          patchwork_1.1.1      cowplot_1.1.1       
 [7] rstan_2.21.2         StanHeaders_2.21.0-7 MASS_7.3-53.1       
[10] ggforce_0.3.3        gganimate_1.0.7      plotly_4.9.3        
[13] ggplot2_3.3.3       

loaded via a namespace (and not attached):
  [1] minqa_1.2.4        colorspace_2.0-0   ellipsis_0.3.1    
  [4] ggridges_0.5.3     rsconnect_0.8.16   rprojroot_2.0.2   
  [7] markdown_1.1       base64enc_0.1-3    farver_2.1.0      
 [10] DT_0.17            fansi_0.4.2        splines_4.0.4     
 [13] codetools_0.2-18   downlit_0.2.1      mnormt_2.0.2      
 [16] knitr_1.31         shinythemes_1.2.0  polyclip_1.10-0   
 [19] bayesplot_1.8.0    jsonlite_1.7.2     nloptr_1.2.2.2    
 [22] png_0.1-7          shiny_1.6.0        compiler_4.0.4    
 [25] httr_1.4.2         Matrix_1.3-2       assertthat_0.2.1  
 [28] fastmap_1.1.0      lazyeval_0.2.2     cli_2.3.1         
 [31] later_1.1.0.1      tweenr_1.0.2       htmltools_0.5.1.1 
 [34] prettyunits_1.1.1  tools_4.0.4        igraph_1.2.6      
 [37] gtable_0.3.0       glue_1.4.2         reshape2_1.4.4    
 [40] V8_3.4.0           jquerylib_0.1.3    vctrs_0.3.6       
 [43] nlme_3.1-152       crosstalk_1.1.1    xfun_0.22         
 [46] stringr_1.4.0      ps_1.6.0           lme4_1.1-26       
 [49] mime_0.10          miniUI_0.1.1.1     lifecycle_1.0.0   
 [52] gtools_3.8.2       statmod_1.4.35     zoo_1.8-9         
 [55] scales_1.1.1       colourpicker_1.1.0 ragg_1.1.2        
 [58] hms_1.0.0          promises_1.2.0.1   parallel_4.0.4    
 [61] inline_0.3.17      shinystan_2.5.0    RColorBrewer_1.1-2
 [64] yaml_2.2.1         curl_4.3           gridExtra_2.3     
 [67] loo_2.4.1          sass_0.3.1         distill_1.2       
 [70] stringi_1.5.3      highr_0.8          dygraphs_1.1.1.6  
 [73] gifski_1.4.3       boot_1.3-27        pkgbuild_1.2.0    
 [76] rlang_0.4.10       pkgconfig_2.0.3    systemfonts_1.0.1 
 [79] matrixStats_0.58.0 evaluate_0.14      lattice_0.20-41   
 [82] purrr_0.3.4        rstantools_2.1.1   htmlwidgets_1.5.3 
 [85] labeling_0.4.2     processx_3.5.0     tidyselect_1.1.0  
 [88] here_1.0.1         plyr_1.8.6         magrittr_2.0.1    
 [91] R6_2.5.0           magick_2.7.1       generics_0.1.0    
 [94] DBI_1.1.1          pillar_1.5.1       withr_2.4.1       
 [97] xts_0.12.1         survival_3.2-10    tibble_3.1.0      
[100] crayon_1.4.1       utf8_1.2.1         tmvnsim_1.0-2     
[103] rmarkdown_2.7      jpeg_0.1-8.1       progress_1.2.2    
[106] grid_4.0.4         isoband_0.2.4      data.table_1.14.0 
[109] callr_3.6.0        threejs_0.3.3      digest_0.6.27     
[112] xtable_1.8-4       tidyr_1.1.3        httpuv_1.5.5      
[115] textshaping_0.3.3  RcppParallel_5.0.3 stats4_4.0.4      
[118] munsell_0.5.0      viridisLite_0.3.0  bslib_0.2.4       
[121] shinyjs_2.0.0     </code></pre>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2" role="doc-bibliography">
<div id="ref-betancourtConceptualIntroductionHamiltonian2017" class="csl-entry" role="doc-biblioentry">
Betancourt, M. (2017, January 9). A <span>Conceptual Introduction</span> to <span>Hamiltonian Monte Carlo</span>. Retrieved November 6, 2019, from <a href="http://arxiv.org/abs/1701.02434">http://arxiv.org/abs/1701.02434</a>
</div>
<div id="ref-brooksHandbookMarkovChain2011" class="csl-entry" role="doc-biblioentry">
Brooks, S., Gelman, A., Jones, G., &amp; Meng, X.-L. (2011). <em>Handbook of <span>Markov Chain Monte Carlo</span></em>. Retrieved from <a href="https://books.google.com?id=qfRsAIKZ4rIC">https://books.google.com?id=qfRsAIKZ4rIC</a>
</div>
<div id="ref-brooksGeneralMethodsMonitoring1998" class="csl-entry" role="doc-biblioentry">
Brooks, S. P., &amp; Gelman, A. (1998). General <span>Methods</span> for <span>Monitoring Convergence</span> of <span>Iterative Simulations</span>. <em>Journal of Computational and Graphical Statistics</em>, <em>7</em>(4), 434–455. <a href="https://doi.org/10.1080/10618600.1998.10474787">https://doi.org/10.1080/10618600.1998.10474787</a>
</div>
<div id="ref-carpenterStanProbabilisticProgramming2017" class="csl-entry" role="doc-biblioentry">
Carpenter, B., Gelman, A., Hoffman, M. D., Lee, D., Goodrich, B., Betancourt, M., … Riddell, A. (2017). Stan : <span>A Probabilistic Programming Language</span>. <em>Journal of Statistical Software</em>, <em>76</em>(1). <a href="https://doi.org/10.18637/jss.v076.i01">https://doi.org/10.18637/jss.v076.i01</a>
</div>
<div id="ref-casellaExplainingGibbsSampler1992" class="csl-entry" role="doc-biblioentry">
Casella, G., &amp; George, E. I. (1992). Explaining the gibbs sampler. <em>The American Statistician</em>, <em>46</em>(3), 167–174. <a href="https://doi.org/10.1080/00031305.1992.10475878">https://doi.org/10.1080/00031305.1992.10475878</a>
</div>
<div id="ref-chibUnderstandingMetropolisHastingsAlgorithm1995" class="csl-entry" role="doc-biblioentry">
Chib, S., &amp; Greenberg, E. (1995). Understanding the <span>Metropolis</span>-<span>Hastings Algorithm</span>. <em>The American Statistician</em>, <em>49</em>(4), 327–335. <a href="https://doi.org/10.1080/00031305.1995.10476177">https://doi.org/10.1080/00031305.1995.10476177</a>
</div>
<div id="ref-duaneHybridMonteCarlo1987" class="csl-entry" role="doc-biblioentry">
Duane, S., Kennedy, A. D., Pendleton, B. J., &amp; Roweth, D. (1987). Hybrid <span>Monte Carlo</span>. <em>Physics Letters B</em>, <em>195</em>(2), 216–222. <a href="https://doi.org/10.1016/0370-2693(87)91197-X">https://doi.org/10.1016/0370-2693(87)91197-X</a>
</div>
<div id="ref-eckhardtStanUlamJohn1987" class="csl-entry" role="doc-biblioentry">
Eckhardt, R. (1987). Stan <span>Ulam</span>, <span>John</span> von <span>Neumann</span>, and the <span>Monte Carlo Method</span>. <em>Los Alamos Science</em>, <em>15</em>(30), 131–136.
</div>
<div id="ref-gabryVisualizationBayesianWorkflow2019" class="csl-entry" role="doc-biblioentry">
Gabry, J., Simpson, D., Vehtari, A., Betancourt, M., &amp; Gelman, A. (2019). Visualization in <span>Bayesian</span> workflow. <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em>, <em>182</em>(2), 389–402. <a href="https://doi.org/10.1111/rssa.12378">https://doi.org/10.1111/rssa.12378</a>
</div>
<div id="ref-gelmanIterativeNonIterativeSimulation1992" class="csl-entry" role="doc-biblioentry">
Gelman, A. (1992). Iterative and <span>Non</span>-<span>Iterative Simulation Algorithms</span>. <em>Computing <span>Science</span> and <span>Statistics</span> (<span>Interface Proceedings</span>)</em>, <em>24</em>, 457–511. <span>PROCEEDINGS PUBLISHED BY VARIOUS PUBLISHERS</span>.
</div>
<div id="ref-gelmanFolkTheoremStatistical2008" class="csl-entry" role="doc-biblioentry">
Gelman, A. (2008). The folk theorem of statistical computing. Retrieved from <a href="https://statmodeling.stat.columbia.edu/2008/05/13/the_folk_theore/">https://statmodeling.stat.columbia.edu/2008/05/13/the_folk_theore/</a>
</div>
<div id="ref-gelmanBasicsMarkovChain2013" class="csl-entry" role="doc-biblioentry">
Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., &amp; Rubin, D. B. (2013a). Basics of <span>Markov Chain Simulation</span>. In <em>Bayesian <span>Data Analysis</span></em>. <span>Chapman and Hall/CRC</span>.
</div>
<div id="ref-gelman2013bayesian" class="csl-entry" role="doc-biblioentry">
Gelman, A., Carlin, J. B., Stern, H. S., Dunson, D. B., Vehtari, A., &amp; Rubin, D. B. (2013b). <em>Bayesian <span>Data Analysis</span></em>. <span>Chapman and Hall/CRC</span>.
</div>
<div id="ref-gelmanInferenceIterativeSimulation1992" class="csl-entry" role="doc-biblioentry">
Gelman, A., &amp; Rubin, D. B. (1992). Inference from <span>Iterative Simulation Using Multiple Sequences</span>. <em>Statistical Science</em>, <em>7</em>(4), 457–472. <a href="https://doi.org/10.1214/ss/1177011136">https://doi.org/10.1214/ss/1177011136</a>
</div>
<div id="ref-gemanStochasticRelaxationGibbs1984" class="csl-entry" role="doc-biblioentry">
Geman, S., &amp; Geman, D. (1984). Stochastic <span>Relaxation</span>, <span>Gibbs Distributions</span>, and the <span>Bayesian Restoration</span> of <span>Images</span>. <em>IEEE Transactions on Pattern Analysis and Machine Intelligence</em>, <em>PAMI-6</em>(6), 721–741. <a href="https://doi.org/10.1109/TPAMI.1984.4767596">https://doi.org/10.1109/TPAMI.1984.4767596</a>
</div>
<div id="ref-hastingsMonteCarloSampling1970" class="csl-entry" role="doc-biblioentry">
Hastings, W. K. (1970). Monte <span>Carlo</span> sampling methods using <span>Markov</span> chains and their applications. <em>Biometrika</em>, <em>57</em>(1), 97–109. <a href="https://doi.org/10.1093/biomet/57.1.97">https://doi.org/10.1093/biomet/57.1.97</a>
</div>
<div id="ref-hoffman2014no" class="csl-entry" role="doc-biblioentry">
Hoffman, M. D., &amp; Gelman, A. (2011). The <span>No</span>-<span>U</span>-<span>Turn Sampler</span>: <span>Adaptively Setting Path Lengths</span> in <span>Hamiltonian Monte Carlo</span>. <em>Journal of Machine Learning Research</em>, <em>15</em>(1), 1593–1623. Retrieved from <a href="http://arxiv.org/abs/1111.4246">http://arxiv.org/abs/1111.4246</a>
</div>
<div id="ref-metropolisEquationStateCalculations1953" class="csl-entry" role="doc-biblioentry">
Metropolis, N., Rosenbluth, A. W., Rosenbluth, M. N., Teller, A. H., &amp; Teller, E. (1953). Equation of <span>State Calculations</span> by <span>Fast Computing Machines</span>. <em>The Journal of Chemical Physics</em>, <em>21</em>(6), 1087–1092. <a href="https://doi.org/10.1063/1.1699114">https://doi.org/10.1063/1.1699114</a>
</div>
<div id="ref-nealImprovedAcceptanceProcedure1994" class="csl-entry" role="doc-biblioentry">
Neal, Radford M. (1994). An <span>Improved Acceptance Procedure</span> for the <span>Hybrid Monte Carlo Algorithm</span>. <em>Journal of Computational Physics</em>, <em>111</em>(1), 194–203. <a href="https://doi.org/10.1006/jcph.1994.1054">https://doi.org/10.1006/jcph.1994.1054</a>
</div>
<div id="ref-nealSliceSampling2003" class="csl-entry" role="doc-biblioentry">
Neal, Radford M. (2003). Slice <span>Sampling</span>. <em>The Annals of Statistics</em>, <em>31</em>(3), 705–741. Retrieved from <a href="https://www.jstor.org/stable/3448413">https://www.jstor.org/stable/3448413</a>
</div>
<div id="ref-neal2011mcmc" class="csl-entry" role="doc-biblioentry">
Neal, Radford M. (2011). <span>MCMC</span> using <span>Hamiltonian</span> dynamics. In S. Brooks, A. Gelman, G. L. Jones, &amp; X.-L. Meng (Eds.), <em>Handbook of markov chain monte carlo</em>.
</div>
<div id="ref-robertsWeakConvergenceOptimal1997" class="csl-entry" role="doc-biblioentry">
Roberts, G. O., Gelman, A., &amp; Gilks, W. R. (1997). Weak convergence and optimal scaling of random walk <span>Metropolis</span> algorithms. <em>Annals of Applied Probability</em>, <em>7</em>(1), 110–120. <a href="https://doi.org/10.1214/aoap/1034625254">https://doi.org/10.1214/aoap/1034625254</a>
</div>
</div>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>o símbolo <span class="math inline">\(\propto\)</span> (<code>\propto</code>) deve ser lido como “proporcional à.”<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Algumas referências chamam esse processo de <em>burnin.</em><a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>Caso queira uma melhor explanação do algoritmo de Metropolis e Metropolis-Hastings sugiro ver <span class="citation" data-cites="chibUnderstandingMetropolisHastingsAlgorithm1995"><a href="#ref-chibUnderstandingMetropolisHastingsAlgorithm1995" role="doc-biblioref">Chib &amp; Greenberg</a> (<a href="#ref-chibUnderstandingMetropolisHastingsAlgorithm1995" role="doc-biblioref">1995</a>)</span><a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>do ingles <em>probability density function</em> (PDF).<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>objetos <code>stanfit</code> são objetos resultantes de modelos <code>rstan</code> ou <code>rstanarm</code>.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>Caso queira uma melhor explanação do algoritmo de Gibbs sugiro ver <span class="citation" data-cites="casellaExplainingGibbsSampler1992"><a href="#ref-casellaExplainingGibbsSampler1992" role="doc-biblioref">Casella &amp; George</a> (<a href="#ref-casellaExplainingGibbsSampler1992" role="doc-biblioref">1992</a>)</span>.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>isto ficará claro nas imagens e animações.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>Vejam que aqui eu propositalmente dividi a <code>neff</code> por <code>nrow(X_gibbs) / 2</code> (metade do número de iterações). Isso foi necessário, pois da maneira que eu codifiquei o algoritmo Gibbs ele amostra um parâmetro a cada interação e geralmente não se implementa um amostrador Gibbs dessa maneira (amostra-se todos os parâmetros por iteração). Eu fiz de propósito pois quero gerar nos GIFs animados na figura <a href="#fig:gibbs-gif">10</a> a real trajetória do amostrador Gibbs no espaço amostral (vertical e horizontal, e não diagonal).<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote"><p>por questões de transbordamento numérico (<a href="https://en.wikipedia.org/wiki/Integer_overflow"><em>numeric overflow</em></a>) sempre trabalhamos com log de probabilidades.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10" role="doc-endnote"><p>1.000 * 40 = 40.000. Esse 1 a mais é que usei a primeira iteração com Leapfrog <span class="math inline">\(L = 1\)</span> como <em>warmup.</em><a href="#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn11" role="doc-endnote"><p>além disso, todos os pacotes do ecossistema Stan aplicam uma decomposição QR na matriz <span class="math inline">\(X\)</span> de dados, criando uma base ortogonal (não correlacionada) para amostragem. Isso faz com a distribuição-alvo (posterior) fique muito mais amigável do ponto de vista topológico/geométrico para o amostrador MCMC explorá-la de maneira mais eficiente e eficaz.<a href="#fnref11" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn12" role="doc-endnote"><p>Sendo que, por padrão, Stan e <code>rstanarm</code> descartam a primeira metade (1.000) das iterações como aquecimento (<code>warmup = floor(iter/2)</code>).<a href="#fnref12" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn13" role="doc-endnote"><p>além disso, vale a pena ativar a decomposição QR na matriz <span class="math inline">\(X\)</span> de dados, criando uma base ortogonal (não correlacionada) para amostragem. Isso faz com a distribuição-alvo (posterior) fique muito mais amigável do ponto de vista topológico/geométrico para o amostrador MCMC explorá-la de maneira mais eficiente e eficaz. Só você especificar o argumento <code>QR = TRUE</code> dentro da funções do <code>rstanarm</code>, exemplo <code>stan_glm(..., QR = TRUE)</code>. Ou, no <code>brms</code> você adicionar o argumento <code>decomp = "QR"</code> para qualquer fórmula dentro da função <code>brm()</code>.<a href="#fnref13" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="references">References</h3>
<div id="references-listing"></div>
<h3 id="updates-and-corrections">Corrections</h3>
<p>If you see mistakes or want to suggest changes, please <a href="https://github.com/storopoli/Estatistica-Bayesiana/issues/new">create an issue</a> on the source repository.</p>
<h3 id="reuse">Reuse</h3>
<p>Text and figures are licensed under Creative Commons Attribution <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>. Source code is available at <a href="https://github.com/storopoli/Estatistica-Bayesiana">https://github.com/storopoli/Estatistica-Bayesiana</a>, unless otherwise noted. The figures that have been reused from other sources don't fall under this license and can be recognized by a note in their caption: "Figure from ...".</p>
<h3 id="citation">Citation</h3>
<p>For attribution, please cite this work as</p>
<pre class="citation-appendix short">Storopoli (2021, Aug. 1). Estatística Bayesiana com R e Stan: Markov Chain Monte Carlo -- MCMC. Retrieved from https://storopoli.io/Estatistica-Bayesiana/5-MCMC.html</pre>
<p>BibTeX citation</p>
<pre class="citation-appendix long">@misc{storopoli2021mcmcR,
  author = {Storopoli, Jose},
  title = {Estatística Bayesiana com R e Stan: Markov Chain Monte Carlo -- MCMC},
  url = {https://storopoli.io/Estatistica-Bayesiana/5-MCMC.html},
  year = {2021}
}</pre>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<div class="distill-site-nav distill-site-footer">
<p>© Copyright 2021 <a href="https://github.com/storopoli/Estatistica-Bayesiana">Jose Storopoli</a>.</p>
<p>Content licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>.</p>
</div>
<!--/radix_placeholder_navigation_after_body-->


</body>

</html>
